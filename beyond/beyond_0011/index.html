<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Beyond the good ol&#39; LaunchAgents - 11 - Spotlight Importers · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="
This is part 11 in the series of &ldquo;Beyond the good ol&rsquo; LaunchAgents&rdquo;, where I try to collect various persistence techniques for macOS. For more background check the introduction.

  TL;DR
  
    
    Link to heading
  

It works, but very limited due to heavy sandboxing, you can only read and copy files to your sandbox folder or consume some CPU power. If you have a way to escape sandbox then go for it, or could be used as part of a multi-part malware.">
<meta name="keywords" content="">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Beyond the good ol&#39; LaunchAgents - 11 - Spotlight Importers">
  <meta name="twitter:description" content="This is part 11 in the series of “Beyond the good ol’ LaunchAgents”, where I try to collect various persistence techniques for macOS. For more background check the introduction.
TL;DR Link to heading It works, but very limited due to heavy sandboxing, you can only read and copy files to your sandbox folder or consume some CPU power. If you have a way to escape sandbox then go for it, or could be used as part of a multi-part malware.">

<meta property="og:url" content="https://theevilbit.github.io/beyond/beyond_0011/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="Beyond the good ol&#39; LaunchAgents - 11 - Spotlight Importers">
  <meta property="og:description" content="This is part 11 in the series of “Beyond the good ol’ LaunchAgents”, where I try to collect various persistence techniques for macOS. For more background check the introduction.
TL;DR Link to heading It works, but very limited due to heavy sandboxing, you can only read and copy files to your sandbox folder or consume some CPU power. If you have a way to escape sandbox then go for it, or could be used as part of a multi-part malware.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="beyond">
    <meta property="article:published_time" content="2021-04-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-04-03T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Persistence">
    <meta property="article:tag" content="Beyond">




<link rel="canonical" href="https://theevilbit.github.io/beyond/beyond_0011/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.b886fe0d9034709648f91f4ce178f51dd367d9350f82dd1132d54fd69bfca66f.css" integrity="sha256-uIb&#43;DZA0cJZI&#43;R9M4Xj1HdNn2TUPgt0RMtVP1pv8pm8=" crossorigin="anonymous" media="screen" />








 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container page">
  <article>
    <header>
      <h1 class="title">
        <a class="title-link" href="https://theevilbit.github.io/beyond/beyond_0011/">
          Beyond the good ol&#39; LaunchAgents - 11 - Spotlight Importers
        </a>
      </h1>
    </header>

    <blockquote>
<p>This is part 11 in the series of &ldquo;Beyond the good ol&rsquo; LaunchAgents&rdquo;, where I try to collect various persistence techniques for macOS. For more background check the <a href="https://theevilbit.github.io/beyond/beyond_intro/"  class="external-link" target="_blank" rel="noopener">introduction</a>.</p></blockquote>
<h2 id="tldr">
  TL;DR
  <a class="heading-link" href="#tldr">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>It works, but very limited due to heavy sandboxing, you can only read and copy files to your sandbox folder or consume some CPU power. If you have a way to escape sandbox then go for it, or could be used as part of a multi-part malware.</p>
<h2 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I’m reading Jonathan Levin’s *OS Internals Vol I. book (user mode - <a href="http://newosxbook.com/index.php"  class="external-link" target="_blank" rel="noopener">*OS Internals: - Welcome!</a>), and I got to the chapter where he talks about Spotlight importers, and my first thought was that it would be an awesome way to persist on macOS. Typically there is nothing new in InfoSec, so after a quick Google search I found that Patrick Wardle already mentioned this in his BlackHat USA / Immunity talk back in 2015.
Slides: <a href="https://www.blackhat.com/docs/us-15/materials/us-15-Wardle-Writing-Bad-A-Malware-For-OS-X.pdf"  class="external-link" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-15/materials/us-15-Wardle-Writing-Bad-A-Malware-For-OS-X.pdf</a>
Talk: <a href="https://vimeo.com/129435995"  class="external-link" target="_blank" rel="noopener">Patrick Wardle Writing Bad@ss OS X Malware on Vimeo</a> (This is the Immunity one, as he cut this part from the actual BH talk)
But I didn’t find anything beyond this, nothing about how to persist this way. So I decided to experiment with it and see what can or cannot be done.</p>
<h2 id="what-are-spotlight-importers">
  What are Spotlight importers?
  <a class="heading-link" href="#what-are-spotlight-importers">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Spotlight on OSX / macOS is basically an indexing / search service. When you press CMD+SPACE a searcher comes up (that’s Spotlight) and you can type in whatever you look for. Spotlight will search in its index, and that index is being built by Spotlight Importers. These importers are made for various filetypes, typically documents, which will be able to parse the file and extract useful, indexable content from it. There are a bunch of these included in macOS, but you can also write your own, and extend the system’s capabilities. You can check your current list of importers with <code>mdimport -L</code> command. This is how my system looks like:</p>
<pre tabindex="0"><code>csaby@mac scripts % mdimport -L
Paths: id(501) (
    “/Library/Spotlight/iBooksAuthor.mdimporter”,
    “/System/Library/Spotlight/SystemPrefs.mdimporter”,
    “/System/Library/Spotlight/Chat.mdimporter”,
    “/System/Library/Spotlight/iWork.mdimporter”,
    “/System/Library/Spotlight/iPhoto.mdimporter”,
    “/System/Library/Spotlight/PDF.mdimporter”,
    “/System/Library/Spotlight/RichText.mdimporter”,
    “/System/Library/Spotlight/Office.mdimporter”,
    “/System/Library/Spotlight/PS.mdimporter”,
    “/System/Library/Spotlight/MIDI.mdimporter”,
    “/System/Library/Spotlight/Archives.mdimporter”,
    “/System/Library/Spotlight/Audio.mdimporter”,
    “/System/Library/Spotlight/iPhoto8.mdimporter”,
    “/System/Library/Spotlight/Automator.mdimporter”,
    “/System/Library/Spotlight/Application.mdimporter”,
    “/System/Library/Spotlight/Font.mdimporter”,
    “/System/Library/Spotlight/Mail.mdimporter”,
    “/System/Library/Spotlight/QuartzComposer.mdimporter”,
    “/System/Library/Spotlight/vCard.mdimporter”,
    “/System/Library/Spotlight/Image.mdimporter”,
    “/System/Library/Spotlight/iCal.mdimporter”,
    “/System/Library/Spotlight/CoreMedia.mdimporter”,
    “/Applications/Microsoft Outlook.app/Contents/Library/Spotlight/Microsoft Outlook Spotlight Importer.mdimporter”,
    “/Applications/Evernote.app/Contents/Library/Spotlight/EvernoteSpotlightImporter.mdimporter”,
    “/Applications/Xcode.app/Contents/Library/Spotlight/uuid.mdimporter”
)
</code></pre><p>You can create a Spotlight Importer and basically put it into one of these locations:</p>
<ol>
<li>The <code>/Library/Spotlight</code> directory</li>
<li>The <code>~/Library/Spotlight</code> directory</li>
<li>Inside an application bundle. This bundle can be almost anywhere, I tried <code>Desktop</code>, <code>Downloads</code>, <code>/Applications</code> and all worked - most of the time.
The <code>/System/Library/Spotlight</code> contains the built in importers and as it’s protected by SIP you can’t add/modify/delete these.</li>
</ol>
<h2 id="creating-an-mdimporter">
  Creating an .mdimporter
  <a class="heading-link" href="#creating-an-mdimporter">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="basics">
  Basics
  <a class="heading-link" href="#basics">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>I’m not a developer in general and definitely not a macOS developer, although I had a tiny exposure in the past, I’m far from being able to code anything. Apple’s most recent article on the subject is 6 years old: <a href="https://developer.apple.com/library/archive/documentation/Carbon/Conceptual/MDImporters/Concepts/WritingAnImp.html"  class="external-link" target="_blank" rel="noopener">Writing a Spotlight Importer</a> If you Google for how to create Spotlight Importers, all of the articles will say that open Xcode, and create a Spotlight Importer project, there is a template for it. NOPE, it’s gone. It was there up-until Xcode 9, and right now we are at Xcode 11, so you either download the old one, or look for an existing project to modify. I did the second, searched Github, and eventually found several projects, and I chose this: <a href="https://github.com/GenjiApp/EPUB-Plugins"  class="external-link" target="_blank" rel="noopener">GitHub - GenjiApp/EPUB-Plugins: OS X Spotlight / Quick Look plugins for EPUBs</a>
It’s pretty old, but works. First I just compiled it to see if this importer is working at all or not, and it did. It indexed ePub files, with extra attributes, like Author.</p>
<blockquote>
<p>You can use the <code>mdls /path/to/file</code> command to view attributes of the file.</p></blockquote>
<p>What I did after that is cleaning up the project, I removed the other targets (like Quicklook) and also cleaned up the metadata generator function. Here are the mandatory building blocks your importer will have to have, I will try to explain them to the best of my understanding, but please bear in mind that I’m a n00b for Objective-C or macOS development. If you want to follow here is the one I made / modified: <a href="https://github.com/theevilbit/macos/tree/master/PersistentImporter"  class="external-link" target="_blank" rel="noopener">macos/PersistentImporter at master · theevilbit/macos · GitHub</a></p>
<ol>
<li>schema.xml - this will contain the attributes your importer will support. The attributes are the metadata buckets your importer can extract data into, and which will be indexed by Spotlight. For the above project I actually made it mostly intact, but I could likely clean it completely.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#099">&lt;?xml version=“1.0” encoding=“UTF-8”?&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;schema</span> <span style="color:#309">version=</span><span style="color:#c30">“1.0”</span> <span style="color:#309">xmlns=</span><span style="color:#c30">“http://www.apple.com/metadata”</span> <span style="color:#309">xmlns:xsi=</span><span style="color:#c30">“http://www.w3.org/2001/XMLSchema-instance”</span> <span style="color:#309">xsi:schemaLocation=</span><span style="color:#c30">“http://www.apple.com/metadata</span> <span style="color:#a00;background-color:#faa">file:///System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Resources/MetadataSchema.xsd”</span><span style="color:#309;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#099">&lt;!— “attributes” element must exist in schema.xml file even if mdimporter doesn’t support any custom attributes. if it doesn’t exist, the metadata which are listed by “displayattrs” elements aren’t displayed by Finder’s “Get Info” panel (in OS X 10.10.2). —&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&lt;attributes&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&lt;attribute</span> <span style="color:#309">name=</span><span style="color:#c30">“com_csaby_persist_mdimporter”</span> <span style="color:#309">multivalued=</span><span style="color:#c30">“false”</span> <span style="color:#309">type=</span><span style="color:#c30">“CFString”/</span><span style="color:#309;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&lt;/attributes&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&lt;types&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&lt;type</span> <span style="color:#309">name=</span><span style="color:#c30">“org.idpf.epub-container”</span><span style="color:#309;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&lt;allattrs&gt;</span>
</span></span><span style="display:flex;"><span>        kMDItemTitle
</span></span><span style="display:flex;"><span>        kMDItemAuthors
</span></span><span style="display:flex;"><span>        kMDItemKeywords
</span></span><span style="display:flex;"><span>        kMDItemDescription
</span></span><span style="display:flex;"><span>        kMDItemHeadline
</span></span><span style="display:flex;"><span>        kMDItemPublishers
</span></span><span style="display:flex;"><span>        kMDItemOrganizations
</span></span><span style="display:flex;"><span>        kMDItemContributors
</span></span><span style="display:flex;"><span>        kMDItemIdentifier
</span></span><span style="display:flex;"><span>        kMDItemLanguages
</span></span><span style="display:flex;"><span>        kMDItemCoverage
</span></span><span style="display:flex;"><span>        kMDItemCopyright
</span></span><span style="display:flex;"><span>        kMDItemRights
</span></span><span style="display:flex;"><span>        kMDItemTextContent
</span></span><span style="display:flex;"><span>        kMDItemNumberOfPages
</span></span><span style="display:flex;"><span>        kMDItemContentCreationDate
</span></span><span style="display:flex;"><span>        kMDItemContentModificationDate
</span></span><span style="display:flex;"><span>        com_csaby_persist_mdimporter
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&lt;/allattrs&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&lt;displayattrs&gt;</span>
</span></span><span style="display:flex;"><span>        kMDItemTitle
</span></span><span style="display:flex;"><span>        kMDItemAuthors
</span></span><span style="display:flex;"><span>        kMDItemContributors
</span></span><span style="display:flex;"><span>        kMDItemPublishers
</span></span><span style="display:flex;"><span>        kMDItemCopyright
</span></span><span style="display:flex;"><span>        kMDItemLanguages
</span></span><span style="display:flex;"><span>        kMDItemNumberOfPages
</span></span><span style="display:flex;"><span>        kMDItemKeywords
</span></span><span style="display:flex;"><span>        com_csaby_persist_mdimporter
</span></span><span style="display:flex;"><span>        kMDItemIdentifier
</span></span><span style="display:flex;"><span>        kMDItemContentCreationDate
</span></span><span style="display:flex;"><span>        kMDItemContentModificationDate
</span></span><span style="display:flex;"><span>        kMDItemDescription
</span></span><span style="display:flex;"><span>      <span style="color:#309;font-weight:bold">&lt;/displayattrs&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#309;font-weight:bold">&lt;/type&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#309;font-weight:bold">&lt;/types&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/schema&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>main.c file - This is a standard file, typically generated by Xcode, you don’t need to modify it. I will not paste it here, as it’s quite long, but you can get it from my GitHub project (link above).</li>
<li>Info.plist file - Here you must define (along some other standard things) what kind of files your importer will support. It should contain file extensions, and the <a href="https://en.wikipedia.org/wiki/Uniform_Type_Identifier"  class="external-link" target="_blank" rel="noopener">Uniform Type Identifier</a>. Below is the one related to epub from the Info.plist. As mentioned by Patrick you can also specify all files, but I opted to stick with epubs, I didn’t want my importer to run always, as my goal was only experimenting.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;key&gt;</span>UTImportedTypeDeclarations<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;key&gt;</span>UTTypeConformsTo<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;string&gt;</span>public.data<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;string&gt;</span>public.item<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;string&gt;</span>public.composite-content<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;string&gt;</span>public.content<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;key&gt;</span>UTTypeIdentifier<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;string&gt;</span>org.idpf.epub-container<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;key&gt;</span>UTTypeTagSpecification<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;dict&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>public.filename-extension<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#309;font-weight:bold">&lt;string&gt;</span>epub<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;key&gt;</span>public.mime-type<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#309;font-weight:bold">&lt;string&gt;</span>application/epub+zip<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#309;font-weight:bold">&lt;/dict&gt;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span></code></pre></div><ol start="4">
<li>GetMetadataForFile.m file, which will be the brain of your importer, here you actually define how the content is parsed, and how metadata is extracted. For that you need to implement the following function (and eventually return true at the end):</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#078;font-weight:bold">Boolean</span> GetMetadataForFile(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>thisInterface, CFMutableDictionaryRef attributes, CFStringRef contentTypeUTI, CFStringRef pathToFile)
</span></span></code></pre></div><p>I started to experiment what I can do here, and it quickly turned out that this importer is heavily sandboxed. The only thing you can really do is read the actual file that Spotlight wants you to get metadata from, and write to your temp folder. That’s pretty much it, no access to any other random file, no network, can’t start other apps, so pretty much locked down. With that, my importer will copy every epub to a temp folder, I have also a network test included, just to show that it fails.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objectivec" data-lang="objectivec"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;CoreFoundation/CoreFoundation.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#import &lt;Cocoa/Cocoa.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">Boolean</span> <span style="color:#c0f">GetMetadataForFile</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>thisInterface, CFMutableDictionaryRef attributes, CFStringRef contentTypeUTI, CFStringRef pathToFile);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//==============================================================================
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//	Get metadata attributes from document files
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//	The purpose of this function is to extract useful information from the
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//	file formats for your document, and set the values into the attribute
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//  dictionary for Spotlight to include.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//==============================================================================
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">Boolean</span> <span style="color:#c0f">GetMetadataForFile</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>thisInterface, CFMutableDictionaryRef attributes, CFStringRef contentTypeUTI, CFStringRef pathToFile)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    NSLog(@<span style="color:#a00;background-color:#faa">“</span>Hello from peristent mdimporter by <span style="color:#99f">csaby</span> :)<span style="color:#a00;background-color:#faa">”</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    NSString<span style="color:#555">*</span> tempDir <span style="color:#555">=</span> NSTemporaryDirectory();
</span></span><span style="display:flex;"><span>    NSString<span style="color:#555">*</span> tempDirFolder <span style="color:#555">=</span> [tempDir <span style="color:#99f">stringByAppendingPathComponent</span>:@<span style="color:#a00;background-color:#faa">“</span>TestPersist<span style="color:#a00;background-color:#faa">”</span>];
</span></span><span style="display:flex;"><span>    NSString <span style="color:#555">*</span>source <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">__bridge</span> NSString <span style="color:#555">*</span>)pathToFile;
</span></span><span style="display:flex;"><span>    NSString <span style="color:#555">*</span>theFileName <span style="color:#555">=</span> [[source lastPathComponent] stringByDeletingPathExtension];
</span></span><span style="display:flex;"><span>    NSString <span style="color:#555">*</span>destination <span style="color:#555">=</span> [tempDirFolder <span style="color:#99f">stringByAppendingPathComponent</span>:theFileName];
</span></span><span style="display:flex;"><span>    NSError <span style="color:#555">*</span>error;
</span></span><span style="display:flex;"><span>    NSFileManager <span style="color:#555">*</span>fileManager <span style="color:#555">=</span> [NSFileManager defaultManager];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">//create temp folder
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">BOOL</span> fileOK <span style="color:#555">=</span> [[NSFileManager defaultManager] <span style="color:#99f">createDirectoryAtPath</span>:tempDirFolder <span style="color:#99f">withIntermediateDirectories</span>:<span style="color:#366">NO</span> <span style="color:#99f">attributes</span>:<span style="color:#366">nil</span> <span style="color:#99f">error</span>:<span style="color:#555">&amp;</span>error ];
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> ( <span style="color:#555">!</span>fileOK )
</span></span><span style="display:flex;"><span>        NSLog(@<span style="color:#a00;background-color:#faa">“</span>createDirectoryAtPath <span style="color:#555">%</span>@<span style="color:#a00;background-color:#faa">“</span>, [error localizedDescription]);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">//copy file
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">if</span> ([fileManager <span style="color:#99f">copyItemAtPath</span>:source <span style="color:#99f">toPath</span>:destination <span style="color:#99f">error</span>:<span style="color:#555">&amp;</span>error]){
</span></span><span style="display:flex;"><span>        NSLog(@<span style="color:#a00;background-color:#faa">“</span>Copy Success <span style="color:#99f">from</span>: <span style="color:#555">%</span>@, to <span style="color:#555">%</span>@<span style="color:#a00;background-color:#faa">“</span>, source, destination);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>        NSLog(<span style="color:#c30">@&#34;Copy error: %@&#34;</span>, error);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">//network test
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    NSString <span style="color:#555">*</span>URLString <span style="color:#555">=</span> [NSString <span style="color:#99f">stringWithContentsOfURL</span>:[NSURL <span style="color:#99f">URLWithString</span>:<span style="color:#c30">@&#34;https://www.google.com&#34;</span>]];
</span></span><span style="display:flex;"><span>    NSLog(<span style="color:#c30">@&#34;URL: %@&#34;</span>, URLString);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As it turned out during my research, since OSX 10.8 you can’t use the standard <code>/tmp/</code> folder, as you have no access to that, you need to query your sandboxed <code>tmp</code> directory, you can do that with <code>NSTemporaryDirectory()</code>. More on that:</p>
<p><a href="https://web.archive.org/web/20170615173848/http://www.cocoabuilder.com/archive/cocoa/328611-creating-temp-files-or-temp-folders-in-standard-temp-file-locations-in-mdimporter-on-mac-os-10-8-3.html"  class="external-link" target="_blank" rel="noopener">creating temp files or temp folders in standard temp file locations in mdimporter on Mac OS X 10.8.3 | Cocoabuilder</a></p>
<p><a href="https://stackoverflow.com/questions/50939980/creating-temp-files-in-spotlight-module-mdimporter"  class="external-link" target="_blank" rel="noopener">objective c - Creating temp files in Spotlight Module / MDimporter - Stack Overflow</a></p>
<h3 id="installation">
  Installation
  <a class="heading-link" href="#installation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Once you build it, you get an <code>.mdimporter</code> plugin. You should place it into one of the <code>Spotlight</code> directories, and eventually after a few minutes it will be discovered by the system and it will show up in the list of your importers. You can also force an import with <code>mdimport -r /path/to/your/mdimporter</code> but it still have to live in the right place otherwise it won’t be used / imported. Once that’s done, you can force an indexing with running <code>mdimport /path/to/epub</code>. If you check the device log, you will see something like this:</p>
<p><img src="https://theevilbit.github.io/images/beyond/beyond_0011_0.png" alt=""></p>
<p>The <code>URL:(null)</code> indicates the failed network connection. You can also see that the copy of the file was successful.</p>
<p>There is really nothing much more your importer can do, I tried it also on Yosemite, but essentially the same results. Actually even worse, as likely I need to do the file copy differently.</p>
<p>Side track: if you need to install older macOS VMs on Fusion, here you can find the links to the installer packages from 10.10 (Yosemite) to 10.15 (Catalina): <a href="https://tidbits.com/2019/10/28/redownload-archived-macos-installers-to-address-expired-certificates/"  class="external-link" target="_blank" rel="noopener">Redownload Archived macOS Installers to Address Expired Certificates - TidBITS</a> Once you download the installer, run it, and it will extract the actual OS installer to <code>/Applications</code>, which can be used by VMware Fusion. As an addition to Yosemite: Use USB 2.0 as the last security update will mess up VMware, and neither the keyboard nor the mouse will work. More on the bug: <a href="https://communities.vmware.com/thread/568561"  class="external-link" target="_blank" rel="noopener">Solved: OS X 10.10.5 Yosemite VM freezes after … |VMware Communities</a></p>
<h3 id="adding-an-app-bundle">
  Adding an App bundle
  <a class="heading-link" href="#adding-an-app-bundle">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>As we saw earlier another way to install an importer is part of an <code>.app</code> bundle. This was super tricky, and it required heavy Google-Fu from my side to figure out :) The above GitHub project already has it, but here is a short writeup how to do it on your own.</p>
<ol>
<li>
<p>Add a new target to your Xcode project, and select a Cocoa app for it. Be sure to tick <code>Create Document-Based Application</code>. Ideally the extension should be the same what your importer supports - <em>I THINK</em> - but to be on the safe side do the same. The language is not important as we won’t do anything.
<img src="https://theevilbit.github.io/images/beyond/beyond_0011_1.png" alt=""></p>
</li>
<li>
<p>On your new target go to <code>Build Phases</code>, and then select <code>Editor -&gt; Add Build Phase -&gt; Add Copy Files Build Phase</code>, and set it like this:
Destination: <code>Wrapper</code>
Subpath: <code>Contents/Library/Spotlight</code>
Add your importer below.
<img src="https://theevilbit.github.io/images/beyond/beyond_0011_2.png" alt=""></p>
</li>
<li>
<p>Go back to General tab, and if not already there, also add your importer.
<img src="https://theevilbit.github.io/images/beyond/beyond_0011_3.png" alt=""></p>
</li>
<li>
<p>First build your mdimporter and then the App. The app should have the importer embedded.</p>
</li>
</ol>
<p>If you copy that app now somewhere, most likely it will be consumed and the mdimporter will be added to the list of your available Spotlight Importers.</p>
<h4 id="download---unzip---rce---nope">
  Download - unzip - RCE? - NOPE
  <a class="heading-link" href="#download---unzip---rce---nope">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Since the app bundle seems to be auto-parsed just like in the case of URL handlers, and the Spotlight importer is auto registered, I thought that someone could gain RCE with a drive by download, as Safari will auto-extract the ZIP file, which could contain an application that could contain an importer. Luckily it seems that macOS won’t import a Spotlight importer in this case. Hallelujah! :)</p>
<h3 id="gatekeeper-on-catalina">
  Gatekeeper on Catalina
  <a class="heading-link" href="#gatekeeper-on-catalina">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>I also tried what happens if I download an mdimporter and manually place it into the Spotlight folder. It will be imported in that case, however due to the quarantine flag (download!!), GateKeeper will actually generate a popup, which is really nice. It seems that Apple significantly improved it indeed.</p>
<h2 id="closing-thoughts">
  Closing thoughts
  <a class="heading-link" href="#closing-thoughts">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>I think plugins, like this is a bit unexplored space for persisting on macOS systems, there might be more similar ones. For example you could also use a Spotlight Quicklook plugin which is invoked, whenever someone hits the spacebar on a file in <code>Finder.app</code> for a quick preview of the file. Likely it would have the same level of access, and it’s much more limited cause you need the user to preview something, but it could still work.</p>

  </article>
</section>

  

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
