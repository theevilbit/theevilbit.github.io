<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Launch and Environment Constraints Deep Dive · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="
UPDATE 2023.10.10.: After chatting with Thijs Alkemade, @xnyhps, updated the XPC part of the post as I originally misunderstood Apple&rsquo;s intent.
Apple introduced Launch Constraints in macOS Ventura (13) as a response to some common attack scenarios. LC was probably the most impactful mitigation against various type of vulnerabilities. Before we dwell into LC let&rsquo;s review a couple of old vulnerabilities, which would have been not exploitable if LC was present.">
<meta name="keywords" content="blog,macos,apple,security,vulnerability,exploit,cve">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Launch and Environment Constraints Deep Dive">
  <meta name="twitter:description" content="UPDATE 2023.10.10.: After chatting with Thijs Alkemade, @xnyhps, updated the XPC part of the post as I originally misunderstood Apple’s intent.
Apple introduced Launch Constraints in macOS Ventura (13) as a response to some common attack scenarios. LC was probably the most impactful mitigation against various type of vulnerabilities. Before we dwell into LC let’s review a couple of old vulnerabilities, which would have been not exploitable if LC was present.">

<meta property="og:url" content="https://theevilbit.github.io/posts/launch_constraints_deep_dive/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="Launch and Environment Constraints Deep Dive">
  <meta property="og:description" content="UPDATE 2023.10.10.: After chatting with Thijs Alkemade, @xnyhps, updated the XPC part of the post as I originally misunderstood Apple’s intent.
Apple introduced Launch Constraints in macOS Ventura (13) as a response to some common attack scenarios. LC was probably the most impactful mitigation against various type of vulnerabilities. Before we dwell into LC let’s review a couple of old vulnerabilities, which would have been not exploitable if LC was present.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-09T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-10-09T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Internals">
    <meta property="article:tag" content="Amfi">




<link rel="canonical" href="https://theevilbit.github.io/posts/launch_constraints_deep_dive/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.cf9ddd8f927a64ebeaf4fc847b0d4ad73601b6a45ef3c8fc24771e71437ab230.css" integrity="sha256-z53dj5J6ZOvq9PyEew1K1zYBtqRe88j8JHcecUN6sjA=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="https://theevilbit.github.io/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/launch_constraints_deep_dive/">
              Launch and Environment Constraints Deep Dive
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-10-09T00:00:00Z">
                October 9, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              16-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/macos/">Macos</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/internals/">Internals</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/amfi/">Amfi</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <blockquote>
<p>UPDATE 2023.10.10.: After chatting with Thijs Alkemade, <a href="https://mastodon.social/@xnyhps@infosec.exchange"  class="external-link" target="_blank" rel="noopener">@xnyhps</a>, updated the XPC part of the post as I originally misunderstood Apple&rsquo;s intent.</p></blockquote>
<p>Apple introduced Launch Constraints in macOS Ventura (13) as a response to some common attack scenarios. LC was probably the most impactful mitigation against various type of vulnerabilities. Before we dwell into LC let&rsquo;s review a couple of old vulnerabilities, which would have been not exploitable if LC was present.</p>
<h2 id="old-macos-vulnerabilities">
  Old macOS Vulnerabilities
  <a class="heading-link" href="#old-macos-vulnerabilities">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="tcc-bypass-with-imagentapp">
  TCC Bypass with imagent.app
  <a class="heading-link" href="#tcc-bypass-with-imagentapp">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This vulnerability was discovered by Adam Chester (<a href="https://twitter.com/_xpn_"  class="external-link" target="_blank" rel="noopener"><em>xpn</em></a>) back in 2019 and documented on his blog post <a href="https://blog.xpnsec.com/bypassing-macos-privacy-controls/"  class="external-link" target="_blank" rel="noopener">&ldquo;Bypassing MacOS Privacy Controls&rdquo;</a>. The idea is that the <code>imagent.app</code>, located at <code>/System/Library/PrivateFrameworks/IMCore.framework/imagent.app</code> had some very interesting entitlements, which allowed it to access the contacts and some entries in the keychain. This is shown below.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;key&gt;</span>com.apple.private.tcc.allow.overridable<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>kTCCServiceAddressBook<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;key&gt;</span>keychain-access-groups<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>ichat<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>apple<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>appleaccount<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>InternetAccounts<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#309;font-weight:bold">&lt;string&gt;</span>IMCore<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span></code></pre></div><p>Adam found that this application will try to load plugins from <code>imagent.app/Contents/PlugIns</code>, and its code signing properties allowed to load any third party, non Apple signed plugins. The only issue was that the application resided in a SIP protected directory. However nothing prevented us from making a copy of it, for example into <code>/tmp/</code>, create a plugin, and launch it from there.</p>
<p>This way we could load an arbitrary plugin into this powerful application and inherit its entitlements and so bypass TCC and keychain.</p>
<h3 id="tcc-bypass-using-directory-utilityapp-cve-2020-27937">
  TCC Bypass Using Directory Utility.app, CVE-2020-27937
  <a class="heading-link" href="#tcc-bypass-using-directory-utilityapp-cve-2020-27937">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This vulnerability was discovered by Wojciech Reguła (<a href="https://twitter.com/_r3ggi"  class="external-link" target="_blank" rel="noopener">_r3ggi</a>) back in 2020, and it&rsquo;s similar to the previous one. It was also documented in Wojciech&rsquo;s blog post, <a href="https://wojciechregula.blog/post/change-home-directory-and-bypass-tcc-aka-cve-2020-27937/"  class="external-link" target="_blank" rel="noopener">&ldquo;Change home directory and bypass TCC aka CVE-2020-27937&rdquo;</a>. Directory Utility had some very powerful entitlement, which granted it rights to change the user&rsquo;s properties, like HOME folder.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span> <span style="color:#309;font-weight:bold">&lt;key&gt;</span>com.apple.private.tcc.allow<span style="color:#309;font-weight:bold">&lt;/key&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#309;font-weight:bold">&lt;array&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#309;font-weight:bold">&lt;string&gt;</span>kTCCServiceSystemPolicySysAdminFiles<span style="color:#309;font-weight:bold">&lt;/string&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#309;font-weight:bold">&lt;/array&gt;</span>
</span></span></code></pre></div><p>Similarly to imagent, the application&rsquo;s code signing properties were not restrictive enough, and allowed us injecting code into the application by creating plugins. So we could make a copy again, and inject code into the app. This again allowed us inheriting the utility&rsquo;s entitlements. By changing the HOME directory, we can plant a new TCC database with our custom rules.</p>
<h3 id="tcc-bypass-using-configd-powerdir">
  TCC Bypass Using configd, &ldquo;powerdir&rdquo;
  <a class="heading-link" href="#tcc-bypass-using-configd-powerdir">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This vulnerability was discovered by Jonathan Bar Or (<a href="https://twitter.com/yo_yo_yo_jbo"  class="external-link" target="_blank" rel="noopener">yo_yo_yo_jbo</a>) back in 2021, and was documented on Microsoft&rsquo;s security blog under the title, <a href="https://www.microsoft.com/en-us/security/blog/2022/01/10/new-macos-vulnerability-powerdir-could-lead-to-unauthorized-user-data-access/"  class="external-link" target="_blank" rel="noopener">New macOS vulnerability, “powerdir,” could lead to unauthorized user data access</a>. Here the exploitable utility was <code>configd</code>, which is located at <code>/usr/libexec/configd</code>. Among many powerful entitlements it also had one TCC related, namely the following.</p>
<pre tabindex="0"><code>[Key] com.apple.private.tcc.allow
[Value]
	[Array]
		[String] kTCCServiceSystemPolicySysAdminFiles
</code></pre><p>This allows the tool to change the HOME directory of a user, which ultimately leads to a full TCC bypass as we can plan an arbitrary database. The tool&rsquo;s code signing properties again allowed injecting a custom bundle. However in this case instead of making a plugin, we could specify the bundle to be loaded by a command line switch. Although this tool is normally launched by <code>launchd</code> upon startup, there was nothing preventing us launching it again through the command line.</p>
<h2 id="introducing-launch-constraints">
  Introducing Launch Constraints
  <a class="heading-link" href="#introducing-launch-constraints">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The above three vulnerabilities, is just a small subset of similar issues that have been found over the years. As we can see there are some common attack patterns, like executing binaries the way they were not expected to be launched or executing them from alternative places. Apple introduced Launch Constraints in macOS Ventura to mitigate these type of exploitation scenarios. It can control, who, how and from where a process can be launched.</p>
<p>Each system binary is assigned to a constraint category, which are defined inside the trust cache. Trust cache is a list of all system binaries, their hashes, and now with version 2, their launch constraint category. The various Launch Constraints categories are defined inside AMFI (AppleMobileFileIntegrity).</p>
<p>Categories are consists of three different parts:</p>
<p>&ldquo;Self Constraints&rdquo;, &ldquo;Parent Constraints&rdquo; and &ldquo;Responsible Constraints&rdquo;. They mean the following.
Self Constraints - These are constraints the application itself must meet.
Parent Constraints - These are constraints related to the parent process of the application.
Responsible Constraints - These are constraints related to the process which is responsible for launching the application.</p>
<p>For example when we invoke an XPC service, the application will be the service, the parent will be <code>launchd</code> and the responsible process will be the one, which invoked the service at first place.</p>
<p>Let&rsquo;s see it in action. We make a copy of the <code>FindMy.app</code> and try to launch it. It will crash.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@max /tmp % cp -r /System/Applications/FindMy.app .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csaby@max /tmp % open FindMy.app 
</span></span><span style="display:flex;"><span>The application cannot be opened <span style="color:#069;font-weight:bold">for</span> an unexpected reason, <span style="color:#033">error</span><span style="color:#555">=</span>Error <span style="color:#033">Domain</span><span style="color:#555">=</span>RBSRequestErrorDomain <span style="color:#033">Code</span><span style="color:#555">=</span><span style="color:#f60">5</span> <span style="color:#c30">&#34;Launch failed.&#34;</span> <span style="color:#033">UserInfo</span><span style="color:#555">={</span><span style="color:#033">NSLocalizedFailureReason</span><span style="color:#555">=</span>Launch failed., <span style="color:#033">NSUnderlyingError</span><span style="color:#555">=</span>0x6000000032d0 <span style="color:#555">{</span>Error <span style="color:#033">Domain</span><span style="color:#555">=</span>NSPOSIXErrorDomain <span style="color:#033">Code</span><span style="color:#555">=</span><span style="color:#f60">162</span> <span style="color:#c30">&#34;Unknown error: 162&#34;</span> <span style="color:#033">UserInfo</span><span style="color:#555">={</span><span style="color:#033">NSLocalizedDescription</span><span style="color:#555">=</span>Launchd job spawn failed<span style="color:#555">}}}</span>
</span></span></code></pre></div><p>The error message is not very descriptive, but if we monitor AMFI logs, we will find the following.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>csaby@max /tmp % log stream | grep AMFI
</span></span><span style="display:flex;"><span>2023-09-19 14:18:21.273482+0200 0x2e3486   Default     0x0                  <span style="color:#f60">0</span>      <span style="color:#f60">0</span>    kernel: <span style="color:#555">(</span>AppleMobileFileIntegrity<span style="color:#555">)</span> AMFI: Launch Constraint Violation <span style="color:#555">(</span>enforcing<span style="color:#555">)</span>, error info: c<span style="color:#555">[</span>1<span style="color:#555">]</span>p<span style="color:#555">[</span>1<span style="color:#555">]</span>m<span style="color:#555">[</span>1<span style="color:#555">]</span>e<span style="color:#555">[</span>2<span style="color:#555">]</span>, <span style="color:#555">(</span>Constraint not matched<span style="color:#555">)</span> launching proc<span style="color:#555">[</span>vc: <span style="color:#f60">1</span> pid: 52468<span style="color:#555">]</span>: /private/tmp/FindMy.app/Contents/MacOS/FindMy, launch <span style="color:#366">type</span> 0, failure proc <span style="color:#555">[</span>vc: <span style="color:#f60">1</span> pid: 52468<span style="color:#555">]</span>: /private/tmp/FindMy.app/Contents/MacOS/FindMy
</span></span></code></pre></div><p>We see that we violated Launch Constraints.</p>
<h3 id="launch-constraints-categories">
  Launch Constraints Categories
  <a class="heading-link" href="#launch-constraints-categories">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>As noted before categories are defined inside AMFI. It was first reversed by Linus Henze, and the initial categories can be found on his Github Gist, <a href="https://gist.github.com/LinusHenze/4cd5d7ef057a144cda7234e2c247c056"  class="external-link" target="_blank" rel="noopener">Description of the Launch Constraints introduced in iOS 16</a>. Let&rsquo;s analyze two of them.</p>
<pre tabindex="0"><code>Category 1:

     Self Constraint: (on-authorized-authapfs-volume || on-system-volume) &amp;&amp; launch-type == 1 &amp;&amp; validation-category == 1

     Parent Constraint: is-init-proc
</code></pre><p>Self constraint refers to the application itself. <em>on-authorized-authapfs-volume || on-system-volume</em> is descriptive: the application must reside either on the System volume or an authorized APFS volume, which likely refers to the cryptex volumes, which are used for RSR (Rapid Security Response) updates. Launch types are documented on Apple&rsquo;s developer documentation, <a href="https://developer.apple.com/documentation/kernel/cs_launch_type_t?changes=latest_major&amp;language=objc"  class="external-link" target="_blank" rel="noopener">cs_launch_type_t</a>. Currently (as of macOS 14) there are four different types. 1 refers to a system service, thus this is a binary that should be launched as a service. Validation category 1 means it must present in the trust cache.</p>
<p>The parent constraint refers to the parent, and <code>is-init-proc</code> refers to launchd.</p>
<p>In summary, this is a binary that should reside on the System volume or an authorized APFS volume, and be launched as a system service by launchd.</p>
<p>Let&rsquo;s examine Category 2.</p>
<pre tabindex="0"><code>Category 2:

     Self Constraint: on-authorized-authapfs-volume || on-system-volume
</code></pre><p>This is less restrictive, it only says that the binary should be on the system volume or an authorized APFS volume.</p>
<p>Let&rsquo;s find a few binaries that are assigned to these categories.</p>
<h3 id="the-trust-cache">
  The Trust Cache
  <a class="heading-link" href="#the-trust-cache">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The launch policy can be found in multiple places:</p>
<pre tabindex="0"><code>/System/Library/Security/OSLaunchPolicyData
/System/Volumes/Preboot/[uuid]/boot/[long hex]/usr/standalone/firmware/FUD/BaseSystemTrustCache.img4
/System/Volumes/Preboot/[uuid]/boot/[long hex]/usr/standalone/firmware/FUD/StaticTrustCache.img4
</code></pre><p><code>OSLaunchPolicyData</code> is an IM4P (Image4 Payload) data file, we need to extract the actual content from it. We can use the <a href="https://github.com/m1stadev/PyIMG4"  class="external-link" target="_blank" rel="noopener">PyIMG4</a> Python library for that.</p>
<pre tabindex="0"><code>csaby@max /tmp % pyimg4 im4p info -i /System/Library/Security/OSLaunchPolicyData 
Reading /System/Library/Security/OSLaunchPolicyData...
Image4 payload info:
  FourCC: ltrs
  Description: 1
  Data size: 329.14KB
  Encrypted: False

csaby@max /tmp % pyimg4 im4p extract -i /System/Library/Security/OSLaunchPolicyData -o OSLaunchPolicyData.data
Reading /System/Library/Security/OSLaunchPolicyData...
Extracted Image4 payload data to: OSLaunchPolicyData.data
</code></pre><p>We can also use the other trust caches, but they are IMG4 files, so first we need to extract the IM4 Payload, for which we can also use <code>pyimg4</code>:</p>
<pre tabindex="0"><code>pyimg4 img4 extract -i BaseSystemTrustCache.img4 -p BaseSystemTrustCache.im4p
pyimg4 img4 extract -i StaticTrustCache.img4 -p StaticTrustCache.im4p
</code></pre><p>Once we have the data extracted we can use the <a href="https://github.com/CRKatri/trustcache"  class="external-link" target="_blank" rel="noopener">trustcache</a> utility to work with the data.</p>
<pre tabindex="0"><code>csaby@max /tmp % trustcache_macos_arm64 info OSLaunchPolicyData.data | head   
version = 2
uuid = CCC03EBE-7949-460E-A335-14C6396FC927
entry count = 13713
000600f05b768de957b57afbd576ad031b7dc984 [none] [2] [2]
0008df4d1e0d4b276a82f3e086bea3e93670cf94 [none] [2] [2]
000c95ce2e4f99248a33e5c7f690452f89afc16b [none] [2] [0]
0019e93d101896746f77a3b7047d2d8281352fc5 [none] [2] [3]
0020f949545b505610f55f962520bfb4f1851f1d [none] [2] [2]
002655b46255b6fb2f5b2a4987345cc0e46836f8 [none] [2] [2]
002aa16545d098699c706c27a08e834243f5b984 [none] [2] [2]
</code></pre><p>The trust cache follows the following structure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">struct</span> trust_cache_entry2 {
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> cdhash[CS_CDHASH_LEN];
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> hash_type;
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> flags;
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> constraintCategory;
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint8_t</span> reserved0;
</span></span><span style="display:flex;"><span>} <span style="color:#c0f">__attribute__</span>((__packed__));
</span></span></code></pre></div><p>Thus the 4th column defines the constraint category.</p>
<p>I have a script, which looks through the file system, and looks up each binary against the trust caches, and the categories. For Category 1 we said that it&rsquo;s a system service, and expected to be launched by launchd only. If we look up files that are indeed in this category we indeed find daemons, like:</p>
<pre tabindex="0"><code>/usr/libexec/routined
/usr/libexec/nehelper
/usr/libexec/remoted
/usr/libexec/seld
/usr/libexec/logd
/usr/libexec/thermalmonitord
...
</code></pre><p>For Category 2 we find binaries, that are various system utilities, like:</p>
<pre tabindex="0"><code>/usr/bin/brctl
/usr/bin/bputil
/usr/bin/bison
/usr/bin/bioutil
/usr/bin/binhex
/usr/bin/bc
/usr/bin/batch
...
</code></pre><p>Based on the analysis we have done, this is all expected.</p>
<h3 id="reversing-constraints">
  Reversing Constraints
  <a class="heading-link" href="#reversing-constraints">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>While on macOS 13 we had 7 constraint categories on macOS Sonoma we have 18. As there was no public information on that I decided to reverse it, and currently it&rsquo;s documented on my GitHub Gist, <a href="https://gist.github.com/theevilbit/a6fef1e0397425a334d064f7b6e1be53"  class="external-link" target="_blank" rel="noopener">macOS Sonoma (14) Launch Constraints</a>. But how can we find and reverse the categories.</p>
<p>First, we need to access the <code>AppleMobileFileIntegrity</code> (AMFI) kernel extension, where this information sits. The easiest way is to download Apple&rsquo;s Kernel Development Kit (KDK), where we will have the binary of the <code>AppleMobileFileIntegrity</code> kernel extension. It defines many symbols starting with the prefix <code>kConstraintCategory</code>. They are sequentially followed by each other and based on the names we can find the category number and if it&rsquo;s Self or Parent type. Here is a list of the symbols from Sonoma Beta 1 (although they didn&rsquo;t appear to change in number).</p>
<pre tabindex="0"><code>kConstraintCategory1_Self
kConstraintCategory2_Self
kConstraintCategory3_Self
kConstraintCategory4_Self
kConstraintCategory5_Self
kConstraintCategory6_Self
kConstraintCategory7_Self
kConstraintCategory8_Self
kConstraintCategory9_Self
kConstraintCategory10_Self
kConstraintCategory12_Self
kConstraintCategory13_Self
kConstraintCategory14_Self
kConstraintCategory15_Self
kConstraintCategory16_Self
kConstraintCategory17_Self
kConstraintCategory18_Self
kConstraintCategory20_Self
kConstraintCategory1_Parent
kConstraintCategory4_Parent
kConstraintCategory5_Parent
kConstraintCategory6_Parent
kConstraintCategory8_Parent
kConstraintCategory14_Parent
kConstraintCategory15_Parent
kConstraintCategory16_Parent
kConstraintCategory18_Parent
</code></pre><p>We can dump all of them, and eventually we get a big blob of stream.</p>
<pre tabindex="0"><code>7075020101B07030420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30100C0B6C61756E63682D7479706502010130180C1376616C69646174696F6E2D63617465676F72790201017049020101B04430420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF708183020101B07E30420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010002010130180C1376616C69646174696F6E2D63617465676F7279020101708183020101B07E30420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010002010130180C1376616C69646174696F6E2D63617465676F7279020101701F020101B01A30180C1376616C69646174696F6E2D63617465676F72790201017081B2020101B081AC307E0C03246F72B07730230C1E696E2D74632D776974682D636F6E73747261696E742D63617465676F727901010030150C1069732D7369702D70726F7465637465640101FF30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30100C0B6C61756E63682D7479706502010130180C1376616C69646174696F6E2D63617465676F7279020101701F020101B01A30180C1376616C69646174696F6E2D63617465676F72790201017075020101B07030420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30100C0B6C61756E63682D7479706502010230180C1376616C69646174696F6E2D63617465676F7279020101708199020101B0819330420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30130C0E6170706C652D696E7465726E616C0101FF301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010002010230180C1376616C69646174696F6E2D63617465676F7279020101708183020101B07E30420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010002010230180C1376616C69646174696F6E2D63617465676F7279020101708187020101B0818130420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30210C0B6C61756E63682D74797065B01230100C0324696E300902010002010102010230180C1376616C69646174696F6E2D63617465676F7279020101703F020101B03A301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010002010230180C1376616C69646174696F6E2D63617465676F72790201017075020101B07030420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30100C0B6C61756E63682D7479706502010330180C1376616C69646174696F6E2D63617465676F7279020101708183020101B07E30420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF301E0C0B6C61756E63682D74797065B00F300D0C0324696E300602010102010330180C1376616C69646174696F6E2D63617465676F72790201017031020101B02C30100C0B6C61756E63682D7479706502010330180C1376616C69646174696F6E2D63617465676F72790201017081B7020101B081B130819C0C03246F72B08194307D0C0424616E64B07530590C03246F72B05230150C1069732D7369702D70726F7465637465640101FF30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30180C1376616C69646174696F6E2D63617465676F727902010130130C0E6170706C652D696E7465726E616C0101FF30100C0B6C61756E63682D747970650201027078020101B07330420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30130C0E646576656C6F7065722D6D6F64650101FF30180C1376616C69646174696F6E2D63617465676F7279020101708187020101B0818130420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30210C0B6C61756E63682D74797065B01230100C0324696E300902010002010102010330180C1376616C69646174696F6E2D63617465676F72790201017018020101B01330110C0C69732D696E69742D70726F630101FF70818A020101B081843081810C03246F72B07A30650C0424616E64B05D30150C106F6E2D73797374656D2D766F6C756D650101FF302A0C127369676E696E672D6964656E7469666965720C14636F6D2E6170706C652E6D62666C6F6167656E7430180C1376616C69646174696F6E2D63617465676F727902010130110C0C69732D696E69742D70726F630101FF70818A020101B081843081810C03246F72B07A30650C0424616E64B05D30150C106F6E2D73797374656D2D766F6C756D650101FF302A0C127369676E696E672D6964656E7469666965720C14636F6D2E6170706C652E6D62666C6F6167656E7430180C1376616C69646174696F6E2D63617465676F727902010130110C0C69732D696E69742D70726F630101FF70819A020101B081943081910C03246F72B0818930740C0424616E64B06C30130C0E6170706C652D696E7465726E616C0101FF30550C0C656E7469746C656D656E7473B04530430C062471756572793039302F0201010C2A636F6D2E6170706C652E707269766174652E7365742D6C61756E63682D747970652E696E7465726E616C300602010A02010130110C0C69732D696E69742D70726F630101FF7081B4020101B081AE30420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF304E0C127369676E696E672D6964656E746966696572B03830360C0324696E302F0C15636F6D2E6170706C652E737973646961676E6F73650C16636F6D2E6170706C652E737973646961676E6F73656430180C1376616C69646174696F6E2D63617465676F72790201017018020101B01330110C0C69732D696E69742D70726F630101FF7018020101B01330110C0C69732D696E69742D70726F630101FF7018020101B01330110C0C69732D696E69742D70726F630101FF7081A0020101B0819A3081970C03246F72B0818F30780C0424616E64B07030540C03246F72B04D30110C0C69732D696E69742D70726F630101FF30380C127369676E696E672D6964656E7469666965720C22636F6D2E6170706C652E436F72654465766963652E6474646562756770726F78796430180C1376616C69646174696F6E2D63617465676F727902010130130C0E6170706C652D696E7465726E616C0101FF
</code></pre><p>This data is DER (ASN.1) encoded stream. There are plenty of tools that can decode DER encoded HEX stream into ASN.1 text representation. For example online: <a href="https://holtstrom.com/michael/tools/asn1decoder.php"  class="external-link" target="_blank" rel="noopener">ASN.1 Decoder</a> or the python-asn1 library and its <code>dump.py</code> script, <a href="https://github.com/andrivet/python-asn1/tree/master"  class="external-link" target="_blank" rel="noopener">andrivet/python-asn1</a>.</p>
<p>For example the following stream:</p>
<pre tabindex="0"><code>7075020101B07030420C03246F72B03B30220C1D6F6E2D617574686F72697A65642D61757468617066732D766F6C756D650101FF30150C106F6E2D73797374656D2D766F6C756D650101FF30100C0B6C61756E63682D7479706502010130180C1376616C69646174696F6E2D63617465676F7279020101
</code></pre><p>Translates to:</p>
<pre tabindex="0"><code>[A] SEQUENCE
  [U] INTEGER: 1
  [C] SEQUENCE
    [U] SEQUENCE
      [U] UTF8STRING: $or
      [C] SEQUENCE
        [U] SEQUENCE
          [U] UTF8STRING: on-authorized-authapfs-volume
          [U] BOOLEAN: True
        [U] SEQUENCE
          [U] UTF8STRING: on-system-volume
          [U] BOOLEAN: True
    [U] SEQUENCE
      [U] UTF8STRING: launch-type
      [U] INTEGER: 1
    [U] SEQUENCE
      [U] UTF8STRING: validation-category
      [U] INTEGER: 1
</code></pre><p>And this can be reconstructed into:</p>
<pre tabindex="0"><code>Self Constraint: (on-authorized-authapfs-volume || on-system-volume) &amp;&amp; launch-type == 1 &amp;&amp; validation-category == 1
</code></pre><h3 id="attack-mitigation">
  Attack Mitigation
  <a class="heading-link" href="#attack-mitigation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Now that we understand Launch Constraints let&rsquo;s explore why they mitigate the exploits discussed before.</p>
<p>Both the TCC bypass with <code>imagent.app</code> and TCC bypass using <code>Directory Utility.app</code> (CVE-2020-27937) are mitigated by having the <code>(on-authorized-authapfs-volume || on-system-volume)</code> requirement in the executable&rsquo;s self constraint, which means that if we make a copy of these apps, we won&rsquo;t be able to execute them. This essentially prevents us to load any plugin into these apps.</p>
<p>&ldquo;TCC bypass using configd&rdquo; is mitigated by having the <code>Parent Constraint: is-init-proc</code> in <code>configd</code>&rsquo;s requirement. This means that we won&rsquo;t be able to run it from the command line, and load an arbitrary bundle.</p>
<p>Although these vulnerabilities have been fixed, Launch Constraints would have made them unexplainable at the first place.</p>
<blockquote>
<p>Although unrelated but the trust cache helps to mitigate common downgrade attacks, when someone used an old and vulnerable binary from an old macOS version on a newer one. As the old one was still properly signed and entitled, it could be used to execute attacks again.</p></blockquote>
<h2 id="old-third-party-vulnerabilities">
  Old Third Party Vulnerabilities
  <a class="heading-link" href="#old-third-party-vulnerabilities">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Now let&rsquo;s review some common attacks involving third party software. There are two big groups nowadays, one is exploiting XPC services and the other is injecting code into Electron based applications to bypass TCC.</p>
<h3 id="global-xpc-daemon-attacks">
  Global XPC Daemon Attacks
  <a class="heading-link" href="#global-xpc-daemon-attacks">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>One of the main issue with Mach type XPC connections is that by default anyone can talk to them if not sandboxed. As often times there are third party XPC services running as root on the system (they typically come in the form of Privileged Helper Tools) they are often abused.</p>
<p>Both myself and Wojcieh Regula talked and wrote about such attacks in the past, we both have a series of blogposts about the subject:</p>
<p><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part1/"  class="external-link" target="_blank" rel="noopener">CVE-2019-20057 - Secure coding XPC services - Part 1 - Why EvenBetterAuthorization is not enough?</a></p>
<p><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part2/"  class="external-link" target="_blank" rel="noopener">Secure coding XPC Services - Part 2 - Checking CS (CodeSigning) flags of the client</a></p>
<p><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part3/"  class="external-link" target="_blank" rel="noopener">CVE-2020-0984 - Secure coding XPC Services - Part 3 - Incorrect client verification</a></p>
<p><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part4/"  class="external-link" target="_blank" rel="noopener">CVE-2020-14978 - Secure coding XPC Services - Part 4 - Improved client authorization</a></p>
<p><a href="https://theevilbit.github.io/posts/secure_coding_xpc_part5/"  class="external-link" target="_blank" rel="noopener">CVE-2020-14977 - Secure coding XPC Services - Part 5 - PID reuse attacks</a></p>
<p><a href="https://wojciechregula.blog/post/learn-xpc-exploitation-part-1-broken-cryptography/"  class="external-link" target="_blank" rel="noopener">Learn XPC exploitation - Part 1: Broken cryptography</a></p>
<p><a href="https://wojciechregula.blog/post/learn-xpc-exploitation-part-2-say-no-to-the-pid/"  class="external-link" target="_blank" rel="noopener">Learn XPC exploitation - Part 2: Say no to the PID!</a></p>
<p><a href="https://wojciechregula.blog/post/learn-xpc-exploitation-part-3-code-injections/"  class="external-link" target="_blank" rel="noopener">Learn XPC exploitation - Part 3: Code injections</a></p>
<p>The main issue is that the XPC service must ensure that only the real XPC client can connect to it, otherwise others can abuse the service. Often time this is missed, as it&rsquo;s not trivial to do. Typically all of the following must be ensured:</p>
<ol>
<li>Code signing verification of the client must happen based on the Audit token</li>
<li>The client&rsquo;s code signature must ensure that it&rsquo;s signed by the official developer certificate</li>
<li>To avoid downgrade attacks the client&rsquo;s version must be checked</li>
<li>To avoid injection it must be verified that the client doesn&rsquo;t posses any insecure entitlements, like <code>disable-library-valdation</code>.</li>
</ol>
<p>One can use the <a href="https://developer.apple.com/documentation/foundation/nsxpcconnection/3943309-setcodesigningrequirement?language=objc"  class="external-link" target="_blank" rel="noopener">NSXPCConnection setCodeSigningRequirement:</a> method for this.</p>
<h3 id="embedded-xpc-service-attacks">
  Embedded XPC Service Attacks
  <a class="heading-link" href="#embedded-xpc-service-attacks">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>This type of attack tries to abuse XPC services, which are embedded in the application, and typically not available system wide. The way we can abuse it, is embedding the XPCService in our application bundle, thus it will become part of our process domain, and so we can call it. Alternatively we can use the <code>xpc_add_bundles_for_domain</code> function to add it to our bundle. This might be an intersting attack if the specified service has an entitlement we need.</p>
<p>There are not many attacks exploiting this behaviour, especially on third party software. There has been some attacks on Apple binaries in the past, like CVE-2020-9971 found by Zhipeng Huo, <a href="https://twitter.com/R3dF09"  class="external-link" target="_blank" rel="noopener">@R3dF09</a> and documented on <a href="https://xlab.tencent.com/en/2021/01/11/cve-2020-9971-abusing-xpc-service-to-elevate-privilege/"  class="external-link" target="_blank" rel="noopener">Tencent&rsquo;s blog</a> or CVE-2022-32826 found by Mickey Jin, <a href="https://twitter.com/patch1t"  class="external-link" target="_blank" rel="noopener">@patch1t</a> and documented on <a href="https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/"  class="external-link" target="_blank" rel="noopener">his blog</a>.</p>
<h3 id="electron-attacks">
  Electron Attacks
  <a class="heading-link" href="#electron-attacks">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The Electron framework became very popular as it allows developers to develop to multiple platforms at once, and all the source is HTML and JavaScript based, basically creating a web application as a thick client.</p>
<p>Many people wrote about such attack, here are two posts from Wojciech Regula and Adam Chester.</p>
<p><a href="https://wojciechregula.blog/post/abusing-electron-apps-to-bypass-macos-security-controls/"  class="external-link" target="_blank" rel="noopener">Abusing Electron apps to bypass macOS&rsquo; security controls</a></p>
<p><a href="https://blog.xpnsec.com/macos-injection-via-third-party-frameworks/"  class="external-link" target="_blank" rel="noopener">MacOS Injection via Third Party Frameworks</a></p>
<p>The basic idea is that using environment variables like <code>ELECTRON_RUN_AS_NODE</code> allows someone to interact with the application from the command line and run any JS code on behalf of the app, or using the <code>--remote-debugging-port</code> or the <code>--inspect</code> options someone can connect a debugger and again inject custom code.</p>
<p>This is often used to bypass TCC controls, as such apps often have camera, screen capture or similar exceptions.</p>
<h2 id="launch-and-environment-constraints">
  Launch and Environment Constraints
  <a class="heading-link" href="#launch-and-environment-constraints">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>With macOS Sonoma (or in fact at later versions of macOS Ventura) Apple introduced Launch Environment Constraints for third party apps. This means that now anyone can create self, parent and responsible constraints for their apps. Moreover we can also define a &ldquo;Library Load Constraint&rdquo;, which allows us defining developers IDs from which our app can load external libraries or bundles. Apple made very good documentation about how to use it, which can be found on their developer website, at <a href="https://developer.apple.com/documentation/security/applying_launch_environment_and_library_constraints?language=objc"  class="external-link" target="_blank" rel="noopener">Applying launch environment and library constraints</a> and <a href="https://developer.apple.com/documentation/security/defining_launch_environment_and_library_constraints?language=objc"  class="external-link" target="_blank" rel="noopener">Defining launch environment and library constraints</a>.</p>
<p>Applying it is rather simple. We make a new &ldquo;coderequirement&rdquo; property list file in our Xcode project for our target, and in the &ldquo;Build Settings&rdquo;, under &ldquo;Signing&rdquo;, we can apply it.</p>
<p><img src="https://theevilbit.github.io/images/posts/launch_constraints_deep_dive_00.png" alt="Xcode"></p>
<p>Now let&rsquo;s explore how these constraints (supposed to) mitigate our exploits.</p>
<h3 id="securing-xpc-connection">
  Securing XPC Connection
  <a class="heading-link" href="#securing-xpc-connection">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In Apple&rsquo;s <a href="https://developer.apple.com/videos/play/wwdc2023/10266/?time=326"  class="external-link" target="_blank" rel="noopener">Protect your Mac app with environment constraints</a> WWDC 2023 talk Robert says the following:</p>
<blockquote>
<p>Now let&rsquo;s walk through some process relationships and talk about how you can use launch constraints to secure them. First assume that MyDemo.app is your app. You can set a self constraint on my MyDemo.app to require that it launch as an application from Launch Services. When your app requests a connection to your XPC service, launchd spawns the XPC service and is the parent of that XPC service but your app is &ldquo;responsible&rdquo; for that XPC service. You could set a responsible process constraint on MyXPCDemo.xpc to indicate that only MyDemo.app should be responsible for it.</p></blockquote>
<p>This suggests that if we set our main app as the responsible for launching the XPC service makes the service secure. After talking to Thijs I realized that Apple talks about embedded XPC services here and not global daemon type services. In that case setting the responsible process to the main app can likely* mitigate attacks abusing these services.</p>
<blockquote>
<p>*Although I&rsquo;m not sure what happens if we add an XPC bundle to an app using xpc_add_bundles_for_domain, if that bundle is inside another app. Can it belong to two domains? If yes, can we connect to it if it&rsquo;s already launched? Lot&rsquo;s of questions to dig into.</p></blockquote>
<p>If we look at global XPC services the story is different. Responsible process for global XPC services might be meaningless really, as there can be many events starting it (monitored folders, etc&hellip;), thus at this point I&rsquo;m not sure if the following behaviour is intentional or not. At the time of this writing (Sonoma release) the responsible process for the daemon XPC service is the XPC service itself instead of the connecting client. (Submitted FB: FB13206884). Assuming for a second that it&rsquo;s a bug, we still won&rsquo;t be able to launch the XPC service in our attacker code, but if it&rsquo;s active already (maybe because it was invoked by the original app), there is nothing preventing us from connecting to it. So while setting the constraint might be a good idea, and would limit the attack timeframe, it doesn&rsquo;t solve the main issue, and our XPC service should still properly validate the connecting client. That is still the only way to secure it. Also as mentioned in the beginning it doesn&rsquo;t even work this way now.</p>
<h3 id="securing-electron-applications">
  Securing Electron Applications
  <a class="heading-link" href="#securing-electron-applications">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In Apple&rsquo;s <a href="https://developer.apple.com/videos/play/wwdc2023/10266/?time=326"  class="external-link" target="_blank" rel="noopener">Protect your Mac app with environment constraints</a> WWDC 2023 talk Robert says the following:</p>
<blockquote>
<p>Just like in real parent-child relationships, parent processes have a huge amount of influence over how a child behaves. On macOS, the power to posix_spawn another process gives the parent the ability to control nearly all input to the child. The parent process can also limit the child’s access to system resources. This level of control can cause the child to load unexpected code, to run unexpected features, or to behave in ways that make the process more vulnerable to attack.</p></blockquote>
<p>So the idea would be to limit the parent to control the client. We can eliminate the spawn issue with setting <code>launch-type</code> to &ldquo;3&rdquo;, which means that the application has to be opened by LaunchService, with the user clicking on the app. However the <code>open</code> command has the same impact, which allows us to control arguments or environment variables, or we can use the Launch Services API as follows.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objective-c" data-lang="objective-c"><span style="display:flex;"><span>NSWorkspaceOpenConfiguration <span style="color:#555">*</span>conf <span style="color:#555">=</span> [NSWorkspaceOpenConfiguration configuration];
</span></span><span style="display:flex;"><span>conf.environment <span style="color:#555">=</span> @{
</span></span><span style="display:flex;"><span>    <span style="color:#c30">@&#34;ELECTRON_RUN_AS_NODE&#34;</span><span style="color:#555">:</span> <span style="color:#c30">@&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>[[NSWorkspace sharedWorkspace] <span style="color:#99f">openURL</span>:[NSURL <span style="color:#99f">fileURLWithPath</span>:<span style="color:#c30">@&#34;/Applications/Electron.app&#34;</span>]
</span></span><span style="display:flex;"><span>                               <span style="color:#99f">configuration</span>:conf
</span></span><span style="display:flex;"><span>                               <span style="color:#99f">completionHandler</span>:<span style="color:#366">nil</span>];
</span></span></code></pre></div><p>Although it&rsquo;s not the same as <code>posix_spawn</code> and it&rsquo;s somewhat more limited, we can still control crucial parts (arguments and environmental variables) of the application. So our Electron app issue is not quite solved yet.</p>
<h2 id="final-thoughts">
  Final thoughts
  <a class="heading-link" href="#final-thoughts">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Launch Constraints introduced in macOS Ventura effectively mitigate many logic attacks that were found before, and makes the attacker&rsquo;s life much harder. I think that it was a huge thing and a very good engineering and design success.</p>
<p>Launch Constraints for third party apps, while useful, and does limit the attack surface, it doesn&rsquo;t solve it completely and it&rsquo;s simply not an answer to many of the common attacks. It can easily provide a false sense of security. There are still ways around it, and attackers will still be able to exploit logic vulnerabilities, but in somewhat more limited fashion. It&rsquo;s a step in a good direction, but we are not there yet. It&rsquo;s a good idea to start implementing this, as it will be more common, and will become more relevant as time goes on. I hope that Apple will tune and add further restrictions to the constraints available for third parties.</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2019 -
    
    2025
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
