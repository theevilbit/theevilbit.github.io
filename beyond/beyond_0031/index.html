<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Csaba Fitzl">
    
    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Beyond the good ol&#39; LaunchAgents - 31 - BSM audit framework"/>
<meta name="twitter:description" content="This is part 31 in the series of &ldquo;Beyond the good ol&rsquo; LaunchAgents&rdquo;, where I try to collect various persistence techniques for macOS. For more background check the introduction.
macOS implements the OpenBSM audit framework created by McAfee, which allows someone to audit system events, like login, file access, etc… This has been part of the system for very long time. Auditing has several components, the main one being the kernel, which handles all the events."/>

    <meta property="og:title" content="Beyond the good ol&#39; LaunchAgents - 31 - BSM audit framework" />
<meta property="og:description" content="This is part 31 in the series of &ldquo;Beyond the good ol&rsquo; LaunchAgents&rdquo;, where I try to collect various persistence techniques for macOS. For more background check the introduction.
macOS implements the OpenBSM audit framework created by McAfee, which allows someone to audit system events, like login, file access, etc… This has been part of the system for very long time. Auditing has several components, the main one being the kernel, which handles all the events." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theevilbit.github.io/beyond/beyond_0031/" /><meta property="article:section" content="beyond" />
<meta property="article:published_time" content="2023-05-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-05-26T00:00:00+00:00" />


    
      <base href="https://theevilbit.github.io/beyond/beyond_0031/">
    
    <title>
  Beyond the good ol&#39; LaunchAgents - 31 - BSM audit framework · theevilbit blog
</title>

    
      <link rel="canonical" href="https://theevilbit.github.io/beyond/beyond_0031/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    
    
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.119.0">
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/shield/">Shield.app</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/tags/">Tags</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://theevilbit.github.io/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Beyond the good ol&#39; LaunchAgents - 31 - BSM audit framework</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2023-05-26T00:00:00Z'>
                May 26, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              2 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://theevilbit.github.io/categories/persistence/">persistence</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/categories/beyond/">beyond</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://theevilbit.github.io/tags/macos/">macos</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/persistence/">persistence</a>
      <span class="separator">•</span>
    <a href="https://theevilbit.github.io/tags/beyond/">beyond</a></div>

        </div>
      </header>

      <div>
        <blockquote>
<p>This is part 31 in the series of &ldquo;Beyond the good ol&rsquo; LaunchAgents&rdquo;, where I try to collect various persistence techniques for macOS. For more background check the <a href="https://theevilbit.github.io/beyond/beyond_intro/">introduction</a>.</p>
</blockquote>
<p>macOS implements the OpenBSM audit framework created by McAfee, which allows someone to audit system events, like login, file access, etc… This has been part of the system for very long time. Auditing has several components, the main one being the kernel, which handles all the events. The main user mode process is <code>auditd</code>, which is mainly responsible for logging. It’s a huge framework, detailed very well by Jonathan Levin in his <code>*OS Internal Part 3</code> book. I suggest reading that part, but you can also find some information here:</p>
<p><a href="https://crucialsecurity.wordpress.com/2012/05/17/reading-mac-bsm-audit-logs-2/">Reading Mac BSM Audit Logs</a></p>
<p><a href="https://www.scip.ch/en/?labs.20150108">Audit in a OS X System</a></p>
<p><code>auditd</code> can be configured via various files, which are located at <code>/etc/security/</code>. The logs can be found under <code>/private/var/audit/</code>, but they are not important for us now.</p>
<pre tabindex="0"><code>max:~ root# ls -l /etc/security/
total 48
-r--r--r--  1 root  wheel    652 May 13 00:29 audit_class
-r--------  1 root  wheel    358 May 13 00:29 audit_control
-r--r--r--  1 root  wheel  26649 May 13 00:29 audit_event
-r--------  1 root  wheel     77 May 13 00:29 audit_user
-r-xr-xr-x  1 root  wheel   1326 May 13 00:29 audit_warn
</code></pre><p><code>audit_control</code> is the main configuration file, by default it configures <code>auditd</code> to log login and authentication events. The file which is interesting for us is <code>audit_warn</code>.  It’s a shell script, that is executed when an audit warning occurs.</p>
<pre tabindex="0"><code>max:~ root# cat /etc/security/audit_warn 
#!/bin/sh
#
...
</code></pre><p>As root, we can edit this file, let’s add the following.</p>
<pre tabindex="0"><code>touch /tmp/createdbyauditd.txt
</code></pre><p>We can manually trigger a warning by forcing a log rotation by running the <code>sudo audit -n</code> command.</p>
<p>Then our file will be created.</p>
<h2 id="detection-consideration">Detection Consideration</h2>
<p>The most trivial way to detect this persistence is monitoring file modification of <code>audit_warn</code>.</p>
<p>Additionally the process tree when our command is executed will look like the following:</p>
<pre tabindex="0"><code>auditd
--&gt;/bin/sh
----&gt;touch (or any command specified in the script)
</code></pre><p>Note, that the main interpreter can be also changed from <code>#!/bin/sh</code> to anything else, so other child processes can be suspicious as well.</p>

      </div>

      <footer>
        


        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
     © 2023
    
       · 
      Blog created by <a href="https://twitter.com/theevilbit">@theevilbit</a>.
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-151008930-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>

</html>
