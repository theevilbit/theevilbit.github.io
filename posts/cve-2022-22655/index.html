<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  CVE-2022-22655 - TCC - Location Services Bypass · theevilbit blog
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Csaba Fitzl">
<meta name="description" content="This is a quick blogpost about a vulnerability I covered in our Black Hat Europe 2022 talk with Wojciech Regula.
In contrary to what people would expect, clients which can access location services are not maintained in one of the TCC databased, but in a separate location, and it&rsquo;s maintained by locationd. This has been also recently covered by Howard Oakley, in his Privacy: what TCC does and doesn’t blogpost.">
<meta name="keywords" content="">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2022-22655 - TCC - Location Services Bypass">
  <meta name="twitter:description" content="This is a quick blogpost about a vulnerability I covered in our Black Hat Europe 2022 talk with Wojciech Regula.
In contrary to what people would expect, clients which can access location services are not maintained in one of the TCC databased, but in a separate location, and it’s maintained by locationd. This has been also recently covered by Howard Oakley, in his Privacy: what TCC does and doesn’t blogpost.">

<meta property="og:url" content="https://theevilbit.github.io/posts/cve-2022-22655/">
  <meta property="og:site_name" content="theevilbit blog">
  <meta property="og:title" content="CVE-2022-22655 - TCC - Location Services Bypass">
  <meta property="og:description" content="This is a quick blogpost about a vulnerability I covered in our Black Hat Europe 2022 talk with Wojciech Regula.
In contrary to what people would expect, clients which can access location services are not maintained in one of the TCC databased, but in a separate location, and it’s maintained by locationd. This has been also recently covered by Howard Oakley, in his Privacy: what TCC does and doesn’t blogpost.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-02-13T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-02-13T00:00:00+00:00">
    <meta property="article:tag" content="Macos">
    <meta property="article:tag" content="Tcc">
    <meta property="article:tag" content="Vulnerability">
    <meta property="article:tag" content="Cve">




<link rel="canonical" href="https://theevilbit.github.io/posts/cve-2022-22655/">


<link rel="preload" href="https://theevilbit.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://theevilbit.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://theevilbit.github.io/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />








 




<link rel="icon" type="image/svg+xml" href="https://theevilbit.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://theevilbit.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://theevilbit.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://theevilbit.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://theevilbit.github.io/site.webmanifest">
<link rel="mask-icon" href="https://theevilbit.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://theevilbit.github.io/">
      theevilbit blog
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/talks/">Talks and Workshops</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/shield/">Shield.app</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/beyond/">Beyond good ol&#39; LaunchAgents</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/tags/">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://theevilbit.github.io/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://theevilbit.github.io/posts/cve-2022-22655/">
              CVE-2022-22655 - TCC - Location Services Bypass
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-02-13T00:00:00Z">
                February 13, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              2-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://theevilbit.github.io/categories/blog/">BLOG</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/macos/">Macos</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/tcc/">Tcc</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/vulnerability/">Vulnerability</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://theevilbit.github.io/tags/cve/">Cve</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>This is a quick blogpost about a vulnerability I covered in our <a href="https://www.blackhat.com/eu-22/briefings/schedule/index.html#knockout-win-against-tcc----new-ways-to-bypass-your-macos-privacy-mechanisms-29272"  class="external-link" target="_blank" rel="noopener">Black Hat Europe 2022 talk</a> with <a href="https://twitter.com/_r3ggi"  class="external-link" target="_blank" rel="noopener">Wojciech Regula</a>.</p>
<p>In contrary to what people would expect, clients which can access location services are not maintained in one of the TCC databased, but in a separate location, and it&rsquo;s maintained by locationd. This has been also recently covered by Howard Oakley, in his <a href="https://eclecticlight.co/2023/02/10/privacy-what-tcc-does-and-doesnt/"  class="external-link" target="_blank" rel="noopener">Privacy: what TCC does and doesn’t</a> blogpost.</p>
<p>TCC&rsquo;s location services allowed client list is located inside <code>/var/db/locationd/clients.plist</code>. This file is protected by the Sandbox/TCC, thus we can&rsquo;t modify it, and add new client, even if we have root privileges.</p>
<p>However the <code>/var/db/locationd/</code> directory is not protected from mounting. We can create a custom disk image, with a custom client list, and mount it over the directory. After restarting locationd the new list will take effect. This allows us to bypass locationd TCC protection.</p>
<p>To demonstrate access I used <a href="https://twitter.com/slyd0g"  class="external-link" target="_blank" rel="noopener">Justin Bui&rsquo;s</a>  <a href="https://github.com/slyd0g/SwiftLiverpool"  class="external-link" target="_blank" rel="noopener">SwiftLiverpool</a> tool.</p>
<p>The POC, will drop the compiled binary <code>swiftliverpool</code>and grant it access in a custom PLIST file. Then it will create a disk image and mount it over the specified directory. It must be run as root, because only then we can mount over the directory.</p>
<p>In the custom PLIST file the important entry is the following, this is what grants the executable access to location services.</p>
<pre tabindex="0"><code>	&lt;key&gt;com.apple.locationd.executable-&lt;/key&gt;
	&lt;dict/&gt;
	&lt;key&gt;com.apple.locationd.executable-/private/tmp/swiftliverpool&lt;/key&gt;
	&lt;dict&gt;
		&lt;key&gt;Authorized&lt;/key&gt;
		&lt;true/&gt;
		&lt;key&gt;BundleId&lt;/key&gt;
		&lt;string&gt;com.apple.locationd.executable-/private/tmp/swiftliverpool&lt;/string&gt;
		&lt;key&gt;Executable&lt;/key&gt;
		&lt;string&gt;/private/tmp/swiftliverpool&lt;/string&gt;
		&lt;key&gt;Registered&lt;/key&gt;
		&lt;string&gt;/private/tmp/swiftliverpool&lt;/string&gt;
		&lt;key&gt;Requirement&lt;/key&gt;
		&lt;string&gt;cdhash H&#34;39fed059b420f6077761625e2f87b583eae49e88&#34;&lt;/string&gt;
	&lt;/dict&gt;
</code></pre><p>POC:</p>
<p><a href="https://gist.github.com/theevilbit/20b73350b2df757c989949286fe6ca27"  class="external-link" target="_blank" rel="noopener">CVE-2022-22655 - macOS Location Services Bypass · GitHub</a></p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Csaba Fitzl 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://theevilbit.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
